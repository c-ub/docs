<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/img/1.jpg"><title>第33节 软件部署实战（中）：IAM 系统生产环境部署实战 | 你好</title><meta name="description" content="链学社致力于打造出区块链去中心化的学习平台">
    <link rel="modulepreload" href="/assets/app.df174e55.js"><link rel="modulepreload" href="/assets/33.html.28fbd3f1.js"><link rel="modulepreload" href="/assets/33.html.e8f65480.js"><link rel="prefetch" href="/assets/index.html.25a7a27a.js"><link rel="prefetch" href="/assets/index.html.a36ccd78.js"><link rel="prefetch" href="/assets/1.html.461afd80.js"><link rel="prefetch" href="/assets/10.html.4f13ef50.js"><link rel="prefetch" href="/assets/11.html.f09f95c3.js"><link rel="prefetch" href="/assets/12.html.a67acf21.js"><link rel="prefetch" href="/assets/13.html.0420c962.js"><link rel="prefetch" href="/assets/14.html.b0b5806d.js"><link rel="prefetch" href="/assets/15.html.06f1cde4.js"><link rel="prefetch" href="/assets/16.html.2c2a072d.js"><link rel="prefetch" href="/assets/17.html.be392cda.js"><link rel="prefetch" href="/assets/18.html.8b213912.js"><link rel="prefetch" href="/assets/19.html.1dca5398.js"><link rel="prefetch" href="/assets/2.html.ad5997eb.js"><link rel="prefetch" href="/assets/20.html.1bd75582.js"><link rel="prefetch" href="/assets/21.html.9cb3d476.js"><link rel="prefetch" href="/assets/22.html.4c43a0a4.js"><link rel="prefetch" href="/assets/23.html.0341a155.js"><link rel="prefetch" href="/assets/24.html.f74332a7.js"><link rel="prefetch" href="/assets/25.html.32aca821.js"><link rel="prefetch" href="/assets/26.html.cc5ca1a2.js"><link rel="prefetch" href="/assets/27.html.09791ec4.js"><link rel="prefetch" href="/assets/28.html.4aa1094d.js"><link rel="prefetch" href="/assets/29.html.165cddd8.js"><link rel="prefetch" href="/assets/3.html.427f6088.js"><link rel="prefetch" href="/assets/30.html.5c492d35.js"><link rel="prefetch" href="/assets/31.html.b4a50d0d.js"><link rel="prefetch" href="/assets/32.html.3a8a6f2f.js"><link rel="prefetch" href="/assets/34.html.580498c1.js"><link rel="prefetch" href="/assets/35.html.2da63961.js"><link rel="prefetch" href="/assets/36.html.d8049f92.js"><link rel="prefetch" href="/assets/37.html.0dbda88b.js"><link rel="prefetch" href="/assets/38.html.d8605d22.js"><link rel="prefetch" href="/assets/39.html.84a2efa8.js"><link rel="prefetch" href="/assets/4.html.3a1de71e.js"><link rel="prefetch" href="/assets/40.html.532610aa.js"><link rel="prefetch" href="/assets/41.html.172bb15b.js"><link rel="prefetch" href="/assets/42.html.e71d9386.js"><link rel="prefetch" href="/assets/43.html.99ab5c93.js"><link rel="prefetch" href="/assets/44.html.ed92b7f3.js"><link rel="prefetch" href="/assets/45.html.2fa65b5e.js"><link rel="prefetch" href="/assets/46.html.f0dd66d1.js"><link rel="prefetch" href="/assets/47.html.4c6f6d3d.js"><link rel="prefetch" href="/assets/48.html.3cdc0986.js"><link rel="prefetch" href="/assets/49.html.936da8ed.js"><link rel="prefetch" href="/assets/5.html.0f758775.js"><link rel="prefetch" href="/assets/50.html.e8114b3c.js"><link rel="prefetch" href="/assets/51.html.8dba5f2d.js"><link rel="prefetch" href="/assets/52.html.4e857563.js"><link rel="prefetch" href="/assets/53.html.c513f2cd.js"><link rel="prefetch" href="/assets/54.html.cc298904.js"><link rel="prefetch" href="/assets/55.html.dd8403bb.js"><link rel="prefetch" href="/assets/56.html.a6fa9c2b.js"><link rel="prefetch" href="/assets/57.html.8d9ca11b.js"><link rel="prefetch" href="/assets/58.html.d2d6137f.js"><link rel="prefetch" href="/assets/59.html.64bfc6aa.js"><link rel="prefetch" href="/assets/6.html.4f7ba7c5.js"><link rel="prefetch" href="/assets/60.html.9d280a7e.js"><link rel="prefetch" href="/assets/61.html.93e3d982.js"><link rel="prefetch" href="/assets/62.html.7c25e781.js"><link rel="prefetch" href="/assets/63.html.c7c354a1.js"><link rel="prefetch" href="/assets/64.html.0d112a0c.js"><link rel="prefetch" href="/assets/65.html.8b9a0ae3.js"><link rel="prefetch" href="/assets/66.html.60a5c98f.js"><link rel="prefetch" href="/assets/67.html.65a79637.js"><link rel="prefetch" href="/assets/68.html.9c8743e4.js"><link rel="prefetch" href="/assets/69.html.f262d742.js"><link rel="prefetch" href="/assets/7.html.658a2ddf.js"><link rel="prefetch" href="/assets/70.html.a13f0df5.js"><link rel="prefetch" href="/assets/71.html.e5232458.js"><link rel="prefetch" href="/assets/72.html.55331bc1.js"><link rel="prefetch" href="/assets/73.html.cf7ccd53.js"><link rel="prefetch" href="/assets/74.html.48daf8af.js"><link rel="prefetch" href="/assets/75.html.4a47e12f.js"><link rel="prefetch" href="/assets/76.html.72c869e6.js"><link rel="prefetch" href="/assets/77.html.a9d9ff7d.js"><link rel="prefetch" href="/assets/78.html.0feb5171.js"><link rel="prefetch" href="/assets/79.html.7a6a2cc4.js"><link rel="prefetch" href="/assets/8.html.8d69e3db.js"><link rel="prefetch" href="/assets/80.html.88f5c71d.js"><link rel="prefetch" href="/assets/81.html.3ec4d333.js"><link rel="prefetch" href="/assets/82.html.70be117a.js"><link rel="prefetch" href="/assets/83.html.07de8b59.js"><link rel="prefetch" href="/assets/84.html.37bf069c.js"><link rel="prefetch" href="/assets/85.html.d88064c7.js"><link rel="prefetch" href="/assets/86.html.2ea4f0ba.js"><link rel="prefetch" href="/assets/87.html.fcd098dc.js"><link rel="prefetch" href="/assets/88.html.455f17e4.js"><link rel="prefetch" href="/assets/89.html.94c12162.js"><link rel="prefetch" href="/assets/9.html.3619251b.js"><link rel="prefetch" href="/assets/90.html.47f84836.js"><link rel="prefetch" href="/assets/91.html.f355cbb5.js"><link rel="prefetch" href="/assets/92.html.4b6d0a6b.js"><link rel="prefetch" href="/assets/93.html.8c027538.js"><link rel="prefetch" href="/assets/94.html.e175d373.js"><link rel="prefetch" href="/assets/95.html.58fba167.js"><link rel="prefetch" href="/assets/96.html.cfc1673c.js"><link rel="prefetch" href="/assets/97.html.71615abb.js"><link rel="prefetch" href="/assets/98.html.817dd510.js"><link rel="prefetch" href="/assets/99.html.41ed9550.js"><link rel="prefetch" href="/assets/404.html.c3e557d0.js"><link rel="prefetch" href="/assets/index.html.5078607b.js"><link rel="prefetch" href="/assets/index.html.238b898d.js"><link rel="prefetch" href="/assets/1.html.68bd8bc7.js"><link rel="prefetch" href="/assets/10.html.6703ed8a.js"><link rel="prefetch" href="/assets/11.html.087bca0d.js"><link rel="prefetch" href="/assets/12.html.54a22c52.js"><link rel="prefetch" href="/assets/13.html.4bb58d38.js"><link rel="prefetch" href="/assets/14.html.503f448c.js"><link rel="prefetch" href="/assets/15.html.8574c656.js"><link rel="prefetch" href="/assets/16.html.a1bd17bb.js"><link rel="prefetch" href="/assets/17.html.1efae1db.js"><link rel="prefetch" href="/assets/18.html.2f97fa21.js"><link rel="prefetch" href="/assets/19.html.3e0f7c64.js"><link rel="prefetch" href="/assets/2.html.58eeb18b.js"><link rel="prefetch" href="/assets/20.html.b8b46978.js"><link rel="prefetch" href="/assets/21.html.70c7de34.js"><link rel="prefetch" href="/assets/22.html.aa7bd96c.js"><link rel="prefetch" href="/assets/23.html.ad35e20a.js"><link rel="prefetch" href="/assets/24.html.0963e8cd.js"><link rel="prefetch" href="/assets/25.html.df593c5c.js"><link rel="prefetch" href="/assets/26.html.21e72cc8.js"><link rel="prefetch" href="/assets/27.html.abbc553f.js"><link rel="prefetch" href="/assets/28.html.eefcc4fe.js"><link rel="prefetch" href="/assets/29.html.b3a7277c.js"><link rel="prefetch" href="/assets/3.html.ece505c8.js"><link rel="prefetch" href="/assets/30.html.4139f101.js"><link rel="prefetch" href="/assets/31.html.78bdceca.js"><link rel="prefetch" href="/assets/32.html.b715024d.js"><link rel="prefetch" href="/assets/34.html.4a53b877.js"><link rel="prefetch" href="/assets/35.html.3714035c.js"><link rel="prefetch" href="/assets/36.html.6593b1dd.js"><link rel="prefetch" href="/assets/37.html.1030763e.js"><link rel="prefetch" href="/assets/38.html.564c84b7.js"><link rel="prefetch" href="/assets/39.html.9e6b9426.js"><link rel="prefetch" href="/assets/4.html.0cced93c.js"><link rel="prefetch" href="/assets/40.html.baa78d6a.js"><link rel="prefetch" href="/assets/41.html.ce225826.js"><link rel="prefetch" href="/assets/42.html.6ef135a0.js"><link rel="prefetch" href="/assets/43.html.235f7002.js"><link rel="prefetch" href="/assets/44.html.d18c82d2.js"><link rel="prefetch" href="/assets/45.html.2f2c2f8c.js"><link rel="prefetch" href="/assets/46.html.45e49c32.js"><link rel="prefetch" href="/assets/47.html.2071b30e.js"><link rel="prefetch" href="/assets/48.html.d1a08b55.js"><link rel="prefetch" href="/assets/49.html.5ebe1da7.js"><link rel="prefetch" href="/assets/5.html.92b708de.js"><link rel="prefetch" href="/assets/50.html.3a175eb7.js"><link rel="prefetch" href="/assets/51.html.d27f00bb.js"><link rel="prefetch" href="/assets/52.html.8b437f64.js"><link rel="prefetch" href="/assets/53.html.d913eb66.js"><link rel="prefetch" href="/assets/54.html.8271495e.js"><link rel="prefetch" href="/assets/55.html.bdc49926.js"><link rel="prefetch" href="/assets/56.html.3dc8abe7.js"><link rel="prefetch" href="/assets/57.html.7d8f4d4c.js"><link rel="prefetch" href="/assets/58.html.2e807b03.js"><link rel="prefetch" href="/assets/59.html.83549612.js"><link rel="prefetch" href="/assets/6.html.1d2cb545.js"><link rel="prefetch" href="/assets/60.html.fb941722.js"><link rel="prefetch" href="/assets/61.html.10d42607.js"><link rel="prefetch" href="/assets/62.html.63d223ec.js"><link rel="prefetch" href="/assets/63.html.afb0566c.js"><link rel="prefetch" href="/assets/64.html.88e70600.js"><link rel="prefetch" href="/assets/65.html.6ee1b8fd.js"><link rel="prefetch" href="/assets/66.html.ab8f36c8.js"><link rel="prefetch" href="/assets/67.html.bb9f4dde.js"><link rel="prefetch" href="/assets/68.html.081ecec1.js"><link rel="prefetch" href="/assets/69.html.94b26ac8.js"><link rel="prefetch" href="/assets/7.html.cef2e333.js"><link rel="prefetch" href="/assets/70.html.21112954.js"><link rel="prefetch" href="/assets/71.html.b6760737.js"><link rel="prefetch" href="/assets/72.html.46e6db4d.js"><link rel="prefetch" href="/assets/73.html.872f9067.js"><link rel="prefetch" href="/assets/74.html.e2fad9a6.js"><link rel="prefetch" href="/assets/75.html.41837637.js"><link rel="prefetch" href="/assets/76.html.bd895802.js"><link rel="prefetch" href="/assets/77.html.d16746b1.js"><link rel="prefetch" href="/assets/78.html.7573af34.js"><link rel="prefetch" href="/assets/79.html.4ba1b576.js"><link rel="prefetch" href="/assets/8.html.ffbe5f0d.js"><link rel="prefetch" href="/assets/80.html.964f8ea4.js"><link rel="prefetch" href="/assets/81.html.f0f8c8ea.js"><link rel="prefetch" href="/assets/82.html.42775672.js"><link rel="prefetch" href="/assets/83.html.dca364d9.js"><link rel="prefetch" href="/assets/84.html.03706d5c.js"><link rel="prefetch" href="/assets/85.html.32142600.js"><link rel="prefetch" href="/assets/86.html.bc85e920.js"><link rel="prefetch" href="/assets/87.html.406eea6e.js"><link rel="prefetch" href="/assets/88.html.2fa5b983.js"><link rel="prefetch" href="/assets/89.html.ac21d36d.js"><link rel="prefetch" href="/assets/9.html.b60314dd.js"><link rel="prefetch" href="/assets/90.html.ccb3b75c.js"><link rel="prefetch" href="/assets/91.html.42ecc4c5.js"><link rel="prefetch" href="/assets/92.html.50a515c1.js"><link rel="prefetch" href="/assets/93.html.b5657afc.js"><link rel="prefetch" href="/assets/94.html.c185d24f.js"><link rel="prefetch" href="/assets/95.html.ad73eb9e.js"><link rel="prefetch" href="/assets/96.html.cb8ab449.js"><link rel="prefetch" href="/assets/97.html.06281eee.js"><link rel="prefetch" href="/assets/98.html.23720464.js"><link rel="prefetch" href="/assets/99.html.ae6e8b44.js"><link rel="prefetch" href="/assets/404.html.e3b93612.js">
    <link rel="stylesheet" href="/assets/style.03848e77.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">你好</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/3293172751/cs-awesome-Block_Chain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/3293172751/cs-awesome-Block_Chain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="🏠回到主页"><!--[--><!--]--> 🏠回到主页 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">🔥 Go语言基础篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/iam/projects/1.html" class="sidebar-item" aria-label="第1节 IAM项目介绍"><!--[--><!--]--> 第1节 IAM项目介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/2.html" class="sidebar-item" aria-label="第2节 IAM项目部署"><!--[--><!--]--> 第2节 IAM项目部署 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/3.html" class="sidebar-item" aria-label="第3节 设计规范"><!--[--><!--]--> 第3节 设计规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/4.html" class="sidebar-item" aria-label="第4节 Go语言项目设计"><!--[--><!--]--> 第4节 Go语言项目设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/5.html" class="sidebar-item" aria-label="第5节 设计并写出优雅的Go语言项目"><!--[--><!--]--> 第5节 设计并写出优雅的Go语言项目 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/6.html" class="sidebar-item" aria-label="第6节 API 风格设计"><!--[--><!--]--> 第6节 API 风格设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/7.html" class="sidebar-item" aria-label="第7节 高质量的Makefile"><!--[--><!--]--> 第7节 高质量的Makefile <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/8.html" class="sidebar-item" aria-label="第8节 IAM 项目如何进行研发流程管理"><!--[--><!--]--> 第8节 IAM 项目如何进行研发流程管理 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/9.html" class="sidebar-item" aria-label="第9节 静态代码检测"><!--[--><!--]--> 第9节 静态代码检测 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/10.html" class="sidebar-item" aria-label="第10节 如何生成 Swagger API 文档"><!--[--><!--]--> 第10节 如何生成 Swagger API 文档 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/11.html" class="sidebar-item" aria-label="第11节 设计一套科学的错误码"><!--[--><!--]--> 第11节 设计一套科学的错误码 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/12.html" class="sidebar-item" aria-label="第12节 记录和设计日志"><!--[--><!--]--> 第12节 记录和设计日志 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/13.html" class="sidebar-item" aria-label="第13节  从 0 编写一个日志包"><!--[--><!--]--> 第13节  从 0 编写一个日志包 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/14.html" class="sidebar-item" aria-label="第14节 Pflag、Viper、Cobra 核心功能介绍"><!--[--><!--]--> 第14节 Pflag、Viper、Cobra 核心功能介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/15.html" class="sidebar-item" aria-label="第15节 如何构建一个优秀的企业应用框架"><!--[--><!--]--> 第15节 如何构建一个优秀的企业应用框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/16.html" class="sidebar-item" aria-label="第16节 Gin 框架"><!--[--><!--]--> 第16节 Gin 框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/17.html" class="sidebar-item" aria-label="第17节 认证机制：应用程序如何进行访问认证？"><!--[--><!--]--> 第17节 认证机制：应用程序如何进行访问认证？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/18.html" class="sidebar-item" aria-label="第18节 IAM 项目认证"><!--[--><!--]--> 第18节 IAM 项目认证 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/19.html" class="sidebar-item" aria-label="第19节 权限模型：5大权限模型是如何进行资源授权的？"><!--[--><!--]--> 第19节 权限模型：5大权限模型是如何进行资源授权的？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/20.html" class="sidebar-item" aria-label="第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建"><!--[--><!--]--> 第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/21.html" class="sidebar-item" aria-label="第21节 控制流（下）：iam-apiserver服务核心功能实现讲解"><!--[--><!--]--> 第21节 控制流（下）：iam-apiserver服务核心功能实现讲解 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/22.html" class="sidebar-item" aria-label="第22节 ORM：CURD 神器 GORM 包介绍及实战"><!--[--><!--]--> 第22节 ORM：CURD 神器 GORM 包介绍及实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/23.html" class="sidebar-item" aria-label="第23节 数据流：通过iam-authz-server设计，看数据流服务的设计"><!--[--><!--]--> 第23节 数据流：通过iam-authz-server设计，看数据流服务的设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/24.html" class="sidebar-item" aria-label="第24节 数据处理：如何高效处理应用程序产生的数据？"><!--[--><!--]--> 第24节 数据处理：如何高效处理应用程序产生的数据？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/25.html" class="sidebar-item" aria-label="第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？"><!--[--><!--]--> 第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/26.html" class="sidebar-item" aria-label="第26节  SDK 设计（下）：IAM项目Go SDK设计和实现"><!--[--><!--]--> 第26节  SDK 设计（下）：IAM项目Go SDK设计和实现 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/27.html" class="sidebar-item" aria-label="第27节 效率神器：如何设计和实现一个命令行客户端工具？"><!--[--><!--]--> 第27节 效率神器：如何设计和实现一个命令行客户端工具？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/28.html" class="sidebar-item" aria-label="第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？"><!--[--><!--]--> 第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/29.html" class="sidebar-item" aria-label="第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍"><!--[--><!--]--> 第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/30.html" class="sidebar-item" aria-label="第30节 性能分析（上）：如何分析 Go 语言代码的性能？"><!--[--><!--]--> 第30节 性能分析（上）：如何分析 Go 语言代码的性能？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/31.html" class="sidebar-item" aria-label="第31节 性能分析（下）：API Server性能测试和调优实战"><!--[--><!--]--> 第31节 性能分析（下）：API Server性能测试和调优实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/32.html" class="sidebar-item" aria-label="第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍"><!--[--><!--]--> 第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第33节 软件部署实战（中）：IAM 系统生产环境部署实战"><!--[--><!--]--> 第33节 软件部署实战（中）：IAM 系统生产环境部署实战 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/iam/projects/33.html#部署iam应用" class="router-link-active router-link-exact-active sidebar-item" aria-label="部署IAM应用"><!--[--><!--]--> 部署IAM应用 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#配置nginx作为反向代理" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置Nginx作为反向代理"><!--[--><!--]--> 配置Nginx作为反向代理 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#配置nginx作为负载均衡" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置Nginx作为负载均衡"><!--[--><!--]--> 配置Nginx作为负载均衡 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#配置keepalived" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置Keepalived"><!--[--><!--]--> 配置Keepalived <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#课后练习" class="router-link-active router-link-exact-active sidebar-item" aria-label="课后练习"><!--[--><!--]--> 课后练习 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/33.html#end-链接" class="router-link-active router-link-exact-active sidebar-item" aria-label="END 链接"><!--[--><!--]--> END 链接 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/iam/projects/34.html" class="sidebar-item" aria-label="第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战"><!--[--><!--]--> 第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/35.html" class="sidebar-item" aria-label="第35节 技术演进（上）：虚拟化技术演进之路"><!--[--><!--]--> 第35节 技术演进（上）：虚拟化技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/36.html" class="sidebar-item" aria-label="第36节 技术演进（下）：软件架构和应用生命周期技术演进之路"><!--[--><!--]--> 第36节 技术演进（下）：软件架构和应用生命周期技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/37.html" class="sidebar-item" aria-label="第37节 基于Kubernetes的云原生架构设计"><!--[--><!--]--> 第37节 基于Kubernetes的云原生架构设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/38.html" class="sidebar-item" aria-label="第38节 如何制作Docker镜像？"><!--[--><!--]--> 第38节 如何制作Docker镜像？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/39.html" class="sidebar-item" aria-label="第39节 如何编写Kubernetes资源定义文件？"><!--[--><!--]--> 第39节 如何编写Kubernetes资源定义文件？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/40.html" class="sidebar-item" aria-label="第40节 IAM 容器化部署实战"><!--[--><!--]--> 第40节 IAM 容器化部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/41.html" class="sidebar-item" aria-label="第41节 服务编排（上）：Helm服务编排基础知识"><!--[--><!--]--> 第41节 服务编排（上）：Helm服务编排基础知识 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/42.html" class="sidebar-item" aria-label="第42节 服务编排（下）：基于Helm的服务编排部署实战"><!--[--><!--]--> 第42节 服务编排（下）：基于Helm的服务编排部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/43.html" class="sidebar-item" aria-label="第43节 基于 GitHub Actions 的 CI 实战"><!--[--><!--]--> 第43节 基于 GitHub Actions 的 CI 实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/44.html" class="sidebar-item" aria-label="第44节 可直接套用的 Go 编码规范"><!--[--><!--]--> 第44节 可直接套用的 Go 编码规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/45.html" class="sidebar-item" aria-label="第45节 Go Modules依赖包管理全讲"><!--[--><!--]--> 第45节 Go Modules依赖包管理全讲 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/46.html" class="sidebar-item" aria-label="第46节 IAM排障指南"><!--[--><!--]--> 第46节 IAM排障指南 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/47.html" class="sidebar-item" aria-label="第47节"><!--[--><!--]--> 第47节 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/48.html" class="sidebar-item" aria-label="第48节 分布式系统设计"><!--[--><!--]--> 第48节 分布式系统设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/49.html" class="sidebar-item" aria-label="第49节 如何从小白进阶成 Go 语言专家？"><!--[--><!--]--> 第49节 如何从小白进阶成 Go 语言专家？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/50.html" class="sidebar-item" aria-label="第50节"><!--[--><!--]--> 第50节 <!--[--><!--]--></a><!----></li><li><a class="external-link sidebar-item" href="https://nsddd.top/archives/contributors" rel="noopener noreferrer" target="_blank" aria-label="💝如何参与贡献？"><!--[--><!--]--> 💝如何参与贡献？ <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><ul><li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">🔥 开源地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h1 id="第33节-软件部署实战-中-iam-系统生产环境部署实战" tabindex="-1"><a class="header-anchor" href="#第33节-软件部署实战-中-iam-系统生产环境部署实战" aria-hidden="true">#</a> 第33节 软件部署实战（中）：IAM 系统生产环境部署实战</h1><br><div><a href="32.md" style="float:left;">⬆️上一节🔗 </a><a href="34.md" style="float:right;"> ⬇️下一节🔗</a></div><br><blockquote><p>❤️💕💕During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><nav class="table-of-contents"><ul><li><a aria-current="page" href="/iam/projects/33.html#部署iam应用" class="router-link-active router-link-exact-active">部署IAM应用</a><ul><li><a aria-current="page" href="/iam/projects/33.html#在10-0-4-20服务器上部署iam应用" class="router-link-active router-link-exact-active">在10.0.4.20服务器上部署IAM应用</a></li><li><a aria-current="page" href="/iam/projects/33.html#在10-0-4-21服务器上部署iam应用" class="router-link-active router-link-exact-active">在10.0.4.21服务器上部署IAM应用</a></li></ul></li><li><a aria-current="page" href="/iam/projects/33.html#配置nginx作为反向代理" class="router-link-active router-link-exact-active">配置Nginx作为反向代理</a></li><li><a aria-current="page" href="/iam/projects/33.html#配置nginx作为负载均衡" class="router-link-active router-link-exact-active">配置Nginx作为负载均衡</a><ul><li><a aria-current="page" href="/iam/projects/33.html#_10-0-4-20服务器配置" class="router-link-active router-link-exact-active">10.0.4.20服务器配置</a></li><li><a aria-current="page" href="/iam/projects/33.html#_10-0-4-21服务器配置" class="router-link-active router-link-exact-active">10.0.4.21服务器配置</a></li><li><a aria-current="page" href="/iam/projects/33.html#测试负载均衡" class="router-link-active router-link-exact-active">测试负载均衡</a></li></ul></li><li><a aria-current="page" href="/iam/projects/33.html#配置keepalived" class="router-link-active router-link-exact-active">配置Keepalived</a><ul><li><a aria-current="page" href="/iam/projects/33.html#第一步-创建腾讯云havip" class="router-link-active router-link-exact-active">第一步：创建腾讯云HAVIP</a></li><li><a aria-current="page" href="/iam/projects/33.html#第二步-主服务器配置" class="router-link-active router-link-exact-active">第二步：主服务器配置</a></li><li><a aria-current="page" href="/iam/projects/33.html#第三步-备服务器配置" class="router-link-active router-link-exact-active">第三步：备服务器配置</a></li><li><a aria-current="page" href="/iam/projects/33.html#第四步-测试keepalived" class="router-link-active router-link-exact-active">第四步：测试Keepalived</a></li><li><a aria-current="page" href="/iam/projects/33.html#第五步-vip绑定公网ip" class="router-link-active router-link-exact-active">第五步：VIP绑定公网IP</a></li><li><a aria-current="page" href="/iam/projects/33.html#第六步-测试公网访问" class="router-link-active router-link-exact-active">第六步：测试公网访问</a></li></ul></li><li><a aria-current="page" href="/iam/projects/33.html#总结" class="router-link-active router-link-exact-active">总结</a></li><li><a aria-current="page" href="/iam/projects/33.html#课后练习" class="router-link-active router-link-exact-active">课后练习</a></li><li><a aria-current="page" href="/iam/projects/33.html#end-链接" class="router-link-active router-link-exact-active">END 链接</a></li></ul></nav><p>[TOC]</p><p>上一讲，我介绍了IAM部署用到的两个核心组件，Nginx和Keepalived。那么这一讲，我们就来看下，如何使用Nginx和Keepalived来部署一个高可用的IAM应用。下一讲，我再介绍下IAM应用安全和弹性伸缩能力的构建方式。</p><p>这一讲，我们会通过下面四个步骤来部署IAM应用：</p><ol><li>在服务器上部署IAM应用中的服务。</li><li>配置Nginx，实现反向代理功能。通过反向代理，我们可以通过Nginx来访问部署在内网的IAM服务。</li><li>配置Nginx，实现负载均衡功能。通过负载均衡，我们可以实现服务的水平扩缩容，使IAM应用具备高可用能力。</li><li>配置Keepalived，实现Nginx的高可用。通过Nginx + Keepalived的组合，可以实现整个应用架构的高可用。</li></ol><h2 id="部署iam应用" tabindex="-1"><a class="header-anchor" href="#部署iam应用" aria-hidden="true">#</a> 部署IAM应用</h2><p>部署一个高可用的IAM应用，需要至少两个节点。所以，我们按照先后顺序，分别在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上部署IAM应用。</p><h3 id="在10-0-4-20服务器上部署iam应用" tabindex="-1"><a class="header-anchor" href="#在10-0-4-20服务器上部署iam应用" aria-hidden="true">#</a> 在<code>10.0.4.20</code>服务器上部署IAM应用</h3><p>首先，我来介绍下如何在<code>10.0.4.20</code>服务器上部署IAM应用。</p><p>我们要在这个服务器上部署如下组件：</p><ul><li>iam-apiserver</li><li>iam-authz-server</li><li>iam-pump</li><li>MariaDB</li><li>Redis</li><li>MongoDB</li></ul><p>这些组件的部署方式，<a href="https://time.geekbang.org/column/article/378082" target="_blank" rel="noopener noreferrer">03讲<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 有介绍，这里就不再说明。</p><p>此外，我们还需要设置MariaDB，给来自于<code>10.0.4.21</code>服务器的数据库连接授权，授权命令如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ mysql <span class="token parameter variable">-hlocalhost</span> <span class="token parameter variable">-P3306</span> <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-proot</span> <span class="token comment"># 先以root用户登陆数据库</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> grant all on iam.* TO iam@10.0.4.21 identified by <span class="token string">&#39;iam1234&#39;</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>

MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> flush privileges<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="在10-0-4-21服务器上部署iam应用" tabindex="-1"><a class="header-anchor" href="#在10-0-4-21服务器上部署iam应用" aria-hidden="true">#</a> 在<code>10.0.4.21</code>服务器上部署IAM应用</h3><p>然后，在<code>10.0.4.21</code>服务器上安装好iam-apiserver、iam-authz-server 和 iam-pump。这些组件通过<code>10.0.4.20</code> IP地址，连接<code>10.0.4.20</code>服务器上的MariaDB、Redis和MongoDB。</p><h2 id="配置nginx作为反向代理" tabindex="-1"><a class="header-anchor" href="#配置nginx作为反向代理" aria-hidden="true">#</a> 配置Nginx作为反向代理</h2><p>假定要访问的API Server和IAM Authorization Server的域名分别为<code>iam.api.marmotedu.com</code>和<code>iam.authz.marmotedu.com</code>，我们需要分别为iam-apiserver和iam-authz-server配置Nginx反向代理。整个配置过程可以分为5步（在<code>10.0.4.20</code>服务器上操作）。</p><p><strong>第一步，配置iam-apiserver。</strong></p><p>新建Nginx配置文件<code>/etc/nginx/conf.d/iam-apiserver.conf</code>，内容如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.api.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://127.0.0.1:8080/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有几点你在配置时需要注意，这里说明下。</p><ul><li><code>server_name</code>需要为<code>iam.api.marmotedu.com</code>，我们通过<code>iam.api.marmotedu.com</code>访问iam-apiserver。</li><li>iam-apiserver默认启动的端口为<code>8080</code>。</li><li>由于Nginx默认允许客户端请求的最大单文件字节数为<code>1MB</code>，实际生产环境中可能太小，所以这里将此限制改为5MB（<code>client_max_body_size 5m</code>）。如果需要上传图片之类的，可能需要设置成更大的值，比如<code>50m</code>。</li><li>server_name用来说明访问Nginx服务器的域名，例如<code>curl -H &#39;Host: iam.api.marmotedu.com&#39; http://x.x.x.x:80/healthz</code>，<code>x.x.x.x</code>为Nginx服务器的IP地址。</li><li>proxy_pass表示反向代理的路径。因为这里是本机的iam-apiserver服务，所以IP为<code>127.0.0.1</code>。端口要和API服务端口一致，为<code>8080</code>。</li></ul><p>最后还要提醒下，因为 Nginx 配置选项比较多，跟实际需求和环境有关，所以这里的配置是基础的、未经优化的配置，在实际生产环境中需要你再做调节。</p><p><strong>第二步，配置iam-authz-server。</strong></p><p>新建Nginx配置文件<code>/etc/nginx/conf.d/iam-authz-server.conf</code>，内容如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.authz.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://127.0.0.1:9090/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是一些配置说明。</p><ul><li>server_name需要为<code>iam.authz.marmotedu.com</code>，我们通过<code>iam.authz.marmotedu.com</code>访问iam-authz-server。</li><li>iam-authz-server默认启动的端口为<code>9090</code>。</li><li>其他配置跟<code>/etc/nginx/conf.d/iam-apiserver.conf</code>一致。</li></ul><p><strong>第三步，配置完Nginx后，重启Nginx：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>第四步，在/etc/hosts中追加下面两行：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1 iam.api.marmotedu.com
<span class="token number">127.0</span>.0.1 iam.authz.marmotedu.com
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第五步，发送HTTP请求：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://iam.api.marmotedu.com/healthz
<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">}</span>
$ <span class="token function">curl</span> http://iam.authz.marmotedu.com/healthz
<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们分别请求iam-apiserver和iam-authz-server的健康检查接口，输出了<code>{&quot;status&quot;:&quot;ok&quot;}</code>，说明我们可以成功通过代理访问后端的API服务。</p><p>在用curl请求<code>http://iam.api.marmotedu.com/healthz</code>后，后端的请求流程实际上是这样的：</p><ol><li>因为在<code>/etc/hosts</code>中配置了<code>127.0.0.1 iam.api.marmotedu.com</code>，所以请求<code>http://iam.api.marmotedu.com/healthz</code>实际上是请求本机的Nginx端口（<code>127.0.0.1:80</code>）。</li><li>Nginx在收到请求后，会解析请求，得到请求域名为<code>iam.api.marmotedu.com</code>。根据请求域名去匹配 Nginx的server配置，匹配到<code>server_name iam.api.marmotedu.com;</code>配置。</li><li>匹配到server后，把请求转发到该server的<code>proxy_pass</code>路径。</li><li>等待API服务器返回结果，并返回客户端。</li></ol><h2 id="配置nginx作为负载均衡" tabindex="-1"><a class="header-anchor" href="#配置nginx作为负载均衡" aria-hidden="true">#</a> 配置Nginx作为负载均衡</h2><p>这门课采用Nginx轮询的负载均衡策略转发请求。负载均衡需要至少两台服务器，所以会分别在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上执行相同的操作。下面我分别来介绍下如何配置这两台服务器，并验证配置是否成功。</p><h3 id="_10-0-4-20服务器配置" tabindex="-1"><a class="header-anchor" href="#_10-0-4-20服务器配置" aria-hidden="true">#</a> <code>10.0.4.20</code>服务器配置</h3><p>登陆<code>10.0.4.20</code>服务器，在<code>/etc/nginx/nginx.conf</code>中添加upstream配置，配置过程可以分为3步。</p><p><strong>第一步，在</strong><code>/etc/nginx/nginx.conf</code><strong>中添加upstream：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>http <span class="token punctuation">{</span>
    log_format  main  <span class="token string">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
                      <span class="token string">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                      <span class="token string">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile            on<span class="token punctuation">;</span>
    tcp_nopush          on<span class="token punctuation">;</span>
    tcp_nodelay         on<span class="token punctuation">;</span>
    keepalive_timeout   <span class="token number">65</span><span class="token punctuation">;</span>
    types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span>

    include             /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type        application/octet-stream<span class="token punctuation">;</span>

    <span class="token comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
    <span class="token comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
    <span class="token comment"># for more information.</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
    upstream iam.api.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:8080
        server <span class="token number">10.0</span>.4.21:8080
    <span class="token punctuation">}</span>
    upstream iam.authz.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:9090
        server <span class="token number">10.0</span>.4.21:9090
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>配置说明：</em></p><ul><li>upstream是配置在<code>/etc/nginx/nginx.conf</code>文件中的<code>http{ … }</code>部分的。</li><li>因为我们要分别为iam-apiserver和iam-authz-server配置负载均衡，所以我们创建了两个upstream，分别是<code>iam.api.marmotedu.com</code>和<code>iam.authz.marmotedu.com</code>。为了便于识别，upstream名称和域名最好保持一致。</li><li>在upstream中，我们需要分别添加所有的iam-apiserver和iam-authz-server的后端（<code>ip:port</code>），本机的后端为了访问更快，可以使用<code>127.0.0.1:&lt;port&gt;</code>，其他机器的后端，需要使用<code>&lt;内网&gt;:port</code>，例如<code>10.0.4.21:8080</code>、<code>10.0.4.21:9090</code>。</li></ul><p><strong>第二步，修改proxy_pass。</strong></p><p>修改<code>/etc/nginx/conf.d/iam-apiserver.conf</code>文件，将<code>proxy_pass</code>修改为：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>proxy_pass http://iam.api.marmotedu.com/;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>修改<code>/etc/nginx/conf.d/iam-authz-server.conf</code>文件，将<code>proxy_pass</code>修改为：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>proxy_pass http://iam.authz.marmotedu.com/;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当Nginx转发到<code>http://iam.api.marmotedu.com/</code>域名时，会从<code>iam.api.marmotedu.com</code> upstream配置的后端列表中，根据负载均衡策略选取一个后端，并将请求转发过去。转发<code>http://iam.authz.marmotedu.com/</code>域名的逻辑也一样。</p><p><strong>第三步，配置完Nginx后，重启Nginx：</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>$ sudo systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>最终配置好的配置文件，你可以参考下面这些（保存在<a href="https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.20" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>目录下）：</p><ul><li>nginx.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/nginx.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/nginx.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li><li>iam-apiserver.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-apiserver.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/iam-apiserver.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li><li>iam-authz-server.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/iam-authz-server.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/iam-authz-server.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ul><h3 id="_10-0-4-21服务器配置" tabindex="-1"><a class="header-anchor" href="#_10-0-4-21服务器配置" aria-hidden="true">#</a> <code>10.0.4.21</code>服务器配置</h3><p>登陆<code>10.0.4.21</code>服务器，在<code>/etc/nginx/nginx.conf</code>中添加upstream配置。配置过程可以分为下面4步。</p><p><strong>第一步，在</strong><code>/etc/nginx/nginx.conf</code><strong>中添加upstream：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
http <span class="token punctuation">{</span>
    log_format  main  <span class="token string">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
                      <span class="token string">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                      <span class="token string">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="token punctuation">;</span>

    access_log  /var/log/nginx/access.log  main<span class="token punctuation">;</span>

    sendfile            on<span class="token punctuation">;</span>
    tcp_nopush          on<span class="token punctuation">;</span>
    tcp_nodelay         on<span class="token punctuation">;</span>
    keepalive_timeout   <span class="token number">65</span><span class="token punctuation">;</span>
    types_hash_max_size <span class="token number">2048</span><span class="token punctuation">;</span>

    include             /etc/nginx/mime.types<span class="token punctuation">;</span>
    default_type        application/octet-stream<span class="token punctuation">;</span>

    <span class="token comment"># Load modular configuration files from the /etc/nginx/conf.d directory.</span>
    <span class="token comment"># See http://nginx.org/en/docs/ngx_core_module.html#include</span>
    <span class="token comment"># for more information.</span>
    include /etc/nginx/conf.d/*.conf<span class="token punctuation">;</span>
    upstream iam.api.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:8080
        server <span class="token number">10.0</span>.4.20:8080
    <span class="token punctuation">}</span>
    upstream iam.authz.marmotedu.com <span class="token punctuation">{</span>
        server <span class="token number">127.0</span>.0.1:9090
        server <span class="token number">10.0</span>.4.20:9090
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>upstream中，需要配置<code>10.0.4.20</code>服务器上的iam-apiserver和iam-authz-server的后端，例如<code>10.0.4.20:8080</code>、<code>10.0.4.20:9090</code>。</p><p><strong>第二步，创建</strong><code>/etc/nginx/conf.d/iam-apiserver.conf</code><strong>文件</strong>（iam-apiserver的反向代理+负载均衡配置），内容如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.api.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://iam.api.marmotedu.com/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第三步，创建</strong><code>/etc/nginx/conf.d/iam-authz-server</code><strong>文件</strong>（iam-authz-server的反向代理+负载均衡配置），内容如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>server <span class="token punctuation">{</span>
    listen       <span class="token number">80</span><span class="token punctuation">;</span>
    server_name  iam.authz.marmotedu.com<span class="token punctuation">;</span>
    root         /usr/share/nginx/html<span class="token punctuation">;</span>
    location / <span class="token punctuation">{</span>
      proxy_set_header X-Forwarded-Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
      proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
      proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
      proxy_pass  http://iam.authz.marmotedu.com/<span class="token punctuation">;</span>
      client_max_body_size 5m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">404</span> /404.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /40x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    error_page <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> /50x.html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> /50x.html <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第四步，配置完Nginx后，重启Nginx：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>最终配置好的配置文件，你可以参考下面这些（保存在<a href="https://github.com/marmotedu/iam/tree/v1.0.8/configs/ha/10.0.4.21" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>目录下）：</p><ul><li>nginx.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/nginx.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/nginx.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li><li>iam-apiserver.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-apiserver.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/iam-apiserver.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li><li>iam-authz-server.conf：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/iam-authz-server.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/iam-authz-server.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ul><h3 id="测试负载均衡" tabindex="-1"><a class="header-anchor" href="#测试负载均衡" aria-hidden="true">#</a> 测试负载均衡</h3><p>上面，我们配置了Nginx负载均衡器，这里我们还需要测试下是否配置成功。</p><p><strong>第一步，执行测试脚本（</strong><a href="https://github.com/marmotedu/iam/blob/v1.0.8/test/nginx/loadbalance.sh" target="_blank" rel="noopener noreferrer">test/nginx/loadbalance.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a><strong>）：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">domain</span> <span class="token keyword">in</span> iam.api.marmotedu.com iam.authz.marmotedu.com
<span class="token keyword">do</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">n</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">10</span><span class="token variable">)</span></span>
  <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$domain</span>
    <span class="token function">nohup</span> <span class="token function">curl</span> http://<span class="token variable">${domain}</span>/healthz <span class="token operator">&amp;&gt;</span>/dev/null <span class="token operator">&amp;</span>
  <span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第二步，分别查看iam-apiserver和iam-authz-server的日志。</strong></p><p>这里我展示下iam-apiserver的日志（iam-authz-server的日志你可自行查看）。</p><p><code>10.0.4.20</code>服务器的iam-apiserver日志如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/58/26/58d072c92552fa3068e3ef3acd0ed726.png?wh=1920x498" alt="图片"></p><p><code>10.0.4.21</code>服务器的iam-apiserver日志如下图所示：</p><p><img src="https://static001.geekbang.org/resource/image/19/85/199066c65ff60007f80f3c2dyy11c785.png?wh=1920x482" alt="图片"></p><p>通过上面两张图，你可以看到<code>10.0.4.20</code>和<code>10.0.4.21</code>各收到<code>5</code>个<code>/healthz</code>请求，说明负载均衡配置成功。</p><h2 id="配置keepalived" tabindex="-1"><a class="header-anchor" href="#配置keepalived" aria-hidden="true">#</a> 配置Keepalived</h2><p>在 <a href="https://time.geekbang.org/column/article/411663" target="_blank" rel="noopener noreferrer">40讲<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，我们分别在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上安装了Keepalived。这里，我来介绍下如何配置Keepalived，实现Nginx的高可用。为了避免故障恢复时，VIP切换造成的服务延时，这一讲采用Keepalived的非抢占模式。</p><p>配置Keepalived的流程比较复杂，分为创建腾讯云HAVIP、主服务器配置、备服务器配置、测试Keepalived、VIP绑定公网IP和测试公网访问六大步，每一步中都有很多小步骤，下面我们来一步步地看下。</p><h3 id="第一步-创建腾讯云havip" tabindex="-1"><a class="header-anchor" href="#第一步-创建腾讯云havip" aria-hidden="true">#</a> <strong>第一步：创建腾讯云HAVIP</strong></h3><p>公有云厂商的普通内网IP，出于安全考虑（如避免ARP欺骗等），不支持主机通过ARP宣告IP 。如果用户直接在<code>keepalived.conf</code>文件中指定一个普通内网IP为virtual IP，当Keepalived将virtual IP从MASTER机器切换到BACKUP机器时，将无法更新IP和MAC地址的映射，而需要调API来进行IP切换。所以，这里的VIP需要申请腾讯云的HAVIP。</p><p>申请的流程可以分为下面4步：</p><ol><li>登录私有网络控制台**。**</li><li>在左侧导航栏中，选择【IP与网卡】&gt;【高可用虚拟IP】。</li><li>在HAVIP管理页面，选择所在地域，单击【申请】。</li><li>在弹出的【申请高可用虚拟IP】对话框中输入名称，选择HAVIP所在的私有网络和子网等信息，单击【确定】即可。</li></ol><p>这里选择的私有网络和子网，需要和<code>10.0.4.20</code>、<code>10.0.4.21</code>相同。HAVIP 的 IP 地址可以自动分配，也可以手动填写，这里我们手动填写为10.0.4.99。申请页面如下图所示：</p><p><a href="https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/a4/11/a49d6e7e080d658392dbb144a1560811.png?wh=827x1016" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="第二步-主服务器配置" tabindex="-1"><a class="header-anchor" href="#第二步-主服务器配置" aria-hidden="true">#</a> 第二步：主服务器配置</h3><p>进行主服务器配置，可以分为两步。</p><p><strong>首先，修改Keepalived配置文件。</strong></p><p>登陆服务器<code>10.0.4.20</code>，编辑<code>/etc/keepalived/keepalived.conf</code>，修改配置，修改后配置内容如下（参考：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.20/keepalived.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.20/keepalived.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 全局定义，定义全局的配置选项</span>
global_defs <span class="token punctuation">{</span>
<span class="token comment"># 指定keepalived在发生切换操作时发送email，发送给哪些email</span>
<span class="token comment"># 建议在keepalived_notify.sh中发送邮件</span>
  notification_email <span class="token punctuation">{</span>
    acassen@firewall.loc
  <span class="token punctuation">}</span>
  notification_email_from Alexandre.Cassen@firewall.loc <span class="token comment"># 发送email时邮件源地址</span>
    smtp_server <span class="token number">192.168</span>.200.1 <span class="token comment"># 发送email时smtp服务器地址</span>
    smtp_connect_timeout <span class="token number">30</span> <span class="token comment"># 连接smtp的超时时间</span>
    router_id VM-4-20-centos <span class="token comment"># 机器标识，通常可以设置为hostname</span>
    vrrp_skip_check_adv_addr <span class="token comment"># 如果接收到的报文和上一个报文来自同一个路由器，则不执行检查。默认是跳过检查</span>
    vrrp_garp_interval <span class="token number">0</span> <span class="token comment"># 单位秒，在一个网卡上每组gratuitous arp消息之间的延迟时间，默认为0</span>
    vrrp_gna_interval <span class="token number">0</span> <span class="token comment"># 单位秒，在一个网卡上每组na消息之间的延迟时间，默认为0</span>
<span class="token punctuation">}</span>
<span class="token comment"># 检测脚本配置</span>
vrrp_script checkhaproxy
<span class="token punctuation">{</span>
  script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span> <span class="token comment"># 检测脚本路径</span>
    interval <span class="token number">5</span> <span class="token comment"># 检测时间间隔（秒）</span>
    weight <span class="token number">0</span> <span class="token comment"># 根据该权重改变priority，当值为0时，不改变实例的优先级</span>
<span class="token punctuation">}</span>
<span class="token comment"># VRRP实例配置</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
  state BACKUP  <span class="token comment"># 设置初始状态为&#39;备份&#39;</span>
    interface eth0 <span class="token comment"># 设置绑定VIP的网卡，例如eth0</span>
    virtual_router_id <span class="token number">51</span>  <span class="token comment"># 配置集群VRID，互为主备的VRID需要是相同的值</span>
    nopreempt               <span class="token comment"># 设置非抢占模式，只能设置在state为backup的节点上</span>
    priority <span class="token number">100</span> <span class="token comment"># 设置优先级，值范围0～254，值越大优先级越高，最高的为master</span>
    advert_int <span class="token number">1</span> <span class="token comment"># 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒</span>
<span class="token comment"># 验证信息，两个节点必须一致</span>
    authentication <span class="token punctuation">{</span>
      auth_type PASS <span class="token comment"># 认证方式，可以是PASS或AH两种认证方式</span>
        auth_pass <span class="token number">1111</span> <span class="token comment"># 认证密码</span>
    <span class="token punctuation">}</span>
  unicast_src_ip <span class="token number">10.0</span>.4.20  <span class="token comment"># 设置本机内网IP地址</span>
    unicast_peer <span class="token punctuation">{</span>
      <span class="token number">10.0</span>.4.21             <span class="token comment"># 对端设备的IP地址</span>
    <span class="token punctuation">}</span>
<span class="token comment"># VIP，当state为master时添加，当state为backup时删除</span>
  virtual_ipaddress <span class="token punctuation">{</span>
    <span class="token number">10.0</span>.4.99 <span class="token comment"># 设置高可用虚拟VIP，如果是腾讯云的CVM，需要填写控制台申请到的HAVIP地址。</span>
  <span class="token punctuation">}</span>
  notify_master <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh MASTER&quot;</span> <span class="token comment"># 当切换到master状态时执行脚本</span>
    notify_backup <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh BACKUP&quot;</span> <span class="token comment"># 当切换到backup状态时执行脚本</span>
    notify_fault <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh FAULT&quot;</span> <span class="token comment"># 当切换到fault状态时执行脚本</span>
    notify_stop <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh STOP&quot;</span> <span class="token comment"># 当切换到stop状态时执行脚本</span>
    garp_master_delay <span class="token number">1</span>    <span class="token comment"># 设置当切为主状态后多久更新ARP缓存</span>
    garp_master_refresh <span class="token number">5</span>   <span class="token comment"># 设置主节点发送ARP报文的时间间隔</span>
    <span class="token comment"># 跟踪接口，里面任意一块网卡出现问题，都会进入故障(FAULT)状态</span>
    track_interface <span class="token punctuation">{</span>
      eth0
    <span class="token punctuation">}</span>
  <span class="token comment"># 要执行的检查脚本</span>
  track_script <span class="token punctuation">{</span>
    checkhaproxy
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里有几个注意事项：</p><ul><li>确保已经配置了garp相关参数。因为Keepalived依赖ARP报文更新IP信息，如果缺少这些参数，会导致某些场景下主设备不发送ARP，进而导致通信异常。garp相关参数配置如下：</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>garp_master_delay <span class="token number">1</span>
garp_master_refresh <span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>确定没有采用 strict 模式，即需要删除vrrp_strict配置。</li><li>配置中的<code>/etc/keepalived/check_nginx.sh</code>和<code>/etc/keepalived/keepalived_notify.sh</code>脚本文件，可分别拷贝自<a href="https://github.com/marmotedu/iam/blob/v1.0.8/scripts/check_nginx.sh" target="_blank" rel="noopener noreferrer">scripts/check_nginx.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>和<a href="https://github.com/marmotedu/iam/blob/v1.0.8/scripts/keepalived_notify.sh" target="_blank" rel="noopener noreferrer">scripts/keepalived_notify.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。</li></ul><p><strong>然后，重启Keepalived：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart keepalived
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="第三步-备服务器配置" tabindex="-1"><a class="header-anchor" href="#第三步-备服务器配置" aria-hidden="true">#</a> 第三步：备服务器配置</h3><p>进行备服务器配置也分为两步。</p><p><strong>首先，修改Keepalived配置文件。</strong></p><p>登陆服务器<code>10.0.4.21</code>，编辑<code>/etc/keepalived/keepalived.conf</code>，修改配置，修改后配置内容如下（参考：<a href="https://github.com/marmotedu/iam/blob/v1.0.8/configs/ha/10.0.4.21/keepalived.conf" target="_blank" rel="noopener noreferrer">configs/ha/10.0.4.21/keepalived.conf<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>）：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 全局定义，定义全局的配置选项</span>
global_defs <span class="token punctuation">{</span>
<span class="token comment"># 指定keepalived在发生切换操作时发送email，发送给哪些email</span>
<span class="token comment"># 建议在keepalived_notify.sh中发送邮件</span>
  notification_email <span class="token punctuation">{</span>
    acassen@firewall.loc
  <span class="token punctuation">}</span>
  notification_email_from Alexandre.Cassen@firewall.loc <span class="token comment"># 发送email时邮件源地址</span>
    smtp_server <span class="token number">192.168</span>.200.1 <span class="token comment"># 发送email时smtp服务器地址</span>
    smtp_connect_timeout <span class="token number">30</span> <span class="token comment"># 连接smtp的超时时间</span>
    router_id VM-4-21-centos <span class="token comment"># 机器标识，通常可以设置为hostname</span>
    vrrp_skip_check_adv_addr <span class="token comment"># 如果接收到的报文和上一个报文来自同一个路由器，则不执行检查。默认是跳过检查</span>
    vrrp_garp_interval <span class="token number">0</span> <span class="token comment"># 单位秒，在一个网卡上每组gratuitous arp消息之间的延迟时间，默认为0</span>
    vrrp_gna_interval <span class="token number">0</span> <span class="token comment"># 单位秒，在一个网卡上每组na消息之间的延迟时间，默认为0</span>
<span class="token punctuation">}</span>
<span class="token comment"># 检测脚本配置</span>
vrrp_script checkhaproxy
<span class="token punctuation">{</span>
  script <span class="token string">&quot;/etc/keepalived/check_nginx.sh&quot;</span> <span class="token comment"># 检测脚本路径</span>
    interval <span class="token number">5</span> <span class="token comment"># 检测时间间隔（秒）</span>
    weight <span class="token number">0</span> <span class="token comment"># 根据该权重改变priority，当值为0时，不改变实例的优先级</span>
<span class="token punctuation">}</span>
<span class="token comment"># VRRP实例配置</span>
vrrp_instance VI_1 <span class="token punctuation">{</span>
  state BACKUP  <span class="token comment"># 设置初始状态为&#39;备份&#39;</span>
    interface eth0 <span class="token comment"># 设置绑定VIP的网卡，例如eth0</span>
    virtual_router_id <span class="token number">51</span>  <span class="token comment"># 配置集群VRID，互为主备的VRID需要是相同的值</span>
    nopreempt               <span class="token comment"># 设置非抢占模式，只能设置在state为backup的节点上</span>
    priority <span class="token number">50</span> <span class="token comment"># 设置优先级，值范围0～254，值越大优先级越高，最高的为master</span>
    advert_int <span class="token number">1</span> <span class="token comment"># 组播信息发送时间间隔，两个节点必须设置一样，默认为1秒</span>
<span class="token comment"># 验证信息，两个节点必须一致</span>
    authentication <span class="token punctuation">{</span>
      auth_type PASS <span class="token comment"># 认证方式，可以是PASS或AH两种认证方式</span>
        auth_pass <span class="token number">1111</span> <span class="token comment"># 认证密码</span>
    <span class="token punctuation">}</span>
  unicast_src_ip <span class="token number">10.0</span>.4.21  <span class="token comment"># 设置本机内网IP地址</span>
    unicast_peer <span class="token punctuation">{</span>
      <span class="token number">10.0</span>.4.20             <span class="token comment"># 对端设备的IP地址</span>
    <span class="token punctuation">}</span>
<span class="token comment"># VIP，当state为master时添加，当state为backup时删除</span>
  virtual_ipaddress <span class="token punctuation">{</span>
    <span class="token number">10.0</span>.4.99 <span class="token comment"># 设置高可用虚拟VIP，如果是腾讯云的CVM，需要填写控制台申请到的HAVIP地址。</span>
  <span class="token punctuation">}</span>
  notify_master <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh MASTER&quot;</span> <span class="token comment"># 当切换到master状态时执行脚本</span>
    notify_backup <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh BACKUP&quot;</span> <span class="token comment"># 当切换到backup状态时执行脚本</span>
    notify_fault <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh FAULT&quot;</span> <span class="token comment"># 当切换到fault状态时执行脚本</span>
    notify_stop <span class="token string">&quot;/etc/keepalived/keepalived_notify.sh STOP&quot;</span> <span class="token comment"># 当切换到stop状态时执行脚本</span>
    garp_master_delay <span class="token number">1</span>    <span class="token comment"># 设置当切为主状态后多久更新ARP缓存</span>
    garp_master_refresh <span class="token number">5</span>   <span class="token comment"># 设置主节点发送ARP报文的时间间隔</span>
    <span class="token comment"># 跟踪接口，里面任意一块网卡出现问题，都会进入故障(FAULT)状态</span>
    track_interface <span class="token punctuation">{</span>
      eth0
    <span class="token punctuation">}</span>
  <span class="token comment"># 要执行的检查脚本</span>
  track_script <span class="token punctuation">{</span>
    checkhaproxy
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>然后，重启Keepalived：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl restart keepalived
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="第四步-测试keepalived" tabindex="-1"><a class="header-anchor" href="#第四步-测试keepalived" aria-hidden="true">#</a> 第四步：测试Keepalived</h3><p>上面的配置中，<code>10.0.4.20</code>的优先级更高，所以正常情况下<code>10.0.4.20</code>将被选择为主节点，如下图所示：</p><p><a href="https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/54/79/54968f40707b779e2ab70d3ab5a53479.png?wh=1920x500" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>接下来，我们分别模拟一些故障场景，来看下配置是否生效。</p><p><strong>场景1：Keepalived故障</strong></p><p>在<code>10.0.4.20</code>服务器上执行<code>sudo systemctl stop keepalived</code>模拟Keepalived故障，查看VIP，如下图所示：</p><p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>可以看到，VIP从<code>10.0.4.20</code>服务器上，漂移到了<code>10.0.4.21</code>服务器上。查看<code>/var/log/keepalived.log</code>，可以看到<code>10.0.4.20</code>服务器新增如下一行日志：</p><div class="language-plain ext-plain line-numbers-mode"><pre class="language-plain"><code>[2020-10-14 14:01:51] notify_stop
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>10.0.4.21</code>服务器新增如下日志：</p><div class="language-plain ext-plain line-numbers-mode"><pre class="language-plain"><code>[2020-10-14 14:01:52] notify_master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>场景2：Nginx故障</strong></p><p>在<code>10.0.4.20</code>和<code>10.0.4.21</code>服务器上分别执行<code>sudo systemctl restart keepalived</code>，让VIP漂移到<code>10.0.4.20</code>服务器上。</p><p>在<code>10.0.4.20</code>服务器上，执行 <code>sudo systemctl stop nginx</code> 模拟Nginx故障，查看VIP，如下图所示：</p><p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>可以看到，VIP从<code>10.0.4.20</code>服务器上，漂移到了<code>10.0.4.21</code>服务器上。查看<code>/var/log/keepalived.log</code>，可以看到<code>10.0.4.20</code>服务器新增如下一行日志：</p><div class="language-plain ext-plain line-numbers-mode"><pre class="language-plain"><code>[2020-10-14 14:02:34] notify_fault
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>10.0.4.21</code> 服务器新增如下日志：</p><div class="language-plain ext-plain line-numbers-mode"><pre class="language-plain"><code>[2020-10-14 14:02:35] notify_master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>场景3：Nginx恢复</strong></p><p>基于<strong>场景2</strong>，在<code>10.0.4.20</code>服务器上执行<code>sudo systemctl start nginx</code>恢复Nginx，查看VIP，如下图所示：</p><p><a href="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/2a/ee/2a57e958bd9fce3b9c842c1cf09c48ee.png?wh=1920x544" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>可以看到，VIP仍然在<code>10.0.4.21</code>服务器上，没有被<code>10.0.4.20</code>抢占。查看<code>/var/log/keepalived.log</code>，可以看到<code>10.0.4.20</code>服务器新增如下一行日志：</p><div class="language-plain ext-plain line-numbers-mode"><pre class="language-plain"><code>[2020-10-14 14:03:44] notify_backup
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>10.0.4.21</code>服务器没有新增日志。</p><h3 id="第五步-vip绑定公网ip" tabindex="-1"><a class="header-anchor" href="#第五步-vip绑定公网ip" aria-hidden="true">#</a> 第五步：VIP绑定公网IP</h3><p>到这里，我们已经成功配置了Keepalived + Nginx的高可用方案。但是，我们的VIP是内网，还不能通过外网访问。这时候，我们需要将VIP绑定一个外网IP，供外网访问。在腾讯云上，可通过绑定弹性公网IP来实现外网访问，需要先申请公网IP，然后将VIP绑定弹性公网IP。下面我来讲讲具体步骤。</p><p>申请公网IP：</p><ol><li>登录<strong>私有网络控制台。</strong></li><li>在左侧导航栏中，选择【IP与网卡】&gt;【弹性公网IP】。</li><li>在弹性公网IP管理页面，选择所在地域，单击【申请】。</li></ol><p>将VIP绑定弹性公网IP：</p><ol><li>登录<strong>私有网络控制台</strong>。</li><li>在左侧导航栏中，选择【IP与网卡】&gt;【高可用虚拟】。</li><li>单击需要绑定的HAVIP所在行的【绑定】。</li><li>在弹出界面中，选择需要绑定的公网IP即可，如下图所示：</li></ol><p><a href="https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666" target="_blank" rel="noopener noreferrer"><img src="https://static001.geekbang.org/resource/image/83/62/83bc9f4595325e9d339e7c3269aa3462.png?wh=1388x666" alt="图片"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>绑定的弹性公网IP是<code>106.52.252.139</code>。</p><p>这里提示下，腾讯云平台中，如果HAVIP没有绑定实例，绑定HAVIP的EIP会处于闲置状态，按<code>¥0.2/小时</code> 收取闲置费用。所以，你需要正确配置高可用应用，确保绑定成功。</p><h3 id="第六步-测试公网访问" tabindex="-1"><a class="header-anchor" href="#第六步-测试公网访问" aria-hidden="true">#</a> 第六步：测试公网访问</h3><p>最后，你可以通过执行如下命令来测试：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> -H<span class="token string">&quot;Host: iam.api.marmotedu.com&quot;</span> http://106.52.252.139/healthz -H<span class="token string">&quot;iam.api.marmotedu.com&quot;</span>
<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到，我们可以成功通过公网访问后端的高可用服务。到这里，我们成功部署了一个可用性很高的IAM应用。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>今天，我主要讲了如何使用Nginx和Keepalived，来部署一个高可用的IAM应用。</p><p>为了部署一个高可用的IAM应用，我们至少需要两台服务器，并且部署相同的服务iam-apiserver、iam-authz-server、iam-pump。而且，选择其中一台服务器部署数据库服务：MariaDB、Redis、MongoDB。</p><p>为了安全和性能，iam-apiserver、iam-authz-server、iam-pump服务都是通过内网来访问数据库服务的。这一讲，我还介绍了如何配置Nginx来实现负载均衡，如何配置Keepalived来实现Nginx的高可用。</p><h2 id="课后练习" tabindex="-1"><a class="header-anchor" href="#课后练习" aria-hidden="true">#</a> 课后练习</h2><ol><li>思考下，当前部署架构下如果iam-apiserver需要扩容，可以怎么扩容？</li><li>思考下，当VIP切换时，如何实现告警功能，给系统运维人员告警？</li></ol><h2 id="end-链接" tabindex="-1"><a class="header-anchor" href="#end-链接" aria-hidden="true">#</a> END 链接</h2><ul><li><div><a href="32.md" style="float:left;">⬆️上一节🔗 </a><a href="34.md" style="float:right;"> ️下一节🔗</a></div></li></ul><ul><li><p><a href="/iam/" class="">Ⓜ️回到目录🏠</a></p></li><li><p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>🫵参与贡献💞❤️‍🔥💖</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p></li><li><p>✴️版权声明 © ：本书所有内容遵循<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0协议（署名-相同方式共享）©<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/3293172751/awesome-go/edit/master/docs/iam/projects/33.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub上贡献此页面"><!--[--><!--]--> 在GitHub上贡献此页面 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/iam/projects/32.html" class="" aria-label="第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍"><!--[--><!--]--> 第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍 <!--[--><!--]--></a></span><span class="next"><a href="/iam/projects/34.html" class="" aria-label="第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战"><!--[--><!--]--> 第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.df174e55.js" defer></script>
  </body>
</html>

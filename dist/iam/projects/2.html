<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/img/1.jpg"><title>第2节 IAM项目部署 | 你好</title><meta name="description" content="链学社致力于打造出区块链去中心化的学习平台">
    <link rel="modulepreload" href="/assets/app.df174e55.js"><link rel="modulepreload" href="/assets/2.html.58eeb18b.js"><link rel="modulepreload" href="/assets/2.html.ad5997eb.js"><link rel="prefetch" href="/assets/index.html.25a7a27a.js"><link rel="prefetch" href="/assets/index.html.a36ccd78.js"><link rel="prefetch" href="/assets/1.html.461afd80.js"><link rel="prefetch" href="/assets/10.html.4f13ef50.js"><link rel="prefetch" href="/assets/11.html.f09f95c3.js"><link rel="prefetch" href="/assets/12.html.a67acf21.js"><link rel="prefetch" href="/assets/13.html.0420c962.js"><link rel="prefetch" href="/assets/14.html.b0b5806d.js"><link rel="prefetch" href="/assets/15.html.06f1cde4.js"><link rel="prefetch" href="/assets/16.html.2c2a072d.js"><link rel="prefetch" href="/assets/17.html.be392cda.js"><link rel="prefetch" href="/assets/18.html.8b213912.js"><link rel="prefetch" href="/assets/19.html.1dca5398.js"><link rel="prefetch" href="/assets/20.html.1bd75582.js"><link rel="prefetch" href="/assets/21.html.9cb3d476.js"><link rel="prefetch" href="/assets/22.html.4c43a0a4.js"><link rel="prefetch" href="/assets/23.html.0341a155.js"><link rel="prefetch" href="/assets/24.html.f74332a7.js"><link rel="prefetch" href="/assets/25.html.32aca821.js"><link rel="prefetch" href="/assets/26.html.cc5ca1a2.js"><link rel="prefetch" href="/assets/27.html.09791ec4.js"><link rel="prefetch" href="/assets/28.html.4aa1094d.js"><link rel="prefetch" href="/assets/29.html.165cddd8.js"><link rel="prefetch" href="/assets/3.html.427f6088.js"><link rel="prefetch" href="/assets/30.html.5c492d35.js"><link rel="prefetch" href="/assets/31.html.b4a50d0d.js"><link rel="prefetch" href="/assets/32.html.3a8a6f2f.js"><link rel="prefetch" href="/assets/33.html.e8f65480.js"><link rel="prefetch" href="/assets/34.html.580498c1.js"><link rel="prefetch" href="/assets/35.html.2da63961.js"><link rel="prefetch" href="/assets/36.html.d8049f92.js"><link rel="prefetch" href="/assets/37.html.0dbda88b.js"><link rel="prefetch" href="/assets/38.html.d8605d22.js"><link rel="prefetch" href="/assets/39.html.84a2efa8.js"><link rel="prefetch" href="/assets/4.html.3a1de71e.js"><link rel="prefetch" href="/assets/40.html.532610aa.js"><link rel="prefetch" href="/assets/41.html.172bb15b.js"><link rel="prefetch" href="/assets/42.html.e71d9386.js"><link rel="prefetch" href="/assets/43.html.99ab5c93.js"><link rel="prefetch" href="/assets/44.html.ed92b7f3.js"><link rel="prefetch" href="/assets/45.html.2fa65b5e.js"><link rel="prefetch" href="/assets/46.html.f0dd66d1.js"><link rel="prefetch" href="/assets/47.html.4c6f6d3d.js"><link rel="prefetch" href="/assets/48.html.3cdc0986.js"><link rel="prefetch" href="/assets/49.html.936da8ed.js"><link rel="prefetch" href="/assets/5.html.0f758775.js"><link rel="prefetch" href="/assets/50.html.e8114b3c.js"><link rel="prefetch" href="/assets/51.html.8dba5f2d.js"><link rel="prefetch" href="/assets/52.html.4e857563.js"><link rel="prefetch" href="/assets/53.html.c513f2cd.js"><link rel="prefetch" href="/assets/54.html.cc298904.js"><link rel="prefetch" href="/assets/55.html.dd8403bb.js"><link rel="prefetch" href="/assets/56.html.a6fa9c2b.js"><link rel="prefetch" href="/assets/57.html.8d9ca11b.js"><link rel="prefetch" href="/assets/58.html.d2d6137f.js"><link rel="prefetch" href="/assets/59.html.64bfc6aa.js"><link rel="prefetch" href="/assets/6.html.4f7ba7c5.js"><link rel="prefetch" href="/assets/60.html.9d280a7e.js"><link rel="prefetch" href="/assets/61.html.93e3d982.js"><link rel="prefetch" href="/assets/62.html.7c25e781.js"><link rel="prefetch" href="/assets/63.html.c7c354a1.js"><link rel="prefetch" href="/assets/64.html.0d112a0c.js"><link rel="prefetch" href="/assets/65.html.8b9a0ae3.js"><link rel="prefetch" href="/assets/66.html.60a5c98f.js"><link rel="prefetch" href="/assets/67.html.65a79637.js"><link rel="prefetch" href="/assets/68.html.9c8743e4.js"><link rel="prefetch" href="/assets/69.html.f262d742.js"><link rel="prefetch" href="/assets/7.html.658a2ddf.js"><link rel="prefetch" href="/assets/70.html.a13f0df5.js"><link rel="prefetch" href="/assets/71.html.e5232458.js"><link rel="prefetch" href="/assets/72.html.55331bc1.js"><link rel="prefetch" href="/assets/73.html.cf7ccd53.js"><link rel="prefetch" href="/assets/74.html.48daf8af.js"><link rel="prefetch" href="/assets/75.html.4a47e12f.js"><link rel="prefetch" href="/assets/76.html.72c869e6.js"><link rel="prefetch" href="/assets/77.html.a9d9ff7d.js"><link rel="prefetch" href="/assets/78.html.0feb5171.js"><link rel="prefetch" href="/assets/79.html.7a6a2cc4.js"><link rel="prefetch" href="/assets/8.html.8d69e3db.js"><link rel="prefetch" href="/assets/80.html.88f5c71d.js"><link rel="prefetch" href="/assets/81.html.3ec4d333.js"><link rel="prefetch" href="/assets/82.html.70be117a.js"><link rel="prefetch" href="/assets/83.html.07de8b59.js"><link rel="prefetch" href="/assets/84.html.37bf069c.js"><link rel="prefetch" href="/assets/85.html.d88064c7.js"><link rel="prefetch" href="/assets/86.html.2ea4f0ba.js"><link rel="prefetch" href="/assets/87.html.fcd098dc.js"><link rel="prefetch" href="/assets/88.html.455f17e4.js"><link rel="prefetch" href="/assets/89.html.94c12162.js"><link rel="prefetch" href="/assets/9.html.3619251b.js"><link rel="prefetch" href="/assets/90.html.47f84836.js"><link rel="prefetch" href="/assets/91.html.f355cbb5.js"><link rel="prefetch" href="/assets/92.html.4b6d0a6b.js"><link rel="prefetch" href="/assets/93.html.8c027538.js"><link rel="prefetch" href="/assets/94.html.e175d373.js"><link rel="prefetch" href="/assets/95.html.58fba167.js"><link rel="prefetch" href="/assets/96.html.cfc1673c.js"><link rel="prefetch" href="/assets/97.html.71615abb.js"><link rel="prefetch" href="/assets/98.html.817dd510.js"><link rel="prefetch" href="/assets/99.html.41ed9550.js"><link rel="prefetch" href="/assets/404.html.c3e557d0.js"><link rel="prefetch" href="/assets/index.html.5078607b.js"><link rel="prefetch" href="/assets/index.html.238b898d.js"><link rel="prefetch" href="/assets/1.html.68bd8bc7.js"><link rel="prefetch" href="/assets/10.html.6703ed8a.js"><link rel="prefetch" href="/assets/11.html.087bca0d.js"><link rel="prefetch" href="/assets/12.html.54a22c52.js"><link rel="prefetch" href="/assets/13.html.4bb58d38.js"><link rel="prefetch" href="/assets/14.html.503f448c.js"><link rel="prefetch" href="/assets/15.html.8574c656.js"><link rel="prefetch" href="/assets/16.html.a1bd17bb.js"><link rel="prefetch" href="/assets/17.html.1efae1db.js"><link rel="prefetch" href="/assets/18.html.2f97fa21.js"><link rel="prefetch" href="/assets/19.html.3e0f7c64.js"><link rel="prefetch" href="/assets/20.html.b8b46978.js"><link rel="prefetch" href="/assets/21.html.70c7de34.js"><link rel="prefetch" href="/assets/22.html.aa7bd96c.js"><link rel="prefetch" href="/assets/23.html.ad35e20a.js"><link rel="prefetch" href="/assets/24.html.0963e8cd.js"><link rel="prefetch" href="/assets/25.html.df593c5c.js"><link rel="prefetch" href="/assets/26.html.21e72cc8.js"><link rel="prefetch" href="/assets/27.html.abbc553f.js"><link rel="prefetch" href="/assets/28.html.eefcc4fe.js"><link rel="prefetch" href="/assets/29.html.b3a7277c.js"><link rel="prefetch" href="/assets/3.html.ece505c8.js"><link rel="prefetch" href="/assets/30.html.4139f101.js"><link rel="prefetch" href="/assets/31.html.78bdceca.js"><link rel="prefetch" href="/assets/32.html.b715024d.js"><link rel="prefetch" href="/assets/33.html.28fbd3f1.js"><link rel="prefetch" href="/assets/34.html.4a53b877.js"><link rel="prefetch" href="/assets/35.html.3714035c.js"><link rel="prefetch" href="/assets/36.html.6593b1dd.js"><link rel="prefetch" href="/assets/37.html.1030763e.js"><link rel="prefetch" href="/assets/38.html.564c84b7.js"><link rel="prefetch" href="/assets/39.html.9e6b9426.js"><link rel="prefetch" href="/assets/4.html.0cced93c.js"><link rel="prefetch" href="/assets/40.html.baa78d6a.js"><link rel="prefetch" href="/assets/41.html.ce225826.js"><link rel="prefetch" href="/assets/42.html.6ef135a0.js"><link rel="prefetch" href="/assets/43.html.235f7002.js"><link rel="prefetch" href="/assets/44.html.d18c82d2.js"><link rel="prefetch" href="/assets/45.html.2f2c2f8c.js"><link rel="prefetch" href="/assets/46.html.45e49c32.js"><link rel="prefetch" href="/assets/47.html.2071b30e.js"><link rel="prefetch" href="/assets/48.html.d1a08b55.js"><link rel="prefetch" href="/assets/49.html.5ebe1da7.js"><link rel="prefetch" href="/assets/5.html.92b708de.js"><link rel="prefetch" href="/assets/50.html.3a175eb7.js"><link rel="prefetch" href="/assets/51.html.d27f00bb.js"><link rel="prefetch" href="/assets/52.html.8b437f64.js"><link rel="prefetch" href="/assets/53.html.d913eb66.js"><link rel="prefetch" href="/assets/54.html.8271495e.js"><link rel="prefetch" href="/assets/55.html.bdc49926.js"><link rel="prefetch" href="/assets/56.html.3dc8abe7.js"><link rel="prefetch" href="/assets/57.html.7d8f4d4c.js"><link rel="prefetch" href="/assets/58.html.2e807b03.js"><link rel="prefetch" href="/assets/59.html.83549612.js"><link rel="prefetch" href="/assets/6.html.1d2cb545.js"><link rel="prefetch" href="/assets/60.html.fb941722.js"><link rel="prefetch" href="/assets/61.html.10d42607.js"><link rel="prefetch" href="/assets/62.html.63d223ec.js"><link rel="prefetch" href="/assets/63.html.afb0566c.js"><link rel="prefetch" href="/assets/64.html.88e70600.js"><link rel="prefetch" href="/assets/65.html.6ee1b8fd.js"><link rel="prefetch" href="/assets/66.html.ab8f36c8.js"><link rel="prefetch" href="/assets/67.html.bb9f4dde.js"><link rel="prefetch" href="/assets/68.html.081ecec1.js"><link rel="prefetch" href="/assets/69.html.94b26ac8.js"><link rel="prefetch" href="/assets/7.html.cef2e333.js"><link rel="prefetch" href="/assets/70.html.21112954.js"><link rel="prefetch" href="/assets/71.html.b6760737.js"><link rel="prefetch" href="/assets/72.html.46e6db4d.js"><link rel="prefetch" href="/assets/73.html.872f9067.js"><link rel="prefetch" href="/assets/74.html.e2fad9a6.js"><link rel="prefetch" href="/assets/75.html.41837637.js"><link rel="prefetch" href="/assets/76.html.bd895802.js"><link rel="prefetch" href="/assets/77.html.d16746b1.js"><link rel="prefetch" href="/assets/78.html.7573af34.js"><link rel="prefetch" href="/assets/79.html.4ba1b576.js"><link rel="prefetch" href="/assets/8.html.ffbe5f0d.js"><link rel="prefetch" href="/assets/80.html.964f8ea4.js"><link rel="prefetch" href="/assets/81.html.f0f8c8ea.js"><link rel="prefetch" href="/assets/82.html.42775672.js"><link rel="prefetch" href="/assets/83.html.dca364d9.js"><link rel="prefetch" href="/assets/84.html.03706d5c.js"><link rel="prefetch" href="/assets/85.html.32142600.js"><link rel="prefetch" href="/assets/86.html.bc85e920.js"><link rel="prefetch" href="/assets/87.html.406eea6e.js"><link rel="prefetch" href="/assets/88.html.2fa5b983.js"><link rel="prefetch" href="/assets/89.html.ac21d36d.js"><link rel="prefetch" href="/assets/9.html.b60314dd.js"><link rel="prefetch" href="/assets/90.html.ccb3b75c.js"><link rel="prefetch" href="/assets/91.html.42ecc4c5.js"><link rel="prefetch" href="/assets/92.html.50a515c1.js"><link rel="prefetch" href="/assets/93.html.b5657afc.js"><link rel="prefetch" href="/assets/94.html.c185d24f.js"><link rel="prefetch" href="/assets/95.html.ad73eb9e.js"><link rel="prefetch" href="/assets/96.html.cb8ab449.js"><link rel="prefetch" href="/assets/97.html.06281eee.js"><link rel="prefetch" href="/assets/98.html.23720464.js"><link rel="prefetch" href="/assets/99.html.ae6e8b44.js"><link rel="prefetch" href="/assets/404.html.e3b93612.js">
    <link rel="stylesheet" href="/assets/style.03848e77.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">你好</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/3293172751/cs-awesome-Block_Chain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/3293172751/cs-awesome-Block_Chain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/3293172751/awesome-go" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="🏠回到主页"><!--[--><!--]--> 🏠回到主页 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">🔥 Go语言基础篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/iam/projects/1.html" class="sidebar-item" aria-label="第1节 IAM项目介绍"><!--[--><!--]--> 第1节 IAM项目介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第2节 IAM项目部署"><!--[--><!--]--> 第2节 IAM项目部署 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/iam/projects/2.html#前言" class="router-link-active router-link-exact-active sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#基本开发环境" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本开发环境"><!--[--><!--]--> 基本开发环境 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#go语言环境变量设置和含义" class="router-link-active router-link-exact-active sidebar-item" aria-label="go语言环境变量设置和含义"><!--[--><!--]--> go语言环境变量设置和含义 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#vim-go-plug" class="router-link-active router-link-exact-active sidebar-item" aria-label="vim go-plug"><!--[--><!--]--> vim go-plug <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#protobuf-编译环境安装" class="router-link-active router-link-exact-active sidebar-item" aria-label="ProtoBuf 编译环境安装"><!--[--><!--]--> ProtoBuf 编译环境安装 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#iam手动部署" class="router-link-active router-link-exact-active sidebar-item" aria-label="IAM手动部署"><!--[--><!--]--> IAM手动部署 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置数据库" class="router-link-active router-link-exact-active sidebar-item" aria-label="安装和配置数据库"><!--[--><!--]--> 安装和配置数据库 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#一键安装" class="router-link-active router-link-exact-active sidebar-item" aria-label="一键安装"><!--[--><!--]--> 一键安装 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/2.html#end-链接" class="router-link-active router-link-exact-active sidebar-item" aria-label="END 链接"><!--[--><!--]--> END 链接 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/iam/projects/3.html" class="sidebar-item" aria-label="第3节 设计规范"><!--[--><!--]--> 第3节 设计规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/4.html" class="sidebar-item" aria-label="第4节 Go语言项目设计"><!--[--><!--]--> 第4节 Go语言项目设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/5.html" class="sidebar-item" aria-label="第5节 设计并写出优雅的Go语言项目"><!--[--><!--]--> 第5节 设计并写出优雅的Go语言项目 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/6.html" class="sidebar-item" aria-label="第6节 API 风格设计"><!--[--><!--]--> 第6节 API 风格设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/7.html" class="sidebar-item" aria-label="第7节 高质量的Makefile"><!--[--><!--]--> 第7节 高质量的Makefile <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/8.html" class="sidebar-item" aria-label="第8节 IAM 项目如何进行研发流程管理"><!--[--><!--]--> 第8节 IAM 项目如何进行研发流程管理 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/9.html" class="sidebar-item" aria-label="第9节 静态代码检测"><!--[--><!--]--> 第9节 静态代码检测 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/10.html" class="sidebar-item" aria-label="第10节 如何生成 Swagger API 文档"><!--[--><!--]--> 第10节 如何生成 Swagger API 文档 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/11.html" class="sidebar-item" aria-label="第11节 设计一套科学的错误码"><!--[--><!--]--> 第11节 设计一套科学的错误码 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/12.html" class="sidebar-item" aria-label="第12节 记录和设计日志"><!--[--><!--]--> 第12节 记录和设计日志 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/13.html" class="sidebar-item" aria-label="第13节  从 0 编写一个日志包"><!--[--><!--]--> 第13节  从 0 编写一个日志包 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/14.html" class="sidebar-item" aria-label="第14节 Pflag、Viper、Cobra 核心功能介绍"><!--[--><!--]--> 第14节 Pflag、Viper、Cobra 核心功能介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/15.html" class="sidebar-item" aria-label="第15节 如何构建一个优秀的企业应用框架"><!--[--><!--]--> 第15节 如何构建一个优秀的企业应用框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/16.html" class="sidebar-item" aria-label="第16节 Gin 框架"><!--[--><!--]--> 第16节 Gin 框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/17.html" class="sidebar-item" aria-label="第17节 认证机制：应用程序如何进行访问认证？"><!--[--><!--]--> 第17节 认证机制：应用程序如何进行访问认证？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/18.html" class="sidebar-item" aria-label="第18节 IAM 项目认证"><!--[--><!--]--> 第18节 IAM 项目认证 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/19.html" class="sidebar-item" aria-label="第19节 权限模型：5大权限模型是如何进行资源授权的？"><!--[--><!--]--> 第19节 权限模型：5大权限模型是如何进行资源授权的？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/20.html" class="sidebar-item" aria-label="第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建"><!--[--><!--]--> 第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/21.html" class="sidebar-item" aria-label="第21节 控制流（下）：iam-apiserver服务核心功能实现讲解"><!--[--><!--]--> 第21节 控制流（下）：iam-apiserver服务核心功能实现讲解 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/22.html" class="sidebar-item" aria-label="第22节 ORM：CURD 神器 GORM 包介绍及实战"><!--[--><!--]--> 第22节 ORM：CURD 神器 GORM 包介绍及实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/23.html" class="sidebar-item" aria-label="第23节 数据流：通过iam-authz-server设计，看数据流服务的设计"><!--[--><!--]--> 第23节 数据流：通过iam-authz-server设计，看数据流服务的设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/24.html" class="sidebar-item" aria-label="第24节 数据处理：如何高效处理应用程序产生的数据？"><!--[--><!--]--> 第24节 数据处理：如何高效处理应用程序产生的数据？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/25.html" class="sidebar-item" aria-label="第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？"><!--[--><!--]--> 第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/26.html" class="sidebar-item" aria-label="第26节  SDK 设计（下）：IAM项目Go SDK设计和实现"><!--[--><!--]--> 第26节  SDK 设计（下）：IAM项目Go SDK设计和实现 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/27.html" class="sidebar-item" aria-label="第27节 效率神器：如何设计和实现一个命令行客户端工具？"><!--[--><!--]--> 第27节 效率神器：如何设计和实现一个命令行客户端工具？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/28.html" class="sidebar-item" aria-label="第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？"><!--[--><!--]--> 第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/29.html" class="sidebar-item" aria-label="第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍"><!--[--><!--]--> 第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/30.html" class="sidebar-item" aria-label="第30节 性能分析（上）：如何分析 Go 语言代码的性能？"><!--[--><!--]--> 第30节 性能分析（上）：如何分析 Go 语言代码的性能？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/31.html" class="sidebar-item" aria-label="第31节 性能分析（下）：API Server性能测试和调优实战"><!--[--><!--]--> 第31节 性能分析（下）：API Server性能测试和调优实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/32.html" class="sidebar-item" aria-label="第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍"><!--[--><!--]--> 第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/33.html" class="sidebar-item" aria-label="第33节 软件部署实战（中）：IAM 系统生产环境部署实战"><!--[--><!--]--> 第33节 软件部署实战（中）：IAM 系统生产环境部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/34.html" class="sidebar-item" aria-label="第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战"><!--[--><!--]--> 第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/35.html" class="sidebar-item" aria-label="第35节 技术演进（上）：虚拟化技术演进之路"><!--[--><!--]--> 第35节 技术演进（上）：虚拟化技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/36.html" class="sidebar-item" aria-label="第36节 技术演进（下）：软件架构和应用生命周期技术演进之路"><!--[--><!--]--> 第36节 技术演进（下）：软件架构和应用生命周期技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/37.html" class="sidebar-item" aria-label="第37节 基于Kubernetes的云原生架构设计"><!--[--><!--]--> 第37节 基于Kubernetes的云原生架构设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/38.html" class="sidebar-item" aria-label="第38节 如何制作Docker镜像？"><!--[--><!--]--> 第38节 如何制作Docker镜像？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/39.html" class="sidebar-item" aria-label="第39节 如何编写Kubernetes资源定义文件？"><!--[--><!--]--> 第39节 如何编写Kubernetes资源定义文件？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/40.html" class="sidebar-item" aria-label="第40节 IAM 容器化部署实战"><!--[--><!--]--> 第40节 IAM 容器化部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/41.html" class="sidebar-item" aria-label="第41节 服务编排（上）：Helm服务编排基础知识"><!--[--><!--]--> 第41节 服务编排（上）：Helm服务编排基础知识 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/42.html" class="sidebar-item" aria-label="第42节 服务编排（下）：基于Helm的服务编排部署实战"><!--[--><!--]--> 第42节 服务编排（下）：基于Helm的服务编排部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/43.html" class="sidebar-item" aria-label="第43节 基于 GitHub Actions 的 CI 实战"><!--[--><!--]--> 第43节 基于 GitHub Actions 的 CI 实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/44.html" class="sidebar-item" aria-label="第44节 可直接套用的 Go 编码规范"><!--[--><!--]--> 第44节 可直接套用的 Go 编码规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/45.html" class="sidebar-item" aria-label="第45节 Go Modules依赖包管理全讲"><!--[--><!--]--> 第45节 Go Modules依赖包管理全讲 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/46.html" class="sidebar-item" aria-label="第46节 IAM排障指南"><!--[--><!--]--> 第46节 IAM排障指南 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/47.html" class="sidebar-item" aria-label="第47节"><!--[--><!--]--> 第47节 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/48.html" class="sidebar-item" aria-label="第48节 分布式系统设计"><!--[--><!--]--> 第48节 分布式系统设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/49.html" class="sidebar-item" aria-label="第49节 如何从小白进阶成 Go 语言专家？"><!--[--><!--]--> 第49节 如何从小白进阶成 Go 语言专家？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/50.html" class="sidebar-item" aria-label="第50节"><!--[--><!--]--> 第50节 <!--[--><!--]--></a><!----></li><li><a class="external-link sidebar-item" href="https://nsddd.top/archives/contributors" rel="noopener noreferrer" target="_blank" aria-label="💝如何参与贡献？"><!--[--><!--]--> 💝如何参与贡献？ <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><ul><li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">🔥 开源地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h1 id="第2节-iam项目部署" tabindex="-1"><a class="header-anchor" href="#第2节-iam项目部署" aria-hidden="true">#</a> 第2节 IAM项目部署</h1><br><div><a href="1.md" style="float:left;">⬆️上一节🔗 </a><a href="3.md" style="float:right;"> ⬇️下一节🔗</a></div><br><blockquote><p>❤️💕💕During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><nav class="table-of-contents"><ul><li><a aria-current="page" href="/iam/projects/2.html#前言" class="router-link-active router-link-exact-active">前言</a></li><li><a aria-current="page" href="/iam/projects/2.html#基本开发环境" class="router-link-active router-link-exact-active">基本开发环境</a><ul><li><a aria-current="page" href="/iam/projects/2.html#用户权限" class="router-link-active router-link-exact-active">用户权限</a></li><li><a aria-current="page" href="/iam/projects/2.html#添加-sudoers" class="router-link-active router-link-exact-active">添加 sudoers</a></li><li><a aria-current="page" href="/iam/projects/2.html#配置-home-bashrc-文件" class="router-link-active router-link-exact-active">配置 $HOME/.bashrc 文件</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装-git" class="router-link-active router-link-exact-active">安装 git</a></li></ul></li><li><a aria-current="page" href="/iam/projects/2.html#go语言环境变量设置和含义" class="router-link-active router-link-exact-active">go语言环境变量设置和含义</a></li><li><a aria-current="page" href="/iam/projects/2.html#vim-go-plug" class="router-link-active router-link-exact-active">vim go-plug</a></li><li><a aria-current="page" href="/iam/projects/2.html#protobuf-编译环境安装" class="router-link-active router-link-exact-active">ProtoBuf 编译环境安装</a></li><li><a aria-current="page" href="/iam/projects/2.html#iam手动部署" class="router-link-active router-link-exact-active">IAM手动部署</a><ul><li><a aria-current="page" href="/iam/projects/2.html#下载项目代码" class="router-link-active router-link-exact-active">下载项目代码</a></li></ul></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置数据库" class="router-link-active router-link-exact-active">安装和配置数据库</a><ul><li><a aria-current="page" href="/iam/projects/2.html#mariadb" class="router-link-active router-link-exact-active">MariaDB</a></li><li><a aria-current="page" href="/iam/projects/2.html#redis" class="router-link-active router-link-exact-active">Redis</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-mariadb" class="router-link-active router-link-exact-active">安装和配置 MariaDB</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装redis" class="router-link-active router-link-exact-active">安装redis</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-mongodb" class="router-link-active router-link-exact-active">安装和配置 MongoDB</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-iam-系统" class="router-link-active router-link-exact-active">安装和配置 IAM 系统</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-iam-apiserver" class="router-link-active router-link-exact-active">安装和配置 iam-apiserver</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装-iamctl" class="router-link-active router-link-exact-active">安装 iamctl</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-iam-authz-server" class="router-link-active router-link-exact-active">安装和配置 iam-authz-server</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装和配置-iam-pump" class="router-link-active router-link-exact-active">安装和配置 iam-pump</a></li><li><a aria-current="page" href="/iam/projects/2.html#安装-man-文件" class="router-link-active router-link-exact-active">安装 man 文件</a></li></ul></li><li><a aria-current="page" href="/iam/projects/2.html#一键安装" class="router-link-active router-link-exact-active">一键安装</a></li><li><a aria-current="page" href="/iam/projects/2.html#总结" class="router-link-active router-link-exact-active">总结</a></li><li><a aria-current="page" href="/iam/projects/2.html#end-链接" class="router-link-active router-link-exact-active">END 链接</a></li></ul></nav><p>[TOC]</p><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><ul><li><p><a href="https://github.com/cubxxw/cs-awesome-Block_Chain" target="_blank" rel="noopener noreferrer">⭕ 📚 菜鸟成长手册🚀 CS系列 、云原生系列、区块链系列、web3系列🔥、Golang系列💡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://go.nsddd.top/" target="_blank" rel="noopener noreferrer">🚤 Go语言基础-进阶<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/TOC.md" target="_blank" rel="noopener noreferrer">🖱️GO 基础部分🔥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/Gomd_super/README.md" target="_blank" rel="noopener noreferrer">🖱️Go语言100篇进阶🔥<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://github.com/cubxxw/cs-awesome-Block_Chain/blob/master/go-advancend/README.md" target="_blank" rel="noopener noreferrer">🖱️Go 高级篇<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://docker.nsddd.top/" target="_blank" rel="noopener noreferrer">🚤 docker &amp; k8s &amp; 云原生<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>[x] <a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">IAM github地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>[x] <a href="https://time.geekbang.org/column/article/378082" target="_blank" rel="noopener noreferrer">课程地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul><h2 id="基本开发环境" tabindex="-1"><a class="header-anchor" href="#基本开发环境" aria-hidden="true">#</a> 基本开发环境</h2><p><strong>查看我的环境：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>root@cubmaster01:/<span class="token comment"># uname -va</span>
Linux cubmaster01 <span class="token number">5.4</span>.0-135-generic <span class="token comment">#152-Ubuntu SMP Wed Nov 23 20:19:22 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
root@cubmaster01:/<span class="token comment"># go version </span>
go version go1.19.3 linux/amd64
root@cubmaster01:/<span class="token comment"># git version</span>
<span class="token function">git</span> version <span class="token number">2.25</span>.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="用户权限" tabindex="-1"><a class="header-anchor" href="#用户权限" aria-hidden="true">#</a> 用户权限</h3><p>使用普通用户登录和操作开发机也可以保证系统的安全性，这是一个比较好的习惯，所以我们在日常开发中也要尽量避免使用 Root 用户。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>oot@cubmaster01:/<span class="token comment"># useradd cubiam</span>
root@cubmaster01:/<span class="token comment"># passwd cubiam</span>
New password: 
Retype new password: 
passwd: password updated successfully
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加-sudoers" tabindex="-1"><a class="header-anchor" href="#添加-sudoers" aria-hidden="true">#</a> 添加 sudoers</h3><p>普通用户也要用到 Root 的一些权限，但 Root 用户的密码一般是由系统管理员维护并定期更改的，每次都向管理员询问密码又很麻烦。因此，我建议你将普通用户加入到 sudoers 中，这样普通用户就可以通过 sudo 命令来暂时获取 Root 的权限。具体来说，你可以执行如下命令添加：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;/^root.*ALL=(ALL).*ALL/a\cubaim\tALL=(ALL) \tALL&#39;</span> /etc/sudoers
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="配置-home-bashrc-文件" tabindex="-1"><a class="header-anchor" href="#配置-home-bashrc-文件" aria-hidden="true">#</a> 配置 <code>$HOME/.bashrc</code> 文件</h3><p>我们登录新服务器后的第一步就是配置 <code>$HOME/.bashrc</code> 文件，以使 Linux 登录 shell 更加易用，例如配置 LANG 解决中文乱码，配置 PS1 可以避免整行都是文件路径，并将 <code>$HOME/bin</code> 加入到 PATH 路径中。配置后的内容如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># .bashrc</span>
 
<span class="token comment"># User specific aliases and functions</span>
<span class="token comment"># -i： 每次删除前提醒~</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">rm</span><span class="token operator">=</span><span class="token string">&#39;rm -i&#39;</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">cp</span><span class="token operator">=</span><span class="token string">&#39;cp -i&#39;</span>
<span class="token builtin class-name">alias</span> <span class="token assign-left variable">mv</span><span class="token operator">=</span><span class="token string">&#39;mv -i&#39;</span>
 
<span class="token comment"># Source global definitions</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> /etc/bashrc <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">.</span> /etc/bashrc
<span class="token keyword">fi</span>
 
<span class="token comment"># User specific environment</span>
<span class="token comment"># Basic envs</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span><span class="token string">&quot;en_US.UTF-8&quot;</span> <span class="token comment"># 设置系统语言为 en_US.UTF-8，避免终端出现中文乱码</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PS1</span></span><span class="token operator">=</span><span class="token string">&#39;[\u@dev \W]\$ &#39;</span> <span class="token comment"># 默认的 PS1 设置会展示全部的路径，为了防止过长，这里只展示：&quot;用户名@dev 最后的目录名&quot;</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">WORKSPACE</span><span class="token operator">=</span><span class="token string">&quot;<span class="token environment constant">$HOME</span>/workspace&quot;</span> <span class="token comment"># 设置工作目录</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$HOME</span>/bin:<span class="token environment constant">$PATH</span> <span class="token comment"># 将 $HOME/bin 目录加入到 PATH 变量中</span>
 
<span class="token comment"># Default entry folder</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$WORKSPACE</span> <span class="token comment"># 登录系统，默认进入 workspace 目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有一点需要我们注意，在 export PATH 时，最好把 <code>$PATH</code> 放到最后，因为我们添加到目录中的命令是期望被优先搜索并使用的。配置完 <code>$HOME/.bashrc</code> 后，我们还需要创建工作目录 workspace。将工作文件统一放在 <code>$HOME/workspace</code> 目录中，有几点好处。</p><ol><li>可以使我们的 <code>HOME</code>目录保持整洁，便于以后的文件查找和分类。</li><li>如果哪一天 /分区空间不足，可以将整个 workspace 目录 mv 到另一个分区中，并在 /分区中保留软连接，例如：/home/going/workspace -&gt; /data/workspace/。</li><li>如果哪天想备份所有的工作文件，可以直接备份 workspace。</li></ol><p>具体的操作指令是 <code>mkdir -p $HOME/workspace</code>。配置好 <code>HOME/.bashrc</code> 文件后，我们就可以执行 bash 命令将配置加载到当前 shell 中了。</p><h3 id="安装-git" tabindex="-1"><a class="header-anchor" href="#安装-git" aria-hidden="true">#</a> 安装 git</h3><p>因为安装 IAM 系统、执行 go get 命令、安装 protobuf 工具等都是通过 Git 来操作的，所以接下来我们还需要安装 Git。由于低版本的 Git 不支持 <code>--unshallow</code> 参数，而 go get 在安装 Go 包时会用到 <code>git fetch --unshallow</code> 命令，因此我们要确保安装一个高版本的 Git，具体的安装方法如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> /tmp
$ <span class="token function">wget</span> --no-check-certificate https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.39.0.tar.gz
$ <span class="token function">tar</span> <span class="token parameter variable">-xvzf</span> git-2.39.0.tar.gz
$ <span class="token builtin class-name">cd</span> git-2.39.0/
$ ./configure
$ <span class="token function">make</span>
$ <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
$ <span class="token function">git</span> <span class="token parameter variable">--version</span>          <span class="token comment"># 输出 git 版本号，说明安装成功</span>
<span class="token function">git</span> version <span class="token number">2.39</span>.0
<span class="token function">tee</span> <span class="token parameter variable">-a</span> <span class="token environment constant">$HOME</span>/.bashrc <span class="token operator">&lt;&lt;</span><span class="token string">&#39;EOF&#39;</span>
<span class="token comment"># Configure for git</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span>/usr/local/libexec/git-core:<span class="token variable">$PATHEOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>配置 Git。我们直接执行如下命令配置 Git</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> config <span class="token parameter variable">--global</span> user.name <span class="token string">&quot;Xinwei Xiong&quot;</span>    <span class="token comment"># 用户名改成自己的</span>
<span class="token function">git</span> config <span class="token parameter variable">--global</span> user.email <span class="token string">&quot;3293172751nss@gmail.com&quot;</span>    <span class="token comment"># 邮箱改成自己的</span>
<span class="token function">git</span> config <span class="token parameter variable">--global</span> credential.helper store    <span class="token comment"># 设置 Git，保存用户名和密码</span>
<span class="token function">git</span> config <span class="token parameter variable">--global</span> core.longpaths <span class="token boolean">true</span> <span class="token comment"># 解决 Git 中 &#39;Filename too long&#39; 的错误</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了按照上述步骤配置 Git 之外，我们还有几点需要注意。首先，在 Git 中，我们会把非 ASCII 字符叫做 Unusual 字符。这类字符在 Git 输出到终端的时候默认是用 8 进制转义字符输出的（以防乱码），但现在的终端多数都支持直接显示非 ASCII 字符，所以我们可以关闭掉这个特性，具体的命令如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> config <span class="token parameter variable">--global</span> core.quotepath off
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其次，GitHub 限制最大只能克隆 100M 的单个文件，为了能够克隆大于 100M 的文件，我们还需要安装 Git Large File Storage，安装方式如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> lfs <span class="token function">install</span> --skip-repo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="go语言环境变量设置和含义" tabindex="-1"><a class="header-anchor" href="#go语言环境变量设置和含义" aria-hidden="true">#</a> go语言环境变量设置和含义</h2><p><strong>我们在设置Go语言的环境变量：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">tee</span> <span class="token parameter variable">-a</span> <span class="token environment constant">$HOME</span>/.bashrc <span class="token operator">&lt;&lt;</span><span class="token string">&#39;EOF&#39;
# Go envs
export GOVERSION=go1.18.3 # Go 版本设置
export GO_INSTALL_DIR=$HOME/go # Go 安装目录
export GOROOT=$GO_INSTALL_DIR/$GOVERSION # GOROOT 设置
export GOPATH=$WORKSPACE/golang # GOPATH 设置
export PATH=$GOROOT/bin:$GOPATH/bin:$PATH # 将 Go 语言自带的和通过 go install 安装的二进制文件加入到 PATH 路径中
export GO111MODULE=&quot;on&quot; # 开启 Go moudles 特性
export GOPROXY=https://goproxy.cn,direct # 安装 Go 模块时，代理服务器设置
export GOPRIVATE=
export GOSUMDB=off # 关闭校验 Go 依赖包的哈希值
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为什么要增加这么多环境变量呢？这是因为，Go 语言是通过一系列的环境变量来控制 Go 编译器行为的。因此，我们一定要理解每一个环境变量的含义。</p><p><img src="http://sm.nsddd.top/sm202301152355839.png" alt="image-20230115235526661"></p><p>因为 Go 以后会用 Go modules 来管理依赖，所以我建议你将 GO111MODULE 设置为 on。</p><p>在使用模块的时候，<code>$GOPATH</code> 是无意义的，不过它还是会把下载的依赖储存在 <code>$GOPATH/pkg/mod</code> 目录中，也会把 go install 的二进制文件存放在 <code>$GOPATH/bin</code> 目录中。</p><p>另外，我们还要将 <code>$GOPATH/bin</code>、<code>$GOROOT/bin</code> 加入到 Linux 可执行文件搜索路径中。这样一来，我们就可以直接在 bash shell 中执行 go 自带的命令，以及通过 go install 安装的命令。</p><h2 id="vim-go-plug" tabindex="-1"><a class="header-anchor" href="#vim-go-plug" aria-hidden="true">#</a> vim go-plug</h2><p>安装：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>git clone <span class="token operator">--</span>depth<span class="token operator">=</span><span class="token number">1</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>fatih<span class="token operator">/</span>vim<span class="token operator">-</span><span class="token keyword">go</span><span class="token punctuation">.</span>git ~<span class="token operator">/</span><span class="token punctuation">.</span>vim<span class="token operator">/</span>pack<span class="token operator">/</span>plugins<span class="token operator">/</span>start<span class="token operator">/</span>vim<span class="token operator">-</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>vim-go 会用到一些 Go 工具，比如在函数跳转时会用到 guru、godef 工具，在格式化时会用到 goimports，所以你也需要安装这些工具。安装方式如下：执行 <code>vi /tmp/test.go</code>，然后输入 <code>:GoInstallBinaries</code> 安装 vim-go 需要的工具。安装后的 Go IDE 常用操作的按键映射如下表所示：</p><p><img src="http://sm.nsddd.top/sm202301161958824.png" alt="image-20230116195849590"></p><h2 id="protobuf-编译环境安装" tabindex="-1"><a class="header-anchor" href="#protobuf-编译环境安装" aria-hidden="true">#</a> ProtoBuf 编译环境安装</h2><p>接着，我们再来安装 <code>protobuf</code> 的编译器 <code>protoc</code>。<code>protoc</code> 需要 <code>protoc-gen-go</code> 来完成 Go 语言的代码转换，因此我们需要安装 <code>protoc</code> 和 <code>protoc-gen-go</code> 这 2 个工具。它们的安装方法比较简单，你直接看我下面给出的代码和操作注释就可以了。</p><blockquote><p>Protocol Buffers（缩写为 protobuf）是 Google 开发的一种数据交换格式。它是一种结构化数据存储格式，可用于结构化数据串行化，或者说把数据从程序中“变成”字节流，又可以把字节流重新“变成”程序中的数据。由于 protobuf 是跨语言的，所以它可以被多种语言的程序使用。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 第一步：安装 protobuf</span>
$ <span class="token builtin class-name">cd</span> /tmp/
$ <span class="token function">git</span> clone <span class="token parameter variable">-b</span> v3.21.1 <span class="token parameter variable">--depth</span><span class="token operator">=</span><span class="token number">1</span> https://github.com/protocolbuffers/protobuf
$ <span class="token builtin class-name">cd</span> protobuf
$ ./autogen.sh
$ ./configure
$ <span class="token function">make</span>
$ <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>
$ protoc <span class="token parameter variable">--version</span> <span class="token comment"># 查看 protoc 版本，成功输出版本号，说明安装成功</span>
libprotoc <span class="token number">3.21</span>.1

<span class="token comment"># 第二步：安装 protoc-gen-go</span>
$ go <span class="token function">install</span> github.com/golang/protobuf/protoc-gen-go@v1.5.2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="iam手动部署" tabindex="-1"><a class="header-anchor" href="#iam手动部署" aria-hidden="true">#</a> IAM手动部署</h2><blockquote><p>和Kubernetes一样，可以支持手动部署和自动部署。</p></blockquote><p>IAM 系统是一个企业级的项目，有一定的复杂度，安装的话需要小心~</p><p><strong>部署的步骤：</strong></p><ol><li>安装和配置数据库：我们需要安装和配置 MariaDB、Redis 和 MongoDB。</li><li>安装和配置 IAM 服务：我们需要安装和配置 iam-apiserver、iam-authz-server、iam-pump、iamctl 和 man 文件。</li></ol><blockquote><p>有的人直接将整个环境打包了：</p><p>我自己是在 docker 容器中部署的，我把项目部署好的容器打包上传了，有需要的同学可以直接拉下来用（<code>docker pull mjcjm/centos-go-project</code>），启动参数一定要用：<code>docker run -tid --name</code> 容器名称 <code>-v /sys/fs/cgroup:/sys/fs/cgroup --privileged=true</code> 镜像 <code>id /usr/sbin/init</code>。</p></blockquote><h3 id="下载项目代码" tabindex="-1"><a class="header-anchor" href="#下载项目代码" aria-hidden="true">#</a> 下载项目代码</h3><p>因为 IAM 的安装脚本存放在 iam 代码仓库中，安装需要的二进制文件也需要通过 iam 代码构建，所以在安装之前，我们需要先下载 iam 代码：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$WORKSPACE</span>
$ <span class="token function">git</span> clone https://github.com/cubxxw/iam.git
$ go work use ./iam
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>设置别名和环境变量：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">tee</span> <span class="token parameter variable">-a</span> <span class="token environment constant">$HOME</span>/.bashrc <span class="token operator">&lt;&lt;</span> <span class="token string">&#39;EOF&#39;
# Alias for quick access
export GOSRC=&quot;$WORKSPACE/&quot;
export IAM_ROOT=&quot;$HOME/workspces/iam&quot;
alias mm=&quot;cd $HOME/workspces&quot;
alias i=&quot;cd $HOME/workspces/iam&quot;
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在安装配置IAM系统之前需要你执行以下命令export <code>going</code> 用户的密码，这里假设密码是 <code>iam59!z$</code>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">LINUX_PASSWORD</span><span class="token operator">=</span><span class="token string">&#39;iam59!z$&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在项目开发中，像密码、密钥 Key 这类敏感信息，一般不会直接硬编码在系统中，而是通过环境变量的方式来使用。现网应用的配置文件是存放在一个安全的网络环境中，并且有访问授权流程，比较安全，这种配置文件中是可以配置密码等敏感信息的。</p><h2 id="安装和配置数据库" tabindex="-1"><a class="header-anchor" href="#安装和配置数据库" aria-hidden="true">#</a> 安装和配置数据库</h2><p>因为 IAM 系统用到了 MariaDB、Redis、MongoDB 数据库来存储数据，而 IAM 服务在启动时会先尝试连接这些数据库，所以为了避免启动时连接数据库失败，这里我们先来安装需要的数据库。</p><h3 id="mariadb" tabindex="-1"><a class="header-anchor" href="#mariadb" aria-hidden="true">#</a> MariaDB</h3><p><strong>mysql:</strong></p><blockquote><p>IAM 会把 REST 资源的定义信息存储在关系型数据库中，关系型数据库我选择了 MariaDB。为啥选择 MariaDB，而不是 MySQL 呢？。选择 MariaDB 一方面是因为它是发展最快的 MySQL 分支，相比 MySQL，它加入了很多新的特性，并且它能够完全兼容 MySQL，包括 API 和命令行。另一方面是因为 MariaDB 是开源的，而且迭代速度很快。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
./scripts/install/mariadb.sh iam::mariadb::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="redis" tabindex="-1"><a class="header-anchor" href="#redis" aria-hidden="true">#</a> Redis</h3><p>在 IAM 系统中，由于 iam-authz-server 是从 iam-apiserver 拉取并缓存用户的密钥 / 策略信息的，因此同一份密钥 / 策略数据会分别存在 2 个服务中，这可能会出现数据不一致的情况。数据不一致会带来一些问题，例如当我们通过 iam-apiserver 创建了一对密钥，但是这对密钥还没有被 iam-authz-server 缓存，这时候通过这对密钥访问 iam-authz-server 就会访问失败。</p><p>为了保证数据的一致性，我们可以使用 Redis 的发布订阅 (pub/sub) 功能进行消息通知。同时，iam-authz-server 也会将授权审计日志缓存到 Redis 中，所以也需要安装 Redis key-value 数据库。我们可以通过以下命令来安装和配置 Redis，并将 Redis 的初始密码设置为 <code>iam59!z$</code> ：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/install/redis.sh iam::redis::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们要注意，scripts/install/redis.sh 脚本中 iam::redis::install 函数对 Redis 做了一些配置，例如修改 Redis 使其以守护进程的方式运行、修改 Redis 的密码为 <code>iam59!z$</code>等，详细配置可参考函数 <code>iam::redis::install</code> 函数。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code> $ redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token string">&#39;iam59!z$&#39;</span> <span class="token comment"># 连接 Redis，-h 指定主机，-p 指定监听端口，-a 指定登录密码</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="安装和配置-mariadb" tabindex="-1"><a class="header-anchor" href="#安装和配置-mariadb" aria-hidden="true">#</a> 安装和配置 MariaDB</h3><ul><li><a href="https://github.com/MariaDB/server" target="_blank" rel="noopener noreferrer">开源的 GitHub 地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><p>IAM 会把 REST 资源的定义信息存储在关系型数据库中，关系型数据库我选择了 MariaDB。为啥选择 MariaDB，而不是 MySQL 呢？。选择 MariaDB 一方面是因为它是发展最快的 MySQL 分支，相比 MySQL，它加入了很多新的特性，并且它能够完全兼容 MySQL，包括 API 和命令行。另一方面是因为 MariaDB 是开源的，而且迭代速度很快。首先，我们可以通过以下命令安装和配置 MariaDB，并将 Root 密码设置为 <code>1234</code>：</p><blockquote><p>MariaDB vs Mysql:</p><p>MariaDB是一种关系型数据库管理系统，是MySQL的一个分支。两者在技术上基本相同，但MariaDB有一些额外的特性和功能。</p><p>一个明显的区别是MariaDB是一个开源项目，而MySQL是Oracle公司拥有和维护。</p><p>MariaDB还添加了一些新特性，如支持更高版本的SQL标准和更好的性能，还有一些安全性增强。</p><p>但是, 一般来说，MariaDB和MySQL的性能相当接近，因为它们使用相同的存储引擎。</p><p>在一些情况下，MariaDB可能会更快，因为它有一些额外的优化和特性，例如更新的SQL解析器和更快的查询优化器。</p><p>另外, 也有一些测试结果表明MariaDB的性能比MySQL更优秀，但是这取决于具体的场景和使用方式。</p><p>对于开发人员来说，两者的语法和API几乎相同，所以从MySQL迁移到MariaDB是非常简单的。</p><p>总的来说，MariaDB是MySQL的一个很好的替代品，它在继承了MySQL的优秀特性的同时，还添加了许多新功能。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span><span class="token punctuation">;</span> ./scripts/install/mariadb.sh iam::mariadb::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="安装redis" tabindex="-1"><a class="header-anchor" href="#安装redis" aria-hidden="true">#</a> 安装redis</h3><p>在 IAM 系统中，由于 iam-authz-server 是从 iam-apiserver 拉取并缓存用户的密钥/策略信息的，因此同一份密钥/策略数据会分别存在 2 个服务中，这可能会出现数据不一致的情况。数据不一致会带来一些问题，例如当我们通过 iam-apiserver 创建了一对密钥，但是这对密钥还没有被 iam-authz-server 缓存，这时候通过这对密钥访问 iam-authz-server 就会访问失败。</p><p>为了保证数据的一致性，我们可以使用 Redis 的发布订阅(pub/sub)功能进行消息通知。同时，iam-authz-server 也会将授权审计日志缓存到 Redis 中，所以也需要安装 Redis key-value 数据库。我们可以通过以下命令来安装和配置 Redis，并将 Redis 的初始密码设置为 <code>iam59!z$</code> ：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>$ ./scripts/install/redis.sh iam::redis::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里我们要注意，scripts/install/redis.sh 脚本中 iam::redis::install 函数对 Redis 做了一些配置，例如修改 Redis 使其以守护进程的方式运行、修改 Redis 的密码为 <code>iam59!z$</code>等，详细配置可参考函数 <a href="https://github.com/marmotedu/iam/blob/v1.0.0/scripts/install/redis.sh#L20" target="_blank" rel="noopener noreferrer">iam::redis::install<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 函数。</p><p>安装完成后，我们可以通过以下命令，来测试 Redis 是否安装成功：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">6379</span> <span class="token parameter variable">-a</span> <span class="token string">&#39;iam59!z$&#39;</span> 
<span class="token comment"># 连接 Redis，-h 指定主机，-p 指定监听端口，-a 指定登录密码</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装和配置-mongodb" tabindex="-1"><a class="header-anchor" href="#安装和配置-mongodb" aria-hidden="true">#</a> 安装和配置 MongoDB</h3><p>因为 iam-pump 会将 iam-authz-server 产生的数据处理后存储在 MongoDB 中，所以我们也需要安装 MongoDB 数据库。主要分两步安装：</p><ol><li>首先安装 MongoDB</li><li>然后再创建 MongoDB 账号</li></ol><h4 id="第-1-步-安装-mongodb" tabindex="-1"><a class="header-anchor" href="#第-1-步-安装-mongodb" aria-hidden="true">#</a> 第 1 步，安装 MongoDB</h4><p>首先，我们可以通过以下 4 步来安装 MongoDB。</p><p><strong>配置 MongoDB yum 源，并安装 MongoDB。</strong></p><p>CentOS8.x 系统默认没有配置安装 MongoDB 需要的 yum 源，所以我们需要先配置好 yum 源再安装：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/mongodb-org-5.0.repo<span class="token operator">&lt;&lt;</span><span class="token string">&#39;EOF&#39;
[mongodb-org-5.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/5.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
EOF</span>
 
$ <span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> mongodb-org
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>关闭 SELinux</strong>。</p><p>在安装的过程中，SELinux 有可能会阻止 MongoDB 访问 <code>/sys/fs/cgroup</code>，所以我们还需要关闭 SELinux：</p><blockquote><p>SELinux(Security-Enhanced Linux 或 Security-Enhanced Linux)是一种安全控制机制，由NSA公司开发，可以在Linux系统上提供更强大的安全性。它使用标签来区分操作系统上的文件和目录，并且可以在系统上实施特定的安全策略，以确保系统的安全。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> setenforce <span class="token number">0</span>
$ <span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;s/^SELINUX=.*$/SELINUX=disabled/&#39;</span> /etc/selinux/config <span class="token comment"># 永久关闭 SELINUX</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>开启外网访问权限和登录验证</strong>。</p><p>MongoDB 安装完之后，默认情况下是不会开启外网访问权限和登录验证，为了方便使用，我建议你先开启这些功能，执行如下命令开启：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;/bindIp/{s/127.0.0.1/0.0.0.0/}&#39;</span> /etc/mongod.conf
$ <span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">&#39;/^#security/a\security:\n  authorization: enabled&#39;</span> /etc/mongod.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动 MongoDB。</strong></p><p>配置完 MongoDB 之后，我们就可以启动它了，具体的命令如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl start mongod
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> mongod <span class="token comment"># 设置开机启动</span>
$ <span class="token function">sudo</span> systemctl status mongod <span class="token comment"># 查看 mongod 运行状态，如果输出中包含 active (running)字样说明 mongod 成功启动</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>安装完 MongoDB 后，我们就可以通过 <code>mongo</code> 命令登录 MongoDB Shell。如果没有报错，就说明 MongoDB 被成功安装了。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>mongosh <span class="token parameter variable">--quiet</span> &quot;mongodb://127.0.0.1:27017<span class="token operator">&amp;</span>quot
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="第-2-步-创建-mongodb-账号" tabindex="-1"><a class="header-anchor" href="#第-2-步-创建-mongodb-账号" aria-hidden="true">#</a> 第 2 步，创建 MongoDB 账号</h4><p>安装完 MongoDB 之后，默认是没有用户账号的，为了方便 IAM 服务使用，我们需要先创建好管理员账号，通过管理员账户登录 MongoDB，我们可以执行创建普通用户、数据库等操作。</p><p><strong>创建管理员账户</strong>。</p><p>首先，我们通过 <code>use admin</code> 指令切换到 admin 数据库，再通过 <code>db.auth(&quot;用户名&quot;，&quot;用户密码&quot;)</code> 验证用户登录权限。如果返回 1 表示验证成功；如果返回 0 表示验证失败。具体的命令如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ mongosh <span class="token parameter variable">--quiet</span> <span class="token string">&quot;mongodb://127.0.0.1:27017&quot;</span>
test<span class="token operator">&gt;</span> use admin 
switched to db admin
admin<span class="token operator">&gt;</span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;root&quot;</span>,pwd:<span class="token string">&quot;iam59!z$&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> ok: <span class="token number">1</span> <span class="token punctuation">}</span>
admin<span class="token operator">&gt;</span> db.auth<span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span>, <span class="token string">&quot;iam59!z$&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> ok: <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>此外，如果想删除用户，可以使用 <code>db.dropUser(&quot;用户名&quot;)</code> 命令。</p><p><code>db.createUser</code> 用到了以下 3 个参数。</p><ul><li>user: 用户名。</li><li>pwd: 用户密码。</li><li>roles: 用来设置用户的权限，比如读、读写、写等。</li></ul><p>因为 admin 用户具有 MongoDB 的 Root 权限，权限过大安全性会降低。为了提高安全性，我们还需要创建一个 iam 普通用户来连接和操作 MongoDB。</p><ol><li>创建 iam 用户，命令如下：</li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ mongosh <span class="token parameter variable">--quiet</span> mongodb://root:<span class="token string">&#39;iam59!z$&#39;</span>@127.0.0.1:27017/iam_analytics?authSource<span class="token operator">=</span>admin <span class="token comment"># 用管理员账户连接 MongoDB</span>
iam_analytics<span class="token operator">&gt;</span> db.createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;iam&quot;</span>,pwd:<span class="token string">&quot;iam59!z$&quot;</span>,roles:<span class="token punctuation">[</span><span class="token string">&quot;dbOwner&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> ok: <span class="token number">1</span> <span class="token punctuation">}</span>
iam_analytics<span class="token operator">&gt;</span> db.auth<span class="token punctuation">(</span><span class="token string">&quot;iam&quot;</span>, <span class="token string">&quot;iam59!z$&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> ok: <span class="token number">1</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建完 iam 普通用户后，我们就可以通过 iam 用户登录 MongoDB 了：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ mongosh <span class="token parameter variable">--quiet</span> mongodb://iam:<span class="token string">&#39;iam59!z$&#39;</span>@127.0.0.1:27017/iam_analytics?authSource<span class="token operator">=</span>iam_analytics
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>至此，我们成功安装了 IAM 系统需要的数据库 MariaDB、Redis 和 MongoDB。</p><h3 id="安装和配置-iam-系统" tabindex="-1"><a class="header-anchor" href="#安装和配置-iam-系统" aria-hidden="true">#</a> 安装和配置 IAM 系统</h3><p>要想完成 IAM 系统的安装，我们还需要安装和配置 iam-apiserver、iam-authz-server、iam-pump 和 iamctl。这些组件的功能我们在<a href="https://time.geekbang.org/column/article/377998" target="_blank" rel="noopener noreferrer">第1讲<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>详细讲过，如果不记得你可以翻回去看看。</p><blockquote><p>提示：IAM 项目我会长期维护、定期更新，欢迎你 Star &amp; Contributing。</p></blockquote><p><strong>准备工作：</strong></p><p>在开始安装之前，我们需要先做一些准备工作，主要有 5 步。</p><ol><li>初始化 MariaDB 数据库，创建 iam 数据库。</li><li>配置 scripts/install/environment.sh。</li><li>创建需要的目录。</li><li>创建 CA 根证书和密钥。</li><li>配置 hosts。</li></ol><h4 id="第-1-步-初始化-mariadb-数据库-创建-iam-数据库。" tabindex="-1"><a class="header-anchor" href="#第-1-步-初始化-mariadb-数据库-创建-iam-数据库。" aria-hidden="true">#</a> 第 1 步，初始化 MariaDB 数据库，创建 iam 数据库。</h4><p>安装完 MariaDB 数据库之后，我们需要在 MariaDB 数据库中创建 IAM 系统需要的数据库、表和存储过程，以及创建 SQL 语句保存在 IAM 代码仓库中的 <code>configs/iam.sql</code> 文件中。具体的创建步骤如下。</p><p><strong>登录数据库并创建 iam 用户。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ mysql <span class="token parameter variable">-h127.0.0.1</span> <span class="token parameter variable">-P3306</span> <span class="token parameter variable">-uroot</span> -p<span class="token string">&#39;iam59!z$&#39;</span> <span class="token comment"># 连接 MariaDB，-h 指定主机，-P 指定监听端口，-u 指定登录用户，-p 指定登录密码</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> grant all on iam.* TO iam@127.0.0.1 identified by <span class="token string">&#39;iam59!z$&#39;</span><span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> flush privileges<span class="token punctuation">;</span>
Query OK, <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>用 iam 用户登录 MariaDB，执行 iam.sql 文件，创建 iam 数据库。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ mysql <span class="token parameter variable">-h127.0.0.1</span> <span class="token parameter variable">-P3306</span> <span class="token parameter variable">-uiam</span> -p<span class="token string">&#39;iam59!z$&#39;</span>
MariaDB <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token builtin class-name">source</span> configs/iam.sql<span class="token punctuation">;</span>
MariaDB <span class="token punctuation">[</span>iam<span class="token punctuation">]</span><span class="token operator">&gt;</span> show databases<span class="token punctuation">;</span>
+--------------------+
<span class="token operator">|</span> Database           <span class="token operator">|</span>
+--------------------+
<span class="token operator">|</span> iam                <span class="token operator">|</span>
<span class="token operator">|</span> information_schema <span class="token operator">|</span>
+--------------------+
<span class="token number">2</span> rows <span class="token keyword">in</span> <span class="token builtin class-name">set</span> <span class="token punctuation">(</span><span class="token number">0.000</span> sec<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的命令会创建 iam 数据库，并创建以下数据库资源。</p><ul><li>表： <ul><li>user 是用户表，用来存放用户信息；</li><li>secret 是密钥表，用来存放密钥信息；</li><li>policy 是策略表，用来存放授权策略信息；</li><li>policy_audit 是策略历史表，被删除的策略会被转存到该表。</li></ul></li><li>admin 用户：在 user 表中，我们需要创建一个管理员用户，用户名是 admin，密码是 <code>Admin@2021</code>。</li><li>存储过程：删除用户时会自动删除该用户所属的密钥和策略信息。</li></ul><h4 id="第-2-步-配置-scripts-install-environment-sh。" tabindex="-1"><a class="header-anchor" href="#第-2-步-配置-scripts-install-environment-sh。" aria-hidden="true">#</a> 第 2 步，配置 scripts/install/environment.sh。</h4><p>IAM 组件的安装配置都是通过环境变量文件 <a href="scripts/install/environment.sh">scripts/install/environment.sh</a> 进行配置的，所以我们要先配置好 scripts/install/environment.sh 文件。这里，你可以直接使用默认值，提高你的安装效率。</p><h4 id="第-3-步-创建需要的目录。" tabindex="-1"><a class="header-anchor" href="#第-3-步-创建需要的目录。" aria-hidden="true">#</a> 第 3 步，创建需要的目录。</h4><p>在安装和运行 IAM 系统的时候，我们需要将配置、二进制文件和数据文件存放到指定的目录。所以我们需要先创建好这些目录，创建步骤如下。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${IAM_DATA_DIR}</span>/<span class="token punctuation">{</span>iam-apiserver,iam-authz-server,iam-pump<span class="token punctuation">}</span> <span class="token comment"># 创建 Systemd WorkingDirectory 目录</span>
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${IAM_INSTALL_DIR}</span>/bin <span class="token comment">#创建 IAM 系统安装目录</span>
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${IAM_CONFIG_DIR}</span>/cert <span class="token comment"># 创建 IAM 系统配置文件存放目录</span>
$ <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${IAM_LOG_DIR}</span> <span class="token comment"># 创建 IAM 日志文件存放目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-4-步-创建-ca-根证书和密钥。" tabindex="-1"><a class="header-anchor" href="#第-4-步-创建-ca-根证书和密钥。" aria-hidden="true">#</a> 第 4 步， 创建 CA 根证书和密钥。</h4><p>为了确保安全，IAM 系统各组件需要使用 x509 证书对通信进行加密和认证。所以，这里我们需要先创建 CA 证书。CA 根证书是所有组件共享的，只需要创建一个 CA 证书，后续创建的所有证书都由它签名。</p><p>我们可以使用 CloudFlare 的 PKI 工具集 cfssl 来创建所有的证书。</p><p><strong>安装 cfssl 工具集。</strong></p><p>我们可以直接安装 cfssl 已经编译好的二进制文件，cfssl 工具集中包含很多工具，这里我们需要安装 cfssl、cfssljson、cfssl-certinfo，功能如下。</p><ol><li>cfssl：证书签发工具。</li><li>cfssljson：将 cfssl 生成的证书（json 格式）变为文件承载式证书。</li></ol><p>这两个工具的安装方法如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/install/install.sh iam::install::install_cfssl
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建配置文件。</strong></p><p>CA 配置文件是用来配置根证书的使用场景 (profile) 和具体参数 (usage、过期时间、服务端认证、客户端认证、加密等)，可以在签名其它证书时用来指定特定场景：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token function">tee</span> ca-config.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  &quot;signing&quot;: {
    &quot;default&quot;: {
      &quot;expiry&quot;: &quot;87600h&quot;
    },
    &quot;profiles&quot;: {
      &quot;iam&quot;: {
        &quot;usages&quot;: [
          &quot;signing&quot;,
          &quot;key encipherment&quot;,
          &quot;server auth&quot;,
          &quot;client auth&quot;
        ],
        &quot;expiry&quot;: &quot;876000h&quot;
      }
    }
  }
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的 JSON 配置中，有一些字段解释如下。</p><ul><li>signing：表示该证书可用于签名其它证书（生成的 ca.pem 证书中 CA=TRUE）。</li><li>server auth：表示 client 可以用该证书对 server 提供的证书进行验证。</li><li>client auth：表示 server 可以用该证书对 client 提供的证书进行验证。</li><li>expiry：876000h，证书有效期设置为 100 年。</li></ul><p><strong>创建证书签名请求文件。</strong></p><p>我们创建用来生成 CA 证书签名请求（CSR）的 JSON 配置文件：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token function">tee</span> ca-csr.json <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
{
  &quot;CN&quot;: &quot;iam-ca&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;marmotedu&quot;,
      &quot;OU&quot;: &quot;iam&quot;
    }
  ],
  &quot;ca&quot;: {
    &quot;expiry&quot;: &quot;876000h&quot;
  }
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>上面的 JSON 配置中，有一些字段解释如下。</strong></p><ul><li>C：Country，国家。</li><li>ST：State，省份。</li><li>L：Locality (L) or City，城市。</li><li>CN：Common Name，iam-apiserver 从证书中提取该字段作为请求的用户名 (User Name) ，浏览器使用该字段验证网站是否合法。</li><li>O：Organization，iam-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)。</li><li>OU：Company division (or Organization Unit – OU)，部门 / 单位。</li></ul><p>除此之外，还有两点需要我们注意。</p><ul><li>不同证书 csr 文件的 CN、C、ST、L、O、OU 组合必须不同，否则可能出现 PEER&#39;S CERTIFICATE HAS AN INVALID SIGNATURE 错误。</li><li>后续创建证书的 csr 文件时，CN、OU 都不相同（C、ST、L、O 相同），以达到区分的目的。</li><li>创建 CA 证书和私钥</li></ul><p>首先，我们通过 cfssl gencert 命令来创建：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ cfssl gencert <span class="token parameter variable">-initca</span> ca-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> ca
$ <span class="token function">ls</span> ca*
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
$ <span class="token function">sudo</span> <span class="token function">mv</span> ca* <span class="token variable">${IAM_CONFIG_DIR}</span>/cert <span class="token comment"># 需要将证书文件拷贝到指定文件夹下（分发证书），方便各组件引用</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上述命令会创建运行 CA 所必需的文件 ca-key.pem（私钥）和 ca.pem（证书），还会生成 ca.csr（证书签名请求），用于交叉签名或重新签名。</p><p>创建完之后，我们可以通过 cfssl certinfo 命名查看 cert 和 csr 信息：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ cfssl certinfo <span class="token parameter variable">-cert</span> <span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca.pem <span class="token comment"># 查看 cert(证书信息)</span>
$ cfssl certinfo <span class="token parameter variable">-csr</span> <span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca.csr <span class="token comment"># 查看 CSR(证书签名请求)信息</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-5-步-配置-hosts。" tabindex="-1"><a class="header-anchor" href="#第-5-步-配置-hosts。" aria-hidden="true">#</a> 第 5 步，配置 hosts。</h4><p>iam 通过域名访问 API 接口，因为这些域名没有注册过，还不能在互联网上解析，所以需要配置 hosts，具体的操作如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
127.0.0.1 iam.api.marmotedu.com
127.0.0.1 iam.authz.marmotedu.com
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装和配置-iam-apiserver" tabindex="-1"><a class="header-anchor" href="#安装和配置-iam-apiserver" aria-hidden="true">#</a> 安装和配置 iam-apiserver</h3><p>完成了准备工作之后，我们就可以安装 IAM 系统的各个组件了。首先我们通过以下 3 步来安装 iam-apiserver 服务。</p><h4 id="第-1-步-创建-iam-apiserver-证书和私钥。" tabindex="-1"><a class="header-anchor" href="#第-1-步-创建-iam-apiserver-证书和私钥。" aria-hidden="true">#</a> 第 1 步，创建 iam-apiserver 证书和私钥。</h4><p>其它服务为了安全都是通过 HTTPS 协议访问 iam-apiserver，所以我们要先创建 iam-apiserver 证书和私钥。</p><p><strong>创建证书签名请求</strong>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">tee</span> iam-apiserver-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;iam-apiserver&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;marmotedu&quot;,
      &quot;OU&quot;: &quot;iam-apiserver&quot;
    }
  ],
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;localhost&quot;,
    &quot;iam.api.marmotedu.com&quot;
  ]
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码中的 hosts 字段是用来指定授权使用该证书的 IP 和域名列表，上面的 hosts 列出了 iam-apiserver 服务的 IP 和域名。</p><p><strong>生成证书和私钥</strong>：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca.pem <span class="token punctuation">\</span>
  -ca-key<span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-key.pem <span class="token punctuation">\</span>
  <span class="token parameter variable">-config</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-config.json <span class="token punctuation">\</span>
  <span class="token parameter variable">-profile</span><span class="token operator">=</span>iam iam-apiserver-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> iam-apiserver
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-apiserver*pem <span class="token variable">${IAM_CONFIG_DIR}</span>/cert 
<span class="token comment"># 将生成的证书和私钥文件拷贝到配置文件目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-2-步-安装并运行-iam-apiserver。" tabindex="-1"><a class="header-anchor" href="#第-2-步-安装并运行-iam-apiserver。" aria-hidden="true">#</a> 第 2 步，安装并运行 iam-apiserver。</h4><p>iam-apiserver 作为 iam 系统的核心组件，需要第一个安装。</p><p><strong>安装 iam-apiserver 可执行程序：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">make</span> build <span class="token assign-left variable">BINS</span><span class="token operator">=</span>iam-apiserver
$ <span class="token function">sudo</span> <span class="token function">cp</span> _output/platforms/linux/amd64/iam-apiserver <span class="token variable">${IAM_INSTALL_DIR}</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成并安装 iam-apiserver 的配置文件（iam-apiserver.yaml）：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-apiserver.yaml <span class="token operator">&gt;</span> iam-apiserver.yaml
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-apiserver.yaml <span class="token variable">${IAM_CONFIG_DIR}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建并安装 iam-apiserver systemd unit 文件：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-apiserver.service <span class="token operator">&gt;</span> iam-apiserver.service
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-apiserver.service /etc/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动 iam-apiserver 服务：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl daemon-reload
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> iam-apiserver
$ <span class="token function">sudo</span> systemctl restart iam-apiserver
$ systemctl status iam-apiserver <span class="token comment"># 查看 iam-apiserver 运行状态，如果输出中包含 active (running)字样说明 iam-apiserver 成功启动</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-3-步-测试-iam-apiserver-是否成功安装。" tabindex="-1"><a class="header-anchor" href="#第-3-步-测试-iam-apiserver-是否成功安装。" aria-hidden="true">#</a> 第 3 步，测试 iam-apiserver 是否成功安装。</h4><p>测试 iam-apiserver 主要是测试 RESTful 资源的 CURD：<strong>用户 CURD、密钥 CURD、授权策略 CURD。</strong></p><p>首先，我们需要获取访问 iam-apiserver 的 Token，请求如下 API 访问：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -d<span class="token string">&#39;{&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;Admin@2021&quot;}&#39;</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>代码中下面的 HTTP 请求通过<code>-H&#39;Authorization: Bearer &lt;Token&gt;&#39;</code> 指定认证头信息，将上面请求的 Token 替换 <code>&lt;Token&gt;</code> 。</p><p><strong>用户 CURD:</strong></p><p>创建用户、列出用户、获取用户详细信息、修改用户、删除单个用户、批量删除用户，请求方法如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建用户</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;password&quot;:&quot;User@2021&quot;,&quot;metadata&quot;:{&quot;name&quot;:&quot;colin&quot;},&quot;nickname&quot;:&quot;colin&quot;,&quot;email&quot;:&quot;colin@foxmail.com&quot;,&quot;phone&quot;:&quot;1812884xxxx&quot;}&#39;</span> http://127.0.0.1:8080/v1/users

<span class="token comment"># 列出用户</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> <span class="token string">&#39;http://127.0.0.1:8080/v1/users?offset=0&amp;limit=10&#39;</span>

<span class="token comment"># 获取 colin 用户的详细信息</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/users/colin

<span class="token comment"># 修改 colin 用户</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPUT</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;nickname&quot;:&quot;colin&quot;,&quot;email&quot;:&quot;colin_modified@foxmail.com&quot;,&quot;phone&quot;:&quot;1867274xxxx&quot;}&#39;</span> http://127.0.0.1:8080/v1/users/colin

<span class="token comment"># 删除 colin 用户</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XDELETE</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/users/colin

<span class="token comment"># 批量删除用户</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XDELETE</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> <span class="token string">&#39;http://127.0.0.1:8080/v1/users?name=colin&amp;name=mark&amp;name=john&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>密钥 CURD:</strong></p><p>创建密钥、列出密钥、获取密钥详细信息、修改密钥、删除密钥请求方法如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
<span class="token comment"># 创建 secret0 密钥</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;secret0&quot;},&quot;expires&quot;:0,&quot;description&quot;:&quot;admin secret&quot;}&#39;</span> http://127.0.0.1:8080/v1/secrets

<span class="token comment"># 列出所有密钥</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/secrets

<span class="token comment"># 获取 secret0 密钥的详细信息</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/secrets/secret0

<span class="token comment"># 修改 secret0 密钥</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPUT</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;secret0&quot;},&quot;expires&quot;:0,&quot;description&quot;:&quot;admin secret(modified)&quot;}&#39;</span> http://127.0.0.1:8080/v1/secrets/secret0

<span class="token comment"># 删除 secret0 密钥</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XDELETE</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/secrets/secret0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里我们要注意，因为密钥属于重要资源，被删除会导致所有的访问请求失败，所以密钥不支持批量删除。</p><p><strong>授权策略 CURD:</strong></p><p>创建策略、列出策略、获取策略详细信息、修改策略、删除策略请求方法如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建策略</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;policy0&quot;},&quot;policy&quot;:{&quot;description&quot;:&quot;One policy to rule them all.&quot;,&quot;subjects&quot;:[&quot;users:&lt;peter|ken&gt;&quot;,&quot;users:maria&quot;,&quot;groups:admins&quot;],&quot;actions&quot;:[&quot;delete&quot;,&quot;&lt;create|update&gt;&quot;],&quot;effect&quot;:&quot;allow&quot;,&quot;resources&quot;:[&quot;resources:articles:&lt;.*&gt;&quot;,&quot;resources:printer&quot;],&quot;conditions&quot;:{&quot;remoteIPAddress&quot;:{&quot;type&quot;:&quot;CIDRCondition&quot;,&quot;options&quot;:{&quot;cidr&quot;:&quot;192.168.0.1/16&quot;}}}}}&#39;</span> http://127.0.0.1:8080/v1/policies

<span class="token comment"># 列出所有策略</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/policies

<span class="token comment"># 获取 policy0 策略的详细信息</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XGET</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/policies/policy0

<span class="token comment"># 修改 policy0 策略</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPUT</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;policy0&quot;},&quot;policy&quot;:{&quot;description&quot;:&quot;One policy to rule them all(modified).&quot;,&quot;subjects&quot;:[&quot;users:&lt;peter|ken&gt;&quot;,&quot;users:maria&quot;,&quot;groups:admins&quot;],&quot;actions&quot;:[&quot;delete&quot;,&quot;&lt;create|update&gt;&quot;],&quot;effect&quot;:&quot;allow&quot;,&quot;resources&quot;:[&quot;resources:articles:&lt;.*&gt;&quot;,&quot;resources:printer&quot;],&quot;conditions&quot;:{&quot;remoteIPAddress&quot;:{&quot;type&quot;:&quot;CIDRCondition&quot;,&quot;options&quot;:{&quot;cidr&quot;:&quot;192.168.0.1/16&quot;}}}}}&#39;</span> http://127.0.0.1:8080/v1/policies/policy0

<span class="token comment"># 删除 policy0 策略</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XDELETE</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> http://127.0.0.1:8080/v1/policies/policy0

<span class="token comment"># 创建策略</span>
$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXBpLm1hcm1vdGVkdS5jb20iLCJleHAiOjE2NzY2MzI5MzcsImlkZW50aXR5IjoiYWRtaW4iLCJpc3MiOiJpYW0tYXBpc2VydmVyIiwib3JpZ19pYXQiOjE2NzY1NDY1MzcsInN1YiI6ImFkbWluIn0.FprBR_QLI_LS8Y087mat88tIRIQyWrYDo41RsRmnQjE&#39;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;policy0&quot;},&quot;policy&quot;:{&quot;description&quot;:&quot;One policy to rule them all.&quot;,&quot;subjects&quot;:[&quot;users:&lt;peter|ken&gt;&quot;,&quot;users:maria&quot;,&quot;groups:admins&quot;],&quot;actions&quot;:[&quot;delete&quot;,&quot;&lt;create|update&gt;&quot;],&quot;effect&quot;:&quot;allow&quot;,&quot;resources&quot;:[&quot;resources:articles:&lt;.*&gt;&quot;,&quot;resources:printer&quot;],&quot;conditions&quot;:{&quot;remoteIPAddress&quot;:{&quot;type&quot;:&quot;CIDRCondition&quot;,&quot;options&quot;:{&quot;cidr&quot;:&quot;192.168.0.1/16&quot;}}}}}&#39;</span> http://127.0.0.1:8080/v1/policies
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装-iamctl" tabindex="-1"><a class="header-anchor" href="#安装-iamctl" aria-hidden="true">#</a> 安装 iamctl</h3><p>上面，我们安装了 iam 系统的 API 服务。但是想要访问 iam 服务，我们还需要安装客户端工具 iamctl。具体来说，我们可以通过 3 步完成 iamctl 的安装和配置。</p><h4 id="第-1-步-创建-iamctl-证书和私钥。" tabindex="-1"><a class="header-anchor" href="#第-1-步-创建-iamctl-证书和私钥。" aria-hidden="true">#</a> 第 1 步，创建 iamctl 证书和私钥。</h4><p>iamctl 使用 https 协议与 iam-apiserver 进行安全通信，iam-apiserver 对 iamctl 请求包含的证书进行认证和授权。iamctl 后续用于 iam 系统访问和管理，所以这里创建具有最高权限的 admin 证书。</p><p><strong>创建证书签名请求</strong>。</p><p>下面创建的证书只会被 iamctl 当作 client 证书使用，所以 hosts 字段为空。代码如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">cat</span> <span class="token operator">&gt;</span> admin-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;admin&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;marmotedu&quot;,
      &quot;OU&quot;: &quot;iamctl&quot;
    }
  ],
  &quot;hosts&quot;: []
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成证书和私钥：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca.pem <span class="token punctuation">\</span>
  -ca-key<span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-key.pem <span class="token punctuation">\</span>
  <span class="token parameter variable">-config</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-config.json <span class="token punctuation">\</span>
  <span class="token parameter variable">-profile</span><span class="token operator">=</span>iam admin-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> admin
$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $<span class="token punctuation">{</span>CONFIG_USER_CLIENT_CERTIFICATE<span class="token punctuation">}</span><span class="token variable">)</span></span> <span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> $<span class="token punctuation">{</span>CONFIG_USER_CLIENT_KEY<span class="token punctuation">}</span><span class="token variable">)</span></span> <span class="token comment"># 创建客户端证书存放的目录</span>
$ <span class="token function">mv</span> admin.pem <span class="token variable">${CONFIG_USER_CLIENT_CERTIFICATE}</span> <span class="token comment"># 安装 TLS 的客户端证书</span>
$ <span class="token function">mv</span> admin-key.pem <span class="token variable">${CONFIG_USER_CLIENT_KEY}</span> <span class="token comment"># 安装 TLS 的客户端私钥文件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-2-步-安装-iamctl。" tabindex="-1"><a class="header-anchor" href="#第-2-步-安装-iamctl。" aria-hidden="true">#</a> 第 2 步，安装 iamctl。</h4><p>iamctl 是 IAM 系统的客户端工具，其安装位置和 iam-apiserver、iam-authz-server、iam-pump 位置不同，为了能够在 shell 下直接运行 iamctl 命令，我们需要将 iamctl 安装到<code>$HOME/bin</code> 下，同时将 iamctl 的配置存放在默认加载的目录下：<code>$HOME/.iam</code>。主要分 2 步进行。</p><p><strong>安装 iamctl 可执行程序：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">make</span> build <span class="token assign-left variable">BINS</span><span class="token operator">=</span>iamctl
$ <span class="token function">cp</span> _output/platforms/linux/amd64/iamctl <span class="token environment constant">$HOME</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成并安装 iamctl 的配置文件（iamctl.yaml）：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iamctl.yaml<span class="token operator">&gt;</span> iamctl.yaml
$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.iam
$ <span class="token function">mv</span> iamctl.yaml <span class="token environment constant">$HOME</span>/.iam
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为 iamctl 是一个客户端工具，可能会在多台机器上运行。为了简化部署 iamctl 工具的复杂度，我们可以把 config 配置文件中跟 CA 认证相关的 CA 文件内容用 base64 加密后，放置在 config 配置文件中。具体的思路就是把 config 文件中的配置项 client-certificate、client-key、certificate-authority 分别用如下配置项替换 client-certificate-data、client-key-data、certificate-authority-data。这些配置项的值可以通过对 CA 文件使用 base64 加密获得。</p><p>假如，certificate-authority 值为<code>/etc/iam/cert/ca.pem</code>，则 certificate-authority-data 的值为 <code>cat &quot;/etc/iam/cert/ca.pem&quot; | base64 | tr -d &#39;\r\n&#39;</code>，其它-data 变量的值类似。这样当我们再部署 iamctl 工具时，只需要拷贝 iamctl 和配置文件，而不用再拷贝 CA 文件了。</p><h4 id="第-3-步-测试-iamctl-是否成功安装。" tabindex="-1"><a class="header-anchor" href="#第-3-步-测试-iamctl-是否成功安装。" aria-hidden="true">#</a> 第 3 步，测试 iamctl 是否成功安装。</h4><p>执行 <code>iamctl user list</code> 可以列出预创建的 admin 用户，如下图所示：</p><p><img src="http://sm.nsddd.top/sm202302161945373.png" alt="image-20230216194553152"></p><h3 id="安装和配置-iam-authz-server" tabindex="-1"><a class="header-anchor" href="#安装和配置-iam-authz-server" aria-hidden="true">#</a> 安装和配置 iam-authz-server</h3><p>接下来，我们需要安装另外一个核心组件：iam-authz-server，可以通过以下 3 步来安装。</p><h4 id="第-1-步-创建-iam-authz-server-证书和私钥。" tabindex="-1"><a class="header-anchor" href="#第-1-步-创建-iam-authz-server-证书和私钥。" aria-hidden="true">#</a> 第 1 步，创建 iam-authz-server 证书和私钥。</h4><p><strong>创建证书签名请求：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">tee</span> iam-authz-server-csr.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF
{
  &quot;CN&quot;: &quot;iam-authz-server&quot;,
  &quot;key&quot;: {
    &quot;algo&quot;: &quot;rsa&quot;,
    &quot;size&quot;: 2048
  },
  &quot;names&quot;: [
    {
      &quot;C&quot;: &quot;CN&quot;,
      &quot;ST&quot;: &quot;BeiJing&quot;,
      &quot;L&quot;: &quot;BeiJing&quot;,
      &quot;O&quot;: &quot;marmotedu&quot;,
      &quot;OU&quot;: &quot;iam-authz-server&quot;
    }
  ],
  &quot;hosts&quot;: [
    &quot;127.0.0.1&quot;,
    &quot;localhost&quot;,
    &quot;iam.authz.marmotedu.com&quot;
  ]
}
EOF</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码中的 hosts 字段指定授权使用该证书的 IP 和域名列表，上面的 hosts 列出了 iam-authz-server 服务的 IP 和域名。</p><p><strong>生成证书和私钥：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ cfssl gencert <span class="token parameter variable">-ca</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca.pem <span class="token punctuation">\</span>
  -ca-key<span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-key.pem <span class="token punctuation">\</span>
  <span class="token parameter variable">-config</span><span class="token operator">=</span><span class="token variable">${IAM_CONFIG_DIR}</span>/cert/ca-config.json <span class="token punctuation">\</span>
  <span class="token parameter variable">-profile</span><span class="token operator">=</span>iam iam-authz-server-csr.json <span class="token operator">|</span> cfssljson <span class="token parameter variable">-bare</span> iam-authz-server
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-authz-server*pem <span class="token variable">${IAM_CONFIG_DIR}</span>/cert <span class="token comment"># 将生成的证书和私钥文件拷贝到配置文件目录</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-2-步-安装并运行-iam-authz-server。" tabindex="-1"><a class="header-anchor" href="#第-2-步-安装并运行-iam-authz-server。" aria-hidden="true">#</a> 第 2 步，安装并运行 iam-authz-server。</h4><p>安装 iam-authz-server 步骤和安装 iam-apiserver 步骤基本一样，也需要 4 步。</p><p><strong>安装 iam-authz-server 可执行程序：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">make</span> build <span class="token assign-left variable">BINS</span><span class="token operator">=</span>iam-authz-server
$ <span class="token function">sudo</span> <span class="token function">cp</span> _output/platforms/linux/amd64/iam-authz-server <span class="token variable">${IAM_INSTALL_DIR}</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成并安装 iam-authz-server 的配置文件（iam-authz-server.yaml）：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-authz-server.yaml <span class="token operator">&gt;</span> iam-authz-server.yaml
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-authz-server.yaml <span class="token variable">${IAM_CONFIG_DIR}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建并安装 iam-authz-server systemd unit 文件：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-authz-server.service <span class="token operator">&gt;</span> iam-authz-server.service
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-authz-server.service /etc/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>启动 iam-authz-server 服务：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl daemon-reload
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> iam-authz-server
$ <span class="token function">sudo</span> systemctl restart iam-authz-server
$ systemctl status iam-authz-server 
<span class="token comment"># 查看 iam-authz-server 运行状态，如果输出中包含 active (running)字样说明 iam-authz-server 成功启动。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="第-3-步-测试-iam-authz-server-是否成功安装。" tabindex="-1"><a class="header-anchor" href="#第-3-步-测试-iam-authz-server-是否成功安装。" aria-hidden="true">#</a> 第 3 步，测试 iam-authz-server 是否成功安装。</h4><p><strong>重新登陆系统，并获取访问令牌</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token assign-left variable">token</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -d<span class="token string">&#39;{&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;Admin@2021&quot;}&#39;</span> http://127.0.0.1:8080/login <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> .token<span class="token variable">`</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>创建授权策略:</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&quot;Content-Type: application/json&quot;</span> -H<span class="token string">&quot;Authorization: Bearer <span class="token variable">$token</span>&quot;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;authztest&quot;},&quot;policy&quot;:{&quot;description&quot;:&quot;One policy to rule them all.&quot;,&quot;subjects&quot;:[&quot;users:&lt;peter|ken&gt;&quot;,&quot;users:maria&quot;,&quot;groups:admins&quot;],&quot;actions&quot;:[&quot;delete&quot;,&quot;&lt;create|update&gt;&quot;],&quot;effect&quot;:&quot;allow&quot;,&quot;resources&quot;:[&quot;resources:articles:&lt;.*&gt;&quot;,&quot;resources:printer&quot;],&quot;conditions&quot;:{&quot;remoteIPAddress&quot;:{&quot;type&quot;:&quot;CIDRCondition&quot;,&quot;options&quot;:{&quot;cidr&quot;:&quot;192.168.0.1/16&quot;}}}}}&#39;</span> http://127.0.0.1:8080/v1/policies
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>创建密钥，并从命令的输出中提取 secretID 和 secretKey</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&quot;Content-Type: application/json&quot;</span> -H<span class="token string">&quot;Authorization: Bearer <span class="token variable">$token</span>&quot;</span> -d<span class="token string">&#39;{&quot;metadata&quot;:{&quot;name&quot;:&quot;authztest&quot;},&quot;expires&quot;:0,&quot;description&quot;:&quot;admin secret&quot;}&#39;</span> http://127.0.0.1:8080/v1/secrets
<span class="token punctuation">{</span><span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span>:23,<span class="token string">&quot;instanceID&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;secret-yj8m30&quot;</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;authztest&quot;</span>,<span class="token string">&quot;createdAt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2023-02-16T19:55:29.407+08:00&quot;</span>,<span class="token string">&quot;updatedAt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2023-02-16T19:55:29.407+08:00&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;username&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;admin&quot;</span>,<span class="token string">&quot;secretID&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Ouk0bP2SX36f5FgpGWnFZy6Tpom89VEljtUo&quot;</span>,<span class="token string">&quot;secretKey&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;uIhkIKQ7GA7eSCIdjNYQgvRoE3d6n9bo&quot;</span>,<span class="token string">&quot;expires&quot;</span>:0,<span class="token string">&quot;description&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;admin secret&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>生成访问 iam-authz-server 的 token</strong></p><p>iamctl 提供了 jwt sigin 命令，可以根据 secretID 和 secretKey 签发 Token，方便你使用。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ iamctl jwt sign Ouk0bP2SX36f5FgpGWnFZy6Tpom89VEljtUo uIhkIKQ7GA7eSCIdjNYQgvRoE3d6n9bo <span class="token comment"># iamctl jwt sign $secretID $secretKey，替换成上一步创建的密钥对</span>
eyJhbGciOiJIUzI1NiIsImtpZCI6Ik91azBiUDJTWDM2ZjVGZ3BHV25GWnk2VHBvbTg5VkVsanRVbyIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTY3NjU1NTg3NywiaWF0IjoxNjc2NTQ4Njc3LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2NzY1NDg2Nzd9.CdbBrm9-mErgysb5xwa0EQPboQWnXJpXOBZZk6K6M9E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你的开发过程中有些重复性的操作，为了方便使用，也可以将这些操作以 iamctl 子命令的方式集成到 iamctl 命令行中。</p><p><strong>测试资源授权是否通过</strong></p><p>我们可以通过请求 /v1/authz 来完成资源授权：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">&#39;Content-Type: application/json&#39;</span> -H<span class="token string">&#39;Authorization: Bearer eyJhbGciOiJIUzI1NiIsImtpZCI6Ik91azBiUDJTWDM2ZjVGZ3BHV25GWnk2VHBvbTg5VkVsanRVbyIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJpYW0uYXV0aHoubWFybW90ZWR1LmNvbSIsImV4cCI6MTY3NjU1NTg3NywiaWF0IjoxNjc2NTQ4Njc3LCJpc3MiOiJpYW1jdGwiLCJuYmYiOjE2NzY1NDg2Nzd9.CdbBrm9-mErgysb5xwa0EQPboQWnXJpXOBZZk6K6M9E&#39;</span> -d<span class="token string">&#39;{&quot;subject&quot;:&quot;users:maria&quot;,&quot;action&quot;:&quot;delete&quot;,&quot;resource&quot;:&quot;resources:articles:ladon-introduction&quot;,&quot;context&quot;:{&quot;remoteIPAddress&quot;:&quot;192.168.0.5&quot;}}&#39;</span> http://127.0.0.1:9090/v1/authz
<span class="token punctuation">{</span><span class="token string">&quot;allowed&quot;</span>:true<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果授权通过会返回：<code>{&quot;allowed&quot;:true}</code> 。</p><h3 id="安装和配置-iam-pump" tabindex="-1"><a class="header-anchor" href="#安装和配置-iam-pump" aria-hidden="true">#</a> 安装和配置 iam-pump</h3><p>安装 iam-pump 步骤和安装 iam-apiserver、iam-authz-server 步骤基本一样，具体步骤如下。</p><p><strong>第 1 步，安装 iam-pump 可执行程序。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ <span class="token builtin class-name">source</span> scripts/install/environment.sh
$ <span class="token function">make</span> build <span class="token assign-left variable">BINS</span><span class="token operator">=</span>iam-pump
$ <span class="token function">sudo</span> <span class="token function">cp</span> _output/platforms/linux/amd64/iam-pump <span class="token variable">${IAM_INSTALL_DIR}</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第 2 步，生成并安装 iam-pump 的配置文件（iam-pump.yaml）。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh configs/iam-pump.yaml <span class="token operator">&gt;</span> iam-pump.yaml
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-pump.yaml <span class="token variable">${IAM_CONFIG_DIR}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第 3 步，创建并安装 iam-pump systemd unit 文件。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ ./scripts/genconfig.sh scripts/install/environment.sh init/iam-pump.service <span class="token operator">&gt;</span> iam-pump.service
$ <span class="token function">sudo</span> <span class="token function">mv</span> iam-pump.service /etc/systemd/system/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第 4 步，启动 iam-pump 服务。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> systemctl daemon-reload
$ <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> iam-pump
$ <span class="token function">sudo</span> systemctl restart iam-pump
$ systemctl status iam-pump <span class="token comment"># 查看 iam-pump 运行状态，如果输出中包含 active (running)字样说明 iam-pump 成功启动。</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第 5 步，测试 iam-pump 是否成功安装。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">curl</span> http://127.0.0.1:7070/healthz
<span class="token punctuation">{</span><span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>经过上面这 5 个步骤，如果返回 <code>{“status”: “ok”}</code> 就说明 iam-pump 服务健康</p><h3 id="安装-man-文件" tabindex="-1"><a class="header-anchor" href="#安装-man-文件" aria-hidden="true">#</a> 安装 man 文件</h3><p>IAM 系统通过组合调用包：<a href="">github.com/cpuguy83/go-md2man/v2/md2man</a> 和 <a href="https://github.com/spf13/cobra" target="_blank" rel="noopener noreferrer">github.com/spf13/cobra<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的相关函数生成了各个组件的 man1 文件，主要分 3 步实现。</p><p><strong>第 1 步，生成各个组件的 man1 文件。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token variable">$IAM_ROOT</span>
$ ./scripts/update-generated-docs.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>第 2 步，安装生成的 man1 文件。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">cp</span> docs/man/man1/* /usr/share/man/man1/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>第 3 步，检查是否成功安装 man1 文件。</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">man</span> iam-apiserver
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p><strong>执行 man iam-apiserver 命令后，会弹出 man 文档界面，如下图所示：</strong></p><p><img src="http://sm.nsddd.top/sm202302162006542.png" alt="image-20230216200626281"></p></blockquote><p>至此，IAM 系统所有组件都已经安装成功了，你可以通过 iamctl version 查看客户端和服务端版本，代码如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ iamctl version <span class="token parameter variable">-o</span> yaml
clientVersion:
  buildDate: <span class="token string">&quot;2023-02-16T11:43:40Z&quot;</span>
  compiler: gc
  gitCommit: f39d4105e563c01fb4869bbaf1b19f5afa944400
  gitTreeState: dirty
  gitVersion: f39d410
  goVersion: go1.18.3
  platform: linux/amd64
serverVersion:
  buildDate: <span class="token string">&quot;2023-02-16T11:18:53Z&quot;</span>
  compiler: gc
  gitCommit: f39d4105e563c01fb4869bbaf1b19f5afa944400
  gitTreeState: dirty
  gitVersion: f39d410
  goVersion: go1.18.3
  platform: linux/amd64
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="一键安装" tabindex="-1"><a class="header-anchor" href="#一键安装" aria-hidden="true">#</a> 一键安装</h2><p><strong>除此之外，还可以一键安装：</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">LINUX_PASSWORD</span><span class="token operator">=</span><span class="token string">&#39;iam59!z$&#39;</span> <span class="token comment"># 重要：这里要 export going 用户的密码</span>
$ <span class="token assign-left variable">version</span><span class="token operator">=</span>latest <span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> https://marmotedu-1254073058.cos.ap-beijing.myqcloud.com/iam-release/<span class="token variable">${version}</span>/iam.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> <span class="token parameter variable">-xz</span> <span class="token parameter variable">-C</span> / tmp/       
$ <span class="token builtin class-name">cd</span> /tmp/iam/ <span class="token operator">&amp;&amp;</span> ./scripts/install/install.sh iam::install::install
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>⚠️ 所有组件设置的密码都是 <code>iam59!z$</code></p><p><img src="http://sm.nsddd.top/sm202302162007692.png" alt="image-20230216200735600"></p><h2 id="end-链接" tabindex="-1"><a class="header-anchor" href="#end-链接" aria-hidden="true">#</a> END 链接</h2><ul><li><div><a href="1.md" style="float:left;">⬆️上一节🔗 </a><a href="3.md" style="float:right;"> ️下一节🔗</a></div></li></ul><ul><li><p><a href="/iam/" class="">Ⓜ️回到目录🏠</a></p></li><li><p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>🫵参与贡献💞❤️‍🔥💖</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p></li><li><p>✴️版权声明 © ：本书所有内容遵循<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0协议（署名-相同方式共享）©<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/3293172751/awesome-go/edit/master/docs/iam/projects/2.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub上贡献此页面"><!--[--><!--]--> 在GitHub上贡献此页面 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/iam/projects/1.html" class="" aria-label="第1节 IAM项目介绍"><!--[--><!--]--> 第1节 IAM项目介绍 <!--[--><!--]--></a></span><span class="next"><a href="/iam/projects/3.html" class="" aria-label="第3节 设计规范"><!--[--><!--]--> 第3节 设计规范 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.df174e55.js" defer></script>
  </body>
</html>

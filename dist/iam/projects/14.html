<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.51">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/img/1.jpg"><title>第14节 Pflag、Viper、Cobra 核心功能介绍 | 你好</title><meta name="description" content="链学社致力于打造出区块链去中心化的学习平台">
    <link rel="modulepreload" href="/assets/app.293f0ed8.js"><link rel="modulepreload" href="/assets/14.html.01456a3d.js"><link rel="modulepreload" href="/assets/14.html.a5ba315e.js"><link rel="prefetch" href="/assets/index.html.a2ea27a5.js"><link rel="prefetch" href="/assets/index.html.e3e54846.js"><link rel="prefetch" href="/assets/1.html.22289593.js"><link rel="prefetch" href="/assets/10.html.fcccc2ff.js"><link rel="prefetch" href="/assets/11.html.aac1a3bd.js"><link rel="prefetch" href="/assets/12.html.b371710f.js"><link rel="prefetch" href="/assets/13.html.4c3ede3b.js"><link rel="prefetch" href="/assets/15.html.1580a958.js"><link rel="prefetch" href="/assets/16.html.a8349d9b.js"><link rel="prefetch" href="/assets/17.html.429cbcbd.js"><link rel="prefetch" href="/assets/18.html.d15c806b.js"><link rel="prefetch" href="/assets/19.html.070f0886.js"><link rel="prefetch" href="/assets/2.html.99975564.js"><link rel="prefetch" href="/assets/20.html.93b19902.js"><link rel="prefetch" href="/assets/21.html.cf7d1b5d.js"><link rel="prefetch" href="/assets/22.html.db4afbd7.js"><link rel="prefetch" href="/assets/23.html.a1e62360.js"><link rel="prefetch" href="/assets/24.html.21dea561.js"><link rel="prefetch" href="/assets/25.html.49b862c4.js"><link rel="prefetch" href="/assets/26.html.36989258.js"><link rel="prefetch" href="/assets/27.html.571b1d4e.js"><link rel="prefetch" href="/assets/28.html.4b7e2a2b.js"><link rel="prefetch" href="/assets/29.html.251aabee.js"><link rel="prefetch" href="/assets/3.html.3f00f3d0.js"><link rel="prefetch" href="/assets/30.html.225d86b8.js"><link rel="prefetch" href="/assets/31.html.9f14dfc5.js"><link rel="prefetch" href="/assets/32.html.8ac1706b.js"><link rel="prefetch" href="/assets/33.html.1e0dfe99.js"><link rel="prefetch" href="/assets/34.html.f2444c6f.js"><link rel="prefetch" href="/assets/35.html.a4049674.js"><link rel="prefetch" href="/assets/36.html.d4fcf351.js"><link rel="prefetch" href="/assets/37.html.e29eb8b4.js"><link rel="prefetch" href="/assets/38.html.195d22cf.js"><link rel="prefetch" href="/assets/39.html.90f09380.js"><link rel="prefetch" href="/assets/4.html.be4bc5b5.js"><link rel="prefetch" href="/assets/40.html.45d7a4dc.js"><link rel="prefetch" href="/assets/41.html.e3a2ebf7.js"><link rel="prefetch" href="/assets/42.html.2d4c045c.js"><link rel="prefetch" href="/assets/43.html.647962a9.js"><link rel="prefetch" href="/assets/44.html.804b2ebc.js"><link rel="prefetch" href="/assets/45.html.ecd5924e.js"><link rel="prefetch" href="/assets/46.html.f0df9beb.js"><link rel="prefetch" href="/assets/47.html.69252181.js"><link rel="prefetch" href="/assets/48.html.8df3099d.js"><link rel="prefetch" href="/assets/49.html.bbcbb6ca.js"><link rel="prefetch" href="/assets/5.html.8fa1df64.js"><link rel="prefetch" href="/assets/50.html.88a6df7a.js"><link rel="prefetch" href="/assets/51.html.2cc2cde7.js"><link rel="prefetch" href="/assets/52.html.8f10d639.js"><link rel="prefetch" href="/assets/53.html.87d57c98.js"><link rel="prefetch" href="/assets/54.html.3c986351.js"><link rel="prefetch" href="/assets/55.html.ef79ab9d.js"><link rel="prefetch" href="/assets/56.html.47391418.js"><link rel="prefetch" href="/assets/57.html.ed714ef8.js"><link rel="prefetch" href="/assets/58.html.e45a8f1a.js"><link rel="prefetch" href="/assets/59.html.a4ef2b6b.js"><link rel="prefetch" href="/assets/6.html.ff77ac5a.js"><link rel="prefetch" href="/assets/60.html.aa3091f2.js"><link rel="prefetch" href="/assets/61.html.d34e05ef.js"><link rel="prefetch" href="/assets/62.html.73c09267.js"><link rel="prefetch" href="/assets/63.html.ee77d345.js"><link rel="prefetch" href="/assets/64.html.e6870d98.js"><link rel="prefetch" href="/assets/65.html.4803352d.js"><link rel="prefetch" href="/assets/66.html.5f7f7cf5.js"><link rel="prefetch" href="/assets/67.html.1dda677a.js"><link rel="prefetch" href="/assets/68.html.46c4b431.js"><link rel="prefetch" href="/assets/69.html.01202045.js"><link rel="prefetch" href="/assets/7.html.af5be859.js"><link rel="prefetch" href="/assets/70.html.698119d7.js"><link rel="prefetch" href="/assets/71.html.bca58bd1.js"><link rel="prefetch" href="/assets/72.html.0c495f64.js"><link rel="prefetch" href="/assets/73.html.1b1da238.js"><link rel="prefetch" href="/assets/74.html.5790a036.js"><link rel="prefetch" href="/assets/75.html.c0efadfb.js"><link rel="prefetch" href="/assets/76.html.80873dd0.js"><link rel="prefetch" href="/assets/77.html.bd454470.js"><link rel="prefetch" href="/assets/78.html.3610e426.js"><link rel="prefetch" href="/assets/79.html.a3fa3730.js"><link rel="prefetch" href="/assets/8.html.ddecb60c.js"><link rel="prefetch" href="/assets/80.html.ca6615ee.js"><link rel="prefetch" href="/assets/81.html.3ec6cf08.js"><link rel="prefetch" href="/assets/82.html.0c2a9c61.js"><link rel="prefetch" href="/assets/83.html.944f8804.js"><link rel="prefetch" href="/assets/84.html.275503f9.js"><link rel="prefetch" href="/assets/85.html.3a401355.js"><link rel="prefetch" href="/assets/86.html.09d84ac5.js"><link rel="prefetch" href="/assets/87.html.01ce4b91.js"><link rel="prefetch" href="/assets/88.html.17f7c6ee.js"><link rel="prefetch" href="/assets/89.html.564a9562.js"><link rel="prefetch" href="/assets/9.html.37eb122c.js"><link rel="prefetch" href="/assets/90.html.cf98daa9.js"><link rel="prefetch" href="/assets/91.html.43673b0c.js"><link rel="prefetch" href="/assets/92.html.4f001ff0.js"><link rel="prefetch" href="/assets/93.html.788d1091.js"><link rel="prefetch" href="/assets/94.html.99533281.js"><link rel="prefetch" href="/assets/95.html.4730f1df.js"><link rel="prefetch" href="/assets/96.html.563b0639.js"><link rel="prefetch" href="/assets/97.html.0597d140.js"><link rel="prefetch" href="/assets/98.html.2ab04005.js"><link rel="prefetch" href="/assets/99.html.4e64dae3.js"><link rel="prefetch" href="/assets/项目管理从理论到实践.html.196f269c.js"><link rel="prefetch" href="/assets/404.html.c3e557d0.js"><link rel="prefetch" href="/assets/index.html.5fe70644.js"><link rel="prefetch" href="/assets/index.html.f00de422.js"><link rel="prefetch" href="/assets/1.html.ecf9d271.js"><link rel="prefetch" href="/assets/10.html.0afcddc7.js"><link rel="prefetch" href="/assets/11.html.038cfd76.js"><link rel="prefetch" href="/assets/12.html.7a767327.js"><link rel="prefetch" href="/assets/13.html.21d273b5.js"><link rel="prefetch" href="/assets/15.html.e0af338e.js"><link rel="prefetch" href="/assets/16.html.0e149a4f.js"><link rel="prefetch" href="/assets/17.html.c08c354e.js"><link rel="prefetch" href="/assets/18.html.0ad0c1d2.js"><link rel="prefetch" href="/assets/19.html.ba8b44ad.js"><link rel="prefetch" href="/assets/2.html.deed68c4.js"><link rel="prefetch" href="/assets/20.html.654b0c6e.js"><link rel="prefetch" href="/assets/21.html.cfd38c3f.js"><link rel="prefetch" href="/assets/22.html.84feacdb.js"><link rel="prefetch" href="/assets/23.html.1465b697.js"><link rel="prefetch" href="/assets/24.html.7d49f8af.js"><link rel="prefetch" href="/assets/25.html.8e7ebfe0.js"><link rel="prefetch" href="/assets/26.html.87ba9998.js"><link rel="prefetch" href="/assets/27.html.d5d54756.js"><link rel="prefetch" href="/assets/28.html.cb57f63f.js"><link rel="prefetch" href="/assets/29.html.d83789db.js"><link rel="prefetch" href="/assets/3.html.4445bf65.js"><link rel="prefetch" href="/assets/30.html.e05767bb.js"><link rel="prefetch" href="/assets/31.html.b4f66550.js"><link rel="prefetch" href="/assets/32.html.0d37d02a.js"><link rel="prefetch" href="/assets/33.html.61f2dbfb.js"><link rel="prefetch" href="/assets/34.html.d9455e89.js"><link rel="prefetch" href="/assets/35.html.6affdac4.js"><link rel="prefetch" href="/assets/36.html.5f11a4fe.js"><link rel="prefetch" href="/assets/37.html.46d52d65.js"><link rel="prefetch" href="/assets/38.html.796cbdb1.js"><link rel="prefetch" href="/assets/39.html.79133436.js"><link rel="prefetch" href="/assets/4.html.03f2867f.js"><link rel="prefetch" href="/assets/40.html.4c76c62a.js"><link rel="prefetch" href="/assets/41.html.8ce21602.js"><link rel="prefetch" href="/assets/42.html.d3672f64.js"><link rel="prefetch" href="/assets/43.html.b324f094.js"><link rel="prefetch" href="/assets/44.html.8f64a664.js"><link rel="prefetch" href="/assets/45.html.10842a56.js"><link rel="prefetch" href="/assets/46.html.3d6c20bc.js"><link rel="prefetch" href="/assets/47.html.ddc4d9e6.js"><link rel="prefetch" href="/assets/48.html.f46fc378.js"><link rel="prefetch" href="/assets/49.html.7399e3bc.js"><link rel="prefetch" href="/assets/5.html.a192af9c.js"><link rel="prefetch" href="/assets/50.html.10179c64.js"><link rel="prefetch" href="/assets/51.html.f45dcc3d.js"><link rel="prefetch" href="/assets/52.html.744c43c3.js"><link rel="prefetch" href="/assets/53.html.bacc15bd.js"><link rel="prefetch" href="/assets/54.html.4ec92cea.js"><link rel="prefetch" href="/assets/55.html.e4f72f9e.js"><link rel="prefetch" href="/assets/56.html.d92e5c0a.js"><link rel="prefetch" href="/assets/57.html.191eea41.js"><link rel="prefetch" href="/assets/58.html.ffa01c72.js"><link rel="prefetch" href="/assets/59.html.8e76075e.js"><link rel="prefetch" href="/assets/6.html.40cbcf4b.js"><link rel="prefetch" href="/assets/60.html.c5e6c51d.js"><link rel="prefetch" href="/assets/61.html.f472604b.js"><link rel="prefetch" href="/assets/62.html.361427c2.js"><link rel="prefetch" href="/assets/63.html.eeaeef3a.js"><link rel="prefetch" href="/assets/64.html.294c58e6.js"><link rel="prefetch" href="/assets/65.html.68e6616d.js"><link rel="prefetch" href="/assets/66.html.043138bc.js"><link rel="prefetch" href="/assets/67.html.d865e203.js"><link rel="prefetch" href="/assets/68.html.04ab9e6d.js"><link rel="prefetch" href="/assets/69.html.a925e8d7.js"><link rel="prefetch" href="/assets/7.html.e8253e5a.js"><link rel="prefetch" href="/assets/70.html.48463aeb.js"><link rel="prefetch" href="/assets/71.html.2b909813.js"><link rel="prefetch" href="/assets/72.html.83c57b7e.js"><link rel="prefetch" href="/assets/73.html.dc2d85f5.js"><link rel="prefetch" href="/assets/74.html.e9cba39b.js"><link rel="prefetch" href="/assets/75.html.31f21411.js"><link rel="prefetch" href="/assets/76.html.6438207e.js"><link rel="prefetch" href="/assets/77.html.4c7c4f27.js"><link rel="prefetch" href="/assets/78.html.b2478a88.js"><link rel="prefetch" href="/assets/79.html.5965c5ff.js"><link rel="prefetch" href="/assets/8.html.723bb48e.js"><link rel="prefetch" href="/assets/80.html.78eb1d38.js"><link rel="prefetch" href="/assets/81.html.9cbb7455.js"><link rel="prefetch" href="/assets/82.html.1a3b78ff.js"><link rel="prefetch" href="/assets/83.html.67b885d2.js"><link rel="prefetch" href="/assets/84.html.d8ccf491.js"><link rel="prefetch" href="/assets/85.html.9807efde.js"><link rel="prefetch" href="/assets/86.html.02de674f.js"><link rel="prefetch" href="/assets/87.html.61471835.js"><link rel="prefetch" href="/assets/88.html.27ccb049.js"><link rel="prefetch" href="/assets/89.html.9d1b1eee.js"><link rel="prefetch" href="/assets/9.html.335e0470.js"><link rel="prefetch" href="/assets/90.html.89eaa72f.js"><link rel="prefetch" href="/assets/91.html.183cfb67.js"><link rel="prefetch" href="/assets/92.html.23b655b9.js"><link rel="prefetch" href="/assets/93.html.d76d1330.js"><link rel="prefetch" href="/assets/94.html.d3e3929e.js"><link rel="prefetch" href="/assets/95.html.619ee482.js"><link rel="prefetch" href="/assets/96.html.d7b0b14d.js"><link rel="prefetch" href="/assets/97.html.24e8a51a.js"><link rel="prefetch" href="/assets/98.html.66600990.js"><link rel="prefetch" href="/assets/99.html.4a4dd48f.js"><link rel="prefetch" href="/assets/项目管理从理论到实践.html.6447c1c8.js"><link rel="prefetch" href="/assets/404.html.0cf2de41.js">
    <link rel="stylesheet" href="/assets/style.03848e77.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="切换侧边栏" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">你好</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/cubxxw/awesome-cs-cloudnative-blockchain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/c-ub/docs" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="切换颜色模式"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="🤵关于我"><span class="title">🤵关于我</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/cubxxw/awesome-cs-cloudnative-blockchain" rel="noopener noreferrer" target="_blank" aria-label="Github仓库"><!--[--><!--]--> Github仓库 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="http://nsddd.top" rel="noopener noreferrer" target="_blank" aria-label="我的博客"><!--[--><!--]--> 我的博客 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://www.zhihu.com/people/3293172751" rel="noopener noreferrer" target="_blank" aria-label="知乎"><!--[--><!--]--> 知乎 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/C-UB/" rel="noopener noreferrer" target="_blank" aria-label="⛓️链学社组织"><!--[--><!--]--> ⛓️链学社组织 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a href="/" class="" aria-label="🏠首页"><!--[--><!--]--> 🏠首页 <!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://docker.nsddd.top/" rel="noopener noreferrer" target="_blank" aria-label="🐋docker文档"><!--[--><!--]--> 🐋docker文档 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="📚go文档"><span class="title">📚go文档</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projec/" class="" aria-label="🔥 K8s-Iam 项目"><!--[--><!--]--> 🔥 K8s-Iam 项目 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s/" class="" aria-label="🔥 k8s 教程"><!--[--><!--]--> 🔥 k8s 教程 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/k8s-iam/" class="" aria-label="🔥 iam 教程"><!--[--><!--]--> 🔥 iam 教程 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/c-ub/docs" rel="noopener noreferrer" target="_blank" aria-label="查看源码"><!--[--><!--]--> 查看源码 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="🏠回到主页"><!--[--><!--]--> 🏠回到主页 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">🔥 Go语言基础篇 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/iam/projects/1.html" class="sidebar-item" aria-label="第1节 IAM项目介绍"><!--[--><!--]--> 第1节 IAM项目介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/2.html" class="sidebar-item" aria-label="第2节 IAM项目部署"><!--[--><!--]--> 第2节 IAM项目部署 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/3.html" class="sidebar-item" aria-label="第3节 设计规范"><!--[--><!--]--> 第3节 设计规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/4.html" class="sidebar-item" aria-label="第4节 Go语言项目设计"><!--[--><!--]--> 第4节 Go语言项目设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/5.html" class="sidebar-item" aria-label="第5节 设计并写出优雅的Go语言项目"><!--[--><!--]--> 第5节 设计并写出优雅的Go语言项目 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/6.html" class="sidebar-item" aria-label="第6节 API 风格设计"><!--[--><!--]--> 第6节 API 风格设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/7.html" class="sidebar-item" aria-label="第7节 高质量的Makefile"><!--[--><!--]--> 第7节 高质量的Makefile <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/8.html" class="sidebar-item" aria-label="第8节 IAM 项目如何进行研发流程管理"><!--[--><!--]--> 第8节 IAM 项目如何进行研发流程管理 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/9.html" class="sidebar-item" aria-label="第9节 静态代码检测"><!--[--><!--]--> 第9节 静态代码检测 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/10.html" class="sidebar-item" aria-label="第10节 如何生成 Swagger API 文档"><!--[--><!--]--> 第10节 如何生成 Swagger API 文档 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/11.html" class="sidebar-item" aria-label="第11节 设计一套科学的错误码"><!--[--><!--]--> 第11节 设计一套科学的错误码 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/12.html" class="sidebar-item" aria-label="第12节 记录和设计日志"><!--[--><!--]--> 第12节 记录和设计日志 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/13.html" class="sidebar-item" aria-label="第13节  从 0 编写一个日志包"><!--[--><!--]--> 第13节  从 0 编写一个日志包 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="第14节 Pflag、Viper、Cobra 核心功能介绍"><!--[--><!--]--> 第14节 Pflag、Viper、Cobra 核心功能介绍 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/iam/projects/14.html#如何构建应用框架" class="router-link-active router-link-exact-active sidebar-item" aria-label="如何构建应用框架"><!--[--><!--]--> 如何构建应用框架 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#命令行参数解析工具-pflag-使用介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="命令行参数解析工具：Pflag 使用介绍"><!--[--><!--]--> 命令行参数解析工具：Pflag 使用介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#配置解析神器-viper-使用介绍" class="router-link-active router-link-exact-active sidebar-item" aria-label="配置解析神器：Viper 使用介绍"><!--[--><!--]--> 配置解析神器：Viper 使用介绍 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#现代化的命令行框架-cobra-全解" class="router-link-active router-link-exact-active sidebar-item" aria-label="现代化的命令行框架：Cobra 全解"><!--[--><!--]--> 现代化的命令行框架：Cobra 全解 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#prerun-and-postrun-hooks" class="router-link-active router-link-exact-active sidebar-item" aria-label="PreRun and PostRun Hooks"><!--[--><!--]--> PreRun and PostRun Hooks <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/iam/projects/14.html#end-链接" class="router-link-active router-link-exact-active sidebar-item" aria-label="END 链接"><!--[--><!--]--> END 链接 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/iam/projects/15.html" class="sidebar-item" aria-label="第15节 如何构建一个优秀的企业应用框架"><!--[--><!--]--> 第15节 如何构建一个优秀的企业应用框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/16.html" class="sidebar-item" aria-label="第16节 Gin 框架"><!--[--><!--]--> 第16节 Gin 框架 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/17.html" class="sidebar-item" aria-label="第17节 认证机制：应用程序如何进行访问认证？"><!--[--><!--]--> 第17节 认证机制：应用程序如何进行访问认证？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/18.html" class="sidebar-item" aria-label="第18节 IAM 项目认证"><!--[--><!--]--> 第18节 IAM 项目认证 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/19.html" class="sidebar-item" aria-label="第19节 权限模型：5大权限模型是如何进行资源授权的？"><!--[--><!--]--> 第19节 权限模型：5大权限模型是如何进行资源授权的？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/20.html" class="sidebar-item" aria-label="第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建"><!--[--><!--]--> 第20节 控制流（上）：通过iam-apiserver设计，看Web服务的构建 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/21.html" class="sidebar-item" aria-label="第21节 控制流（下）：iam-apiserver服务核心功能实现讲解"><!--[--><!--]--> 第21节 控制流（下）：iam-apiserver服务核心功能实现讲解 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/22.html" class="sidebar-item" aria-label="第22节 ORM：CURD 神器 GORM 包介绍及实战"><!--[--><!--]--> 第22节 ORM：CURD 神器 GORM 包介绍及实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/23.html" class="sidebar-item" aria-label="第23节 数据流：通过iam-authz-server设计，看数据流服务的设计"><!--[--><!--]--> 第23节 数据流：通过iam-authz-server设计，看数据流服务的设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/24.html" class="sidebar-item" aria-label="第24节 数据处理：如何高效处理应用程序产生的数据？"><!--[--><!--]--> 第24节 数据处理：如何高效处理应用程序产生的数据？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/25.html" class="sidebar-item" aria-label="第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？"><!--[--><!--]--> 第25节  SDK 设计（上）：如何设计出一个优秀的 Go SDK？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/26.html" class="sidebar-item" aria-label="第26节  SDK 设计（下）：IAM项目Go SDK设计和实现"><!--[--><!--]--> 第26节  SDK 设计（下）：IAM项目Go SDK设计和实现 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/27.html" class="sidebar-item" aria-label="第27节 效率神器：如何设计和实现一个命令行客户端工具？"><!--[--><!--]--> 第27节 效率神器：如何设计和实现一个命令行客户端工具？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/28.html" class="sidebar-item" aria-label="第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？"><!--[--><!--]--> 第28节 代码测试（上）：如何编写 Go 语言单元测试和性能测试用例？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/29.html" class="sidebar-item" aria-label="第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍"><!--[--><!--]--> 第29节 代码测试（下）：Go 语言其他测试类型及 IAM 测试介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/30.html" class="sidebar-item" aria-label="第30节 性能分析（上）：如何分析 Go 语言代码的性能？"><!--[--><!--]--> 第30节 性能分析（上）：如何分析 Go 语言代码的性能？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/31.html" class="sidebar-item" aria-label="第31节 性能分析（下）：API Server性能测试和调优实战"><!--[--><!--]--> 第31节 性能分析（下）：API Server性能测试和调优实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/32.html" class="sidebar-item" aria-label="第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍"><!--[--><!--]--> 第32节 软件部署实战（上）：部署方案及负载均衡、高可用组件介绍 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/33.html" class="sidebar-item" aria-label="第33节 软件部署实战（中）：IAM 系统生产环境部署实战"><!--[--><!--]--> 第33节 软件部署实战（中）：IAM 系统生产环境部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/34.html" class="sidebar-item" aria-label="第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战"><!--[--><!--]--> 第34节 软件部署实战（下）：IAM系统安全加固、水平扩缩容实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/35.html" class="sidebar-item" aria-label="第35节 技术演进（上）：虚拟化技术演进之路"><!--[--><!--]--> 第35节 技术演进（上）：虚拟化技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/36.html" class="sidebar-item" aria-label="第36节 技术演进（下）：软件架构和应用生命周期技术演进之路"><!--[--><!--]--> 第36节 技术演进（下）：软件架构和应用生命周期技术演进之路 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/37.html" class="sidebar-item" aria-label="第37节 基于Kubernetes的云原生架构设计"><!--[--><!--]--> 第37节 基于Kubernetes的云原生架构设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/38.html" class="sidebar-item" aria-label="第38节 如何制作Docker镜像？"><!--[--><!--]--> 第38节 如何制作Docker镜像？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/39.html" class="sidebar-item" aria-label="第39节 如何编写Kubernetes资源定义文件？"><!--[--><!--]--> 第39节 如何编写Kubernetes资源定义文件？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/40.html" class="sidebar-item" aria-label="第40节 IAM 容器化部署实战"><!--[--><!--]--> 第40节 IAM 容器化部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/41.html" class="sidebar-item" aria-label="第41节 服务编排（上）：Helm服务编排基础知识"><!--[--><!--]--> 第41节 服务编排（上）：Helm服务编排基础知识 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/42.html" class="sidebar-item" aria-label="第42节 服务编排（下）：基于Helm的服务编排部署实战"><!--[--><!--]--> 第42节 服务编排（下）：基于Helm的服务编排部署实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/43.html" class="sidebar-item" aria-label="第43节 基于 GitHub Actions 的 CI 实战"><!--[--><!--]--> 第43节 基于 GitHub Actions 的 CI 实战 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/44.html" class="sidebar-item" aria-label="第44节 可直接套用的 Go 编码规范"><!--[--><!--]--> 第44节 可直接套用的 Go 编码规范 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/45.html" class="sidebar-item" aria-label="第45节 Go Modules依赖包管理全讲"><!--[--><!--]--> 第45节 Go Modules依赖包管理全讲 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/46.html" class="sidebar-item" aria-label="第46节 IAM排障指南"><!--[--><!--]--> 第46节 IAM排障指南 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/47.html" class="sidebar-item" aria-label="第47节"><!--[--><!--]--> 第47节 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/48.html" class="sidebar-item" aria-label="第48节 分布式系统设计"><!--[--><!--]--> 第48节 分布式系统设计 <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/49.html" class="sidebar-item" aria-label="第49节 如何从小白进阶成 Go 语言专家？"><!--[--><!--]--> 第49节 如何从小白进阶成 Go 语言专家？ <!--[--><!--]--></a><!----></li><li><a href="/iam/projects/50.html" class="sidebar-item" aria-label="第50节"><!--[--><!--]--> 第50节 <!--[--><!--]--></a><!----></li><li><a class="external-link sidebar-item" href="https://nsddd.top/archives/contributors" rel="noopener noreferrer" target="_blank" aria-label="💝如何参与贡献？"><!--[--><!--]--> 💝如何参与贡献？ <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><ul><li><a href="https://github.com/cubxxw/iam" target="_blank" rel="noopener noreferrer">🔥 开源地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h1 id="第14节-pflag、viper、cobra-核心功能介绍" tabindex="-1"><a class="header-anchor" href="#第14节-pflag、viper、cobra-核心功能介绍" aria-hidden="true">#</a> 第14节 Pflag、Viper、Cobra 核心功能介绍</h1><br><div><a href="13.md" style="float:left;">⬆️上一节🔗 </a><a href="15.md" style="float:right;"> ⬇️下一节🔗</a></div><br><blockquote><p>❤️💕💕During the winter vacation, I followed up and learned two projects: tiktok project and IAM project, and summarized and practiced the CloudNative project and Go language. I learned a lot in the process.Myblog:<a href="http://nsddd.top/" target="_blank" rel="noopener noreferrer">http://nsddd.top<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><nav class="table-of-contents"><ul><li><a aria-current="page" href="/iam/projects/14.html#如何构建应用框架" class="router-link-active router-link-exact-active">如何构建应用框架</a></li><li><a aria-current="page" href="/iam/projects/14.html#命令行参数解析工具-pflag-使用介绍" class="router-link-active router-link-exact-active">命令行参数解析工具：Pflag 使用介绍</a><ul><li><a aria-current="page" href="/iam/projects/14.html#pflag-包-flag-定义" class="router-link-active router-link-exact-active">Pflag 包 Flag 定义</a></li><li><a aria-current="page" href="/iam/projects/14.html#pflag-包-flagset-定义" class="router-link-active router-link-exact-active">Pflag 包 FlagSet 定义</a></li><li><a aria-current="page" href="/iam/projects/14.html#pflag-使用方法" class="router-link-active router-link-exact-active">Pflag 使用方法</a></li></ul></li><li><a aria-current="page" href="/iam/projects/14.html#配置解析神器-viper-使用介绍" class="router-link-active router-link-exact-active">配置解析神器：Viper 使用介绍</a><ul><li><a aria-current="page" href="/iam/projects/14.html#读入配置" class="router-link-active router-link-exact-active">读入配置</a></li><li><a aria-current="page" href="/iam/projects/14.html#读取配置" class="router-link-active router-link-exact-active">读取配置</a></li></ul></li><li><a aria-current="page" href="/iam/projects/14.html#现代化的命令行框架-cobra-全解" class="router-link-active router-link-exact-active">现代化的命令行框架：Cobra 全解</a><ul><li><a aria-current="page" href="/iam/projects/14.html#使用-cobra-库创建命令" class="router-link-active router-link-exact-active">使用 Cobra 库创建命令</a></li><li><a aria-current="page" href="/iam/projects/14.html#使用标志-1" class="router-link-active router-link-exact-active">使用标志</a></li><li><a aria-current="page" href="/iam/projects/14.html#非选项参数验证" class="router-link-active router-link-exact-active">非选项参数验证</a></li></ul></li><li><a aria-current="page" href="/iam/projects/14.html#prerun-and-postrun-hooks" class="router-link-active router-link-exact-active">PreRun and PostRun Hooks</a></li><li><a aria-current="page" href="/iam/projects/14.html#总结" class="router-link-active router-link-exact-active">总结</a></li><li><a aria-current="page" href="/iam/projects/14.html#end-链接" class="router-link-active router-link-exact-active">END 链接</a></li></ul></nav><p>[TOC]</p><h2 id="如何构建应用框架" tabindex="-1"><a class="header-anchor" href="#如何构建应用框架" aria-hidden="true">#</a> 如何构建应用框架</h2><p>想知道如何构建应用框架，首先你要明白，一个应用框架包含哪些部分。在我看来，一个应用框架需要包含以下 3 个部分：</p><ul><li><p><strong>命令行参数解析</strong>：主要用来解析命令行参数，这些命令行参数可以影响命令的运行效果。</p></li><li><p><strong>配置文件解析</strong>：一个大型应用，通常具有很多参数，为了便于管理和配置这些参数，通常会将这些参数放在一个配置文件中，供程序读取并解析。</p></li><li><p><strong>应用的命令行框架</strong>：应用最终是通过命令来启动的。这里有 3 个需求点，</p><ul><li><p>一是命令需要具备 Help 功能，这样才能告诉使用者如何去使用；</p></li><li><p>二是命令需要能够解析命令行参数和配置文件；</p></li><li><p>三是命令需要能够初始化业务代码，并最终启动业务进程。</p><p>也就是说，我们的命令需要具备框架的能力，来纳管这 3 个部分。</p></li></ul></li></ul><p>这 3 个部分的功能，你可以自己开发，也可以借助业界已有的成熟实现。跟之前的想法一样，我不建议你自己开发，更建议你采用业界已有的成熟实现。命令行参数可以通过 <a href="https://github.com/spf13/pflag" target="_blank" rel="noopener noreferrer">Pflag<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来解析，配置文件可以通过 <a href="https://github.com/spf13/viper" target="_blank" rel="noopener noreferrer">Viper<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来解析，应用的命令行框架则可以通过 <a href="https://github.com/spf13/cobra" target="_blank" rel="noopener noreferrer">Cobra<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 来实现。这 3 个包目前也是最受欢迎的包，并且这 3 个包不是割裂的，而是有联系的，我们可以有机地组合这 3 个包，从而实现一个非常强大、优秀的应用命令行框架。</p><p>接下来，我们就来详细看下，这 3 个包在 Go 项目开发中是如何使用的。</p><h2 id="命令行参数解析工具-pflag-使用介绍" tabindex="-1"><a class="header-anchor" href="#命令行参数解析工具-pflag-使用介绍" aria-hidden="true">#</a> 命令行参数解析工具：Pflag 使用介绍</h2><p>Go 服务开发中，经常需要给开发的组件加上各种启动参数来配置服务进程，影响服务的行为。像 kube-apiserver 就有多达 200 多个启动参数，而且这些参数的类型各不相同（例如：string、int、ip 类型等），使用方式也不相同（例如：需要支持<code>--</code>长选项，<code>-</code>短选项等），所以我们需要一个强大的命令行参数解析工具。</p><p>虽然 Go 源码中提供了一个标准库 <code>Flag</code> 包，用来对命令行参数进行解析，但在大型项目中应用更广泛的是另外一个包：<code>Pflag</code>。<code>Pflag</code> 提供了很多强大的特性，非常适合用来构建大型项目，一些耳熟能详的开源项目都是用 Pflag 来进行命令行参数解析的，例如：Kubernetes、Istio、Helm、Docker、Etcd 等。</p><p>接下来，我们就来介绍下如何使用 Pflag。Pflag 主要是通过创建 Flag 和 FlagSet 来使用的。我们先来看下 Flag。</p><h3 id="pflag-包-flag-定义" tabindex="-1"><a class="header-anchor" href="#pflag-包-flag-定义" aria-hidden="true">#</a> Pflag 包 Flag 定义</h3><p>Pflag 可以对命令行参数进行处理，一个命令行参数在 Pflag 包中会解析为一个 Flag 类型的变量。Flag 是一个结构体，定义如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Name                <span class="token builtin">string</span> <span class="token comment">// flag长选项的名称</span>
    Shorthand           <span class="token builtin">string</span> <span class="token comment">// flag短选项的名称，一个缩写的字符</span>
    Usage               <span class="token builtin">string</span> <span class="token comment">// flag的使用文本</span>
    Value               Value  <span class="token comment">// flag的值</span>
    DefValue            <span class="token builtin">string</span> <span class="token comment">// flag的默认值</span>
    Changed             <span class="token builtin">bool</span> <span class="token comment">// 记录flag的值是否有被设置过</span>
    NoOptDefVal         <span class="token builtin">string</span> <span class="token comment">// 当flag出现在命令行，但是没有指定选项值时的默认值</span>
    Deprecated          <span class="token builtin">string</span> <span class="token comment">// 记录该flag是否被放弃</span>
    Hidden              <span class="token builtin">bool</span> <span class="token comment">// 如果值为true，则从help/usage输出信息中隐藏该flag</span>
    ShorthandDeprecated <span class="token builtin">string</span> <span class="token comment">// 如果flag的短选项被废弃，当使用flag的短选项时打印该信息</span>
    Annotations         <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// 给flag设置注解</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Flag 的值是一个 Value 类型的接口，Value 定义如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Value <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// 将flag类型的值转换为string类型的值，并返回string的内容</span>
    <span class="token function">Set</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token comment">// 将string类型的值转换为flag类型的值，转换失败报错</span>
    <span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// 返回flag的类型，例如：string、int、ip等</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过将 Flag 的值抽象成一个 interface 接口，我们就可以自定义 Flag 的类型了。只要实现了 Value 接口的结构体，就是一个新类型。</p><h3 id="pflag-包-flagset-定义" tabindex="-1"><a class="header-anchor" href="#pflag-包-flagset-定义" aria-hidden="true">#</a> Pflag 包 FlagSet 定义</h3><p>Pflag 除了支持单个的 Flag 之外，还支持 FlagSet。FlagSet 是一些预先定义好的 Flag 的集合，几乎所有的 Pflag 操作，都需要借助 FlagSet 提供的方法来完成。在实际开发中，我们可以使用两种方法来获取并使用 FlagSet：</p><ul><li>方法一，调用 NewFlagSet 创建一个 FlagSet。</li><li>方法二，使用 Pflag 包定义的全局 FlagSet：<code>CommandLine</code>。实际上 CommandLine 也是由 NewFlagSet 函数创建的。</li></ul><p><strong>先来看下第一种方法，自定义 FlagSet。下面是一个自定义 FlagSet 的示例：</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> version <span class="token builtin">bool</span>
flagSet <span class="token operator">:=</span> pflag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span>ContinueOnError<span class="token punctuation">)</span>
flagSet<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version<span class="token punctuation">,</span> <span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Print version information and quit.&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以通过定义一个新的 FlagSet 来定义命令及其子命令的 Flag。</p><p><strong>再来看下第二种方法，使用全局 FlagSet。下面是一个使用全局 FlagSet 的示例：</strong></p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;github.com/spf13/pflag&quot;</span>
<span class="token punctuation">)</span>

pflag<span class="token punctuation">.</span><span class="token function">BoolVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>version<span class="token punctuation">,</span> <span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Print version information and quit.&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><code>FlagSet</code>可以使用<code>pflag.NewFlagSet()</code>方法来创建。以下是一个使用<code>FlagSet</code>的简单示例：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;github.com/spf13/pflag&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fs <span class="token operator">:=</span> pflag<span class="token punctuation">.</span><span class="token function">NewFlagSet</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span>ExitOnError<span class="token punctuation">)</span>
	fs<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Your name&quot;</span><span class="token punctuation">)</span>
	fs<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;Your age&quot;</span><span class="token punctuation">)</span>
	fs<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;--name=Tom&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;--age=20&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	name<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fs<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
	age<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> fs<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Name: %s, Age: %d\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这个例子中，我们通过<code>pflag.NewFlagSet()</code>方法创建了一个名为<code>test</code>的<code>FlagSet</code>。然后，我们向这个<code>FlagSet</code>中添加了两个<code>Flag</code>：<code>name</code>和<code>age</code>。最后，我们通过<code>fs.Parse()</code>方法对命令行参数进行解析，并使用<code>fs.GetString()</code>和<code>fs.GetInt()</code>方法获取<code>name</code>和<code>age</code>的值，并输出到控制台上。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Name: Tom, Age: 20
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用<code>FlagSet</code>可以方便地将相关的<code>Flag</code>进行分组管理，并且避免了在全局作用域中定义过多的<code>Flag</code>。此外，通过使用<code>FlagSet</code>，还可以更加灵活地控制不同模块中的<code>Flag</code>，以满足不同模块的需求。</p><p><code>Parse()</code>方法是<code>pflag</code>库中的一个方法，用于解析命令行参数。它的作用是将命令行参数解析为<code>Flag</code>的值，并将这些值保存到<code>FlagSet</code>中，以便后续的使用。</p><p>在这个例子中，我们通过<code>fs.Parse()</code>方法对命令行参数进行解析，解析的参数是<code>[]string{&quot;--name=Tom&quot;, &quot;--age=20&quot;}</code>，即<code>name</code>的值为<code>Tom</code>，<code>age</code>的值为<code>20</code>。解析后，<code>name</code>和<code>age</code>的值被保存在<code>FlagSet</code>中，我们可以通过<code>fs.GetString()</code>和<code>fs.GetInt()</code>方法获取它们的值，并输出到控制台上。</p><p>使用<code>Parse()</code>方法可以方便地将命令行参数解析为<code>Flag</code>的值，并将这些值保存在<code>FlagSet</code>中，以便后续的使用。这样，我们就可以更加方便地在程序中获取命令行参数，并进行相应的处理。</p></blockquote><p>这其中，<code>pflag.BoolVarP</code> 函数定义如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">BoolVarP</span><span class="token punctuation">(</span>p <span class="token operator">*</span><span class="token builtin">bool</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> shorthand <span class="token builtin">string</span><span class="token punctuation">,</span> value <span class="token builtin">bool</span><span class="token punctuation">,</span> usage <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag <span class="token operator">:=</span> CommandLine<span class="token punctuation">.</span><span class="token function">VarPF</span><span class="token punctuation">(</span><span class="token function">newBoolValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> shorthand<span class="token punctuation">,</span> usage<span class="token punctuation">)</span>
    flag<span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到 <code>pflag.BoolVarP</code> 最终调用了 CommandLine，CommandLine 是一个包级别的变量，定义为：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// CommandLine is the default set of command-line flags, parsed from os.Args.var CommandLine = NewFlagSet(os.Args[0], ExitOnError)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在一些不需要定义子命令的命令行工具中，我们可以直接使用全局的 FlagSet，更加简单方便。</p><h3 id="pflag-使用方法" tabindex="-1"><a class="header-anchor" href="#pflag-使用方法" aria-hidden="true">#</a> Pflag 使用方法</h3><p>上面，我们介绍了使用 Pflag 包的两个核心结构体。接下来，我来详细介绍下 Pflag 的常见使用方法。Pflag 有很多强大的功能，我这里介绍 7 个常见的使用方法。</p><h4 id="支持多种命令行参数定义方式" tabindex="-1"><a class="header-anchor" href="#支持多种命令行参数定义方式" aria-hidden="true">#</a> 支持多种命令行参数定义方式</h4><p><strong>Pflag 支持以下 4 种命令行参数定义方式：</strong></p><ul><li>支持长选项、默认值和使用文本，并将标志的值存储在指针中。</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> name <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Input Your Name&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>支持长选项、短选项、默认值和使用文本，并将标志的值存储在指针中。</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> name <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Input Your Name&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>支持长选项、默认值和使用文本，并将标志的值绑定到变量。</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> name stringpflag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Input Your Name&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>支持长选项、短选项、默认值和使用文本，并将标志的值绑定到变量。</li></ul><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> name stringpflag<span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;colin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Input Your Name&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>上面的函数命名是有规则的：</strong></p><ul><li>函数名带<code>Var</code>说明是将标志的值绑定到变量，否则是将标志的值存储在指针中。</li><li>函数名带<code>P</code>说明支持短选项，否则不支持短选项。</li></ul><h4 id="使用get-type-获取参数的值" tabindex="-1"><a class="header-anchor" href="#使用get-type-获取参数的值" aria-hidden="true">#</a> 使用<code>Get&lt;Type&gt;</code>获取参数的值</h4><p>可以使用<code>Get&lt;Type&gt;</code>来获取标志的值，<code>&lt;Type&gt;</code>代表 Pflag 所支持的类型。例如：有一个 pflag.FlagSet，带有一个名为 flagname 的 int 类型的标志，可以使用<code>GetInt()</code>来获取 int 值。需要注意 flagname 必须存在且必须是 int，例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>i<span class="token punctuation">,</span> err <span class="token operator">:=</span> flagset<span class="token punctuation">.</span><span class="token function">GetInt</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="获取非选项参数" tabindex="-1"><a class="header-anchor" href="#获取非选项参数" aria-hidden="true">#</a> 获取非选项参数</h4><p>代码示例如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>

    <span class="token string">&quot;github.com/spf13/pflag&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    flagvar <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">&quot;help message for flagname&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;argument number is: %v\n&quot;</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;argument list is: %v\n&quot;</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;the first argument is: %v\n&quot;</span><span class="token punctuation">,</span> pflag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述代码，输出如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go run example1.go arg1 arg2argument number is: 2argument list is: <span class="token punctuation">[</span>arg1 arg2<span class="token punctuation">]</span>the first argument is: arg1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在定义完标志之后，可以调用<code>pflag.Parse()</code>来解析定义的标志。解析后，可通过<code>pflag.Args()</code>返回所有的非选项参数，通过<code>pflag.Arg(i)</code>返回第 i 个非选项参数。参数下标 0 到 <code>pflag.NArg() - 1</code>。</p><h4 id="指定了选项但是没有指定选项值时的默认值" tabindex="-1"><a class="header-anchor" href="#指定了选项但是没有指定选项值时的默认值" aria-hidden="true">#</a> 指定了选项但是没有指定选项值时的默认值</h4><p>创建一个 Flag 后，可以为这个 Flag 设置<code>pflag.NoOptDefVal</code>。如果一个 Flag 具有 NoOptDefVal，并且该 Flag 在命令行上没有设置这个 Flag 的值，则该标志将设置为 NoOptDefVal 指定的值。例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> ip <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">IntP</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span> <span class="token number">1234</span><span class="token punctuation">,</span> <span class="token string">&quot;help message&quot;</span><span class="token punctuation">)</span>pflag<span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;flagname&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>NoOptDefVal <span class="token operator">=</span> <span class="token string">&quot;4321&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>上面的代码会产生结果，具体你可以参照下表：</p><p><a href="https://static001.geekbang.org/resource/image/fe/3f/fe76a52906c35b49b890225d1f5fc93f.png?wh=1428x336" target="_blank" rel="noopener noreferrer"><img src="http://sm.nsddd.top/sm202302222038386.png" alt="img"><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="弃用标志或者标志的简写" tabindex="-1"><a class="header-anchor" href="#弃用标志或者标志的简写" aria-hidden="true">#</a> 弃用标志或者标志的简写</h4><p>Pflag 可以弃用标志或者标志的简写。弃用的标志或标志简写在帮助文本中会被隐藏，并在使用不推荐的标志或简写时打印正确的用法提示。例如，弃用名为 logmode 的标志，并告知用户应该使用哪个标志代替：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// deprecate a flag by specifying its name and a usage messagepflag.CommandLine.MarkDeprecated(&quot;logmode&quot;, &quot;please use --log-mode instead&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这样隐藏了帮助文本中的 logmode，并且当使用 logmode 时，打印了<code>Flag --logmode has been deprecated, please use --log-mode instead</code>。</p><h4 id="保留名为-port-的标志-但是弃用它的简写形式。" tabindex="-1"><a class="header-anchor" href="#保留名为-port-的标志-但是弃用它的简写形式。" aria-hidden="true">#</a> 保留名为 port 的标志，但是弃用它的简写形式。</h4><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>pflag<span class="token punctuation">.</span><span class="token function">IntVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>port<span class="token punctuation">,</span> <span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;P&quot;</span><span class="token punctuation">,</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token string">&quot;MySQL service host port.&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// deprecate a flag shorthand by specifying its flag name and a usage message</span>
pflag<span class="token punctuation">.</span>CommandLine<span class="token punctuation">.</span><span class="token function">MarkShorthandDeprecated</span><span class="token punctuation">(</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;please use --port only&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样隐藏了帮助文本中的简写 P，并且当使用简写 P 时，打印了<code>Flag shorthand -P has been deprecated, please use --port only</code>。usage message 在此处必不可少，并且不应为空。</p><h4 id="隐藏标志" tabindex="-1"><a class="header-anchor" href="#隐藏标志" aria-hidden="true">#</a> 隐藏标志</h4><p>可以将 Flag 标记为隐藏的，这意味着它仍将正常运行，但不会显示在 usage/help 文本中。例如：隐藏名为 secretFlag 的标志，只在内部使用，并且不希望它显示在帮助文本或者使用文本中。代码如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// hide a flag by specifying its namepflag.CommandLine.MarkHidden(&quot;secretFlag&quot;)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>至此，我们介绍了 Pflag 包的重要用法。接下来，我们再来看下如何解析配置文件。</p><h2 id="配置解析神器-viper-使用介绍" tabindex="-1"><a class="header-anchor" href="#配置解析神器-viper-使用介绍" aria-hidden="true">#</a> 配置解析神器：Viper 使用介绍</h2><p>几乎所有的后端服务，都需要一些配置项来配置我们的服务，一些小型的项目，配置不是很多，可以选择只通过命令行参数来传递配置。但是大型项目配置很多，通过命令行参数传递就变得很麻烦，不好维护。标准的解决方案是将这些配置信息保存在配置文件中，由程序启动时加载和解析。Go 生态中有很多包可以加载并解析配置文件，目前最受欢迎的是 Viper 包。</p><p><strong>Viper 是 Go 应用程序现代化的、完整的解决方案，能够处理不同格式的配置文件，让我们在构建现代应用程序时，不必担心配置文件格式。Viper 也能够满足我们对应用配置的各种需求。</strong></p><p><strong>Viper 可以从不同的位置读取配置，不同位置的配置具有不同的优先级，高优先级的配置会覆盖低优先级相同的配置，按优先级从高到低排列如下：</strong></p><ol><li>通过 viper.Set 函数显示设置的配置</li><li>命令行参数</li><li>环境变量</li><li>配置文件</li><li>Key/Value 存储</li><li>默认值</li></ol><p>这里需要注意，Viper 配置键不区分大小写。</p><p>Viper 有很多功能，最重要的两类功能是读入配置和读取配置，Viper 提供不同的方式来实现这两类功能。接下来，我们就来详细介绍下 Viper 如何读入配置和读取配置。</p><h3 id="读入配置" tabindex="-1"><a class="header-anchor" href="#读入配置" aria-hidden="true">#</a> 读入配置</h3><p><strong>读入配置，就是将配置读入到 Viper 中，有如下读入方式：</strong></p><ul><li>设置默认的配置文件名。</li><li>读取配置文件。</li><li>监听和重新读取配置文件。</li><li>从 <code>io.Reader</code> 读取配置。</li><li>从环境变量读取。</li><li>从命令行标志读取。</li><li>从远程 <code>Key/Value</code> 存储读取。</li></ul><p>这几个方法的具体读入方式，你可以看下面的展示。</p><h4 id="设置默认" tabindex="-1"><a class="header-anchor" href="#设置默认" aria-hidden="true">#</a> 设置默认</h4><p>一个好的配置系统应该支持默认值。Viper 支持对 key 设置默认值，当没有通过配置文件、环境变量、远程配置或命令行标志设置 key 时，设置默认值通常是很有用的，可以让程序在没有明确指定配置时也能够正常运行。例如：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;ContentDir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;LayoutDir&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;layouts&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;Taxonomies&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;tag&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;tags&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;category&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;categories&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="读取配置文件" tabindex="-1"><a class="header-anchor" href="#读取配置文件" aria-hidden="true">#</a> 读取配置文件</h4><p>Viper 可以读取配置文件来解析配置，支持 JSON、TOML、YAML、YML、Properties、Props、Prop、HCL、Dotenv、Env 格式的配置文件。Viper 支持搜索多个路径，并且默认不配置任何搜索路径，将默认决策留给应用程序。</p><p>以下是如何使用 Viper 搜索和读取配置文件的示例：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;fmt&quot;</span>

  <span class="token string">&quot;github.com/spf13/pflag&quot;</span>
  <span class="token string">&quot;github.com/spf13/viper&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
  cfg  <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Configuration file.&quot;</span><span class="token punctuation">)</span>
  help <span class="token operator">=</span> pflag<span class="token punctuation">.</span><span class="token function">BoolP</span><span class="token punctuation">(</span><span class="token string">&quot;help&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;h&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;Show this help message.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pflag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token operator">*</span>help <span class="token punctuation">{</span>
    pflag<span class="token punctuation">.</span><span class="token function">Usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从配置文件中读取配置</span>
  <span class="token keyword">if</span> <span class="token operator">*</span>cfg <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token operator">*</span>cfg<span class="token punctuation">)</span>   <span class="token comment">// 指定配置文件名</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">&quot;yaml&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件名中没有文件扩展名，则需要指定配置文件的格式，告诉viper以何种格式解析文件</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span>          <span class="token comment">// 把当前目录加入到配置文件的搜索路径中</span>
    viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">&quot;$HOME/.iam&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件搜索路径，可以设置多个配置文件搜索路径</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">&quot;config&quot;</span><span class="token punctuation">)</span>     <span class="token comment">// 配置文件名称（没有文件扩展名）</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// 读取配置文件。如果指定了配置文件名，则使用指定的配置文件，否则在注册的搜索路径中搜索</span>
    <span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Fatal error config file: %s \n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Used configuration file is: %s\n&quot;</span><span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">ConfigFileUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Viper 支持设置多个配置文件搜索路径，需要注意添加搜索路径的顺序，Viper 会根据添加的路径顺序搜索配置文件，如果找到则停止搜索。如果调用 SetConfigFile 直接指定了配置文件名，并且配置文件名没有文件扩展名时，需要显式指定配置文件的格式，以使 Viper 能够正确解析配置文件。</p><p>如果通过搜索的方式查找配置文件，则需要注意，SetConfigName 设置的配置文件名是不带扩展名的，在搜索时 Viper 会在文件名之后追加文件扩展名，并尝试搜索所有支持的扩展类型。</p><h4 id="监听和重新读取配置文件。" tabindex="-1"><a class="header-anchor" href="#监听和重新读取配置文件。" aria-hidden="true">#</a> 监听和重新读取配置文件。</h4><p>**Viper 支持在运行时让应用程序实时读取配置文件，也就是热加载配置。**可以通过 WatchConfig 函数热加载配置。在调用 WatchConfig 函数之前，需要确保已经添加了配置文件的搜索路径。另外，还可以为 Viper 提供一个回调函数，以便在每次发生更改时运行。这里我也给你个示例：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 配置文件发生变更之后会调用的回调函数</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Config file changed:&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>不建议在实际开发中使用热加载功能</strong>，因为即使配置热加载了，程序中的代码也不一定会热加载。例如：修改了服务监听端口，但是服务没有重启，这时候服务还是监听在老的端口上，会造成不一致。</p><h4 id="设置配置值" tabindex="-1"><a class="header-anchor" href="#设置配置值" aria-hidden="true">#</a> 设置配置值</h4><p>我们可以通过 viper.Set() 函数来显式设置配置：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>viper.Set(&quot;user.username&quot;, &quot;colin&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="使用环境变量" tabindex="-1"><a class="header-anchor" href="#使用环境变量" aria-hidden="true">#</a> 使用环境变量</h4><p>Viper 还支持环境变量，通过如下 5 个函数来支持环境变量：</p><ul><li><code>AutomaticEnv()</code></li><li><code>BindEnv(input …string) error</code></li><li><code>SetEnvPrefix(in string)</code></li><li><code>SetEnvKeyReplacer(r *strings.Replacer)</code></li><li><code>AllowEmptyEnv(allowEmptyEnv bool)</code></li></ul><p>这里要注意：Viper 读取环境变量是区分大小写的。Viper 提供了一种机制来确保 Env 变量是唯一的。通过使用 SetEnvPrefix，可以告诉 Viper 在读取环境变量时使用前缀。BindEnv 和 AutomaticEnv 都将使用此前缀。比如，我们设置了 <code>viper.SetEnvPrefix(“VIPER”)</code>，当使用 <code>viper.Get(“apiversion”)</code> 时，实际读取的环境变量是<code>VIPER_APIVERSION</code>。</p><p>BindEnv 需要一个或两个参数。第一个参数是键名，第二个是环境变量的名称，环境变量的名称区分大小写。如果未提供 Env 变量名，则 Viper 将假定 Env 变量名为：<code>环境变量前缀_键名全大写</code>。例如：前缀为 VIPER，key 为 username，则 Env 变量名为<code>VIPER_USERNAME</code>。当显示提供 Env 变量名（第二个参数）时，它不会自动添加前缀。例如，如果第二个参数是 ID，Viper 将查找环境变量 ID。</p><p>在使用 Env 变量时，需要注意的一件重要事情是：每次访问该值时都将读取它。Viper 在调用 BindEnv 时不固定该值。</p><p>还有一个魔法函数 SetEnvKeyReplacer，SetEnvKeyReplacer 允许你使用 strings.Replacer 对象来重写 Env 键。如果你想在 Get() 调用中使用<code>-</code>或者<code>.</code>，但希望你的环境变量使用<code>*</code>分隔符，可以通过 SetEnvKeyReplacer 来实现。比如，我们设置了环境变量<code>USER_SECRET_KEY=bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb</code>，但我们想用<code>viper.Get(&quot;user.secret-key&quot;)</code>，那我们就调用函数：<code>*</code></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>viper.SetEnvKeyReplacer(strings.NewReplacer(&quot;.&quot;, &quot;
&quot;, &quot;-&quot;, &quot;&quot;))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>上面的代码，在调用 viper.Get() 函数时，会用_替换<code>.</code>和<code>-</code>。默认情况下，空环境变量被认为是未设置的，并将返回到下一个配置源。若要将空环境变量视为已设置，可以使用 AllowEmptyEnv 方法。使用环境变量示例如下：</p></blockquote><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token comment">// 使用环境变量</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">&quot;VIPER_USER_SECRET_ID&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;QLdywI2MrmDVjSSv6e95weNRvmteRjfKAuNV&quot;</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span><span class="token function">Setenv</span><span class="token punctuation">(</span><span class="token string">&quot;VIPER_USER_SECRET_KEY&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bVix2WBv0VPfrDrvlLWrhEdzjLpPCNYb&quot;</span><span class="token punctuation">)</span>

viper<span class="token punctuation">.</span><span class="token function">AutomaticEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                             <span class="token comment">// 读取环境变量</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvPrefix</span><span class="token punctuation">(</span><span class="token string">&quot;VIPER&quot;</span><span class="token punctuation">)</span>                                      <span class="token comment">// 设置环境变量前缀：VIPER_，如果是viper，将自动转变为大写。</span>
viper<span class="token punctuation">.</span><span class="token function">SetEnvKeyReplacer</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">NewReplacer</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 将viper.Get(key) key字符串中&#39;.&#39;和&#39;-&#39;替换为&#39;_&#39;</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">&quot;user.secret-key&quot;</span><span class="token punctuation">)</span>
viper<span class="token punctuation">.</span><span class="token function">BindEnv</span><span class="token punctuation">(</span><span class="token string">&quot;user.secret-id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USER_SECRET_ID&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 绑定环境变量名到key</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用标志" tabindex="-1"><a class="header-anchor" href="#使用标志" aria-hidden="true">#</a> 使用标志</h4><p>Viper 支持 Pflag 包，能够绑定 key 到 Flag。与 BindEnv 类似，在调用绑定方法时，不会设置该值，但在访问它时会设置。对于单个标志，可以调用 BindPFlag() 进行绑定：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>viper.BindPFlag(&quot;token&quot;, pflag.Lookup(&quot;token&quot;)) // 绑定单个标志
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>还可以绑定一组现有的 pflags（pflag.FlagSet）：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>viper.BindPFlags(pflag.CommandLine)             //绑定标志集
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="读取配置" tabindex="-1"><a class="header-anchor" href="#读取配置" aria-hidden="true">#</a> 读取配置</h3><p>Viper 提供了如下方法来读取配置：</p><ul><li><code>Get(key string) interface{}</code></li><li><code>Get&lt;Type&gt;(key string) &lt;Type&gt;</code></li><li><code>AllSettings() map[string]interface{}</code></li><li><code>IsSet(key string) : bool</code></li></ul><p>**每一个 Get 方法在找不到值的时候都会返回零值。**为了检查给定的键是否存在，可以使用 <code>IsSet()</code> 方法。<code>&lt;Type&gt;</code>可以是 Viper 支持的类型，首字母大写：Bool、Float64、Int、IntSlice、String、StringMap、StringMapString、StringSlice、Time、Duration。例如：GetInt()。</p><p>常见的读取配置方法有以下几种。</p><h4 id="访问嵌套的键" tabindex="-1"><a class="header-anchor" href="#访问嵌套的键" aria-hidden="true">#</a> 访问嵌套的键</h4><p>例如，加载下面的 JSON 文件：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>
<span class="token punctuation">{</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">5799</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;datastore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;metric&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">3099</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;warehouse&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;198.0.0.1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">2112</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Viper 可以通过传入<code>.</code>分隔的路径来访问嵌套字段：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>viper.GetString(&quot;datastore.metric.host&quot;) // (返回 &quot;127.0.0.1&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果<code>datastore.metric</code>被直接赋值覆盖（被 Flag、环境变量、set() 方法等等），那么<code>datastore.metric</code>的所有子键都将变为未定义状态，它们被高优先级配置级别覆盖了。</p><p><strong>如果存在与分隔的键路径匹配的键，则直接返回其值。例如：</strong></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;datastore.metric.host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">5799</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;datastore&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;metric&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">3099</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;warehouse&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;198.0.0.1&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">2112</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 <code>viper.GetString</code> 获取值：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">&quot;datastore.metric.host&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 返回 &quot;0.0.0.0&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="反序列化" tabindex="-1"><a class="header-anchor" href="#反序列化" aria-hidden="true">#</a> 反序列化</h4><p>Viper 可以支持将所有或特定的值解析到结构体、map 等。可以通过两个函数来实现：</p><ul><li><code>Unmarshal(rawVal interface{}) error</code></li><li><code>UnmarshalKey(key string, rawVal interface{}) error</code></li></ul><p>一个示例：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Port <span class="token builtin">int</span>
  Name <span class="token builtin">string</span>
  PathMap <span class="token builtin">string</span> <span class="token string">`mapstructure:&quot;path_map&quot;`</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to decode into struct, %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果想要解析那些键本身就包含<code>.</code>(默认的键分隔符）的配置，则需要修改分隔符：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
v <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">NewWithOptions</span><span class="token punctuation">(</span>viper<span class="token punctuation">.</span><span class="token function">KeyDelimiter</span><span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

v<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;chart::values&quot;</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
    <span class="token string">&quot;ingress&quot;</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
        <span class="token string">&quot;annotations&quot;</span><span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span>
            <span class="token string">&quot;traefik.frontend.rule.type&quot;</span><span class="token punctuation">:</span>                 <span class="token string">&quot;PathPrefix&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;traefik.ingress.kubernetes.io/ssl-redirect&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">type</span> config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Chart <span class="token keyword">struct</span><span class="token punctuation">{</span>
        Values <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> C config

v<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>C<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Viper 在后台使用<code>github.com/mitchellh/mapstructure</code>来解析值，其默认情况下使用<code>mapstructure tags</code>。当我们需要将 Viper 读取的配置反序列到我们定义的结构体变量中时，一定要使用 <code>mapstructure tags</code>。</p><h4 id="序列化成字符串" tabindex="-1"><a class="header-anchor" href="#序列化成字符串" aria-hidden="true">#</a> 序列化成字符串</h4><p>有时候我们需要将 Viper 中保存的所有设置序列化到一个字符串中，而不是将它们写入到一个文件中，示例如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    yaml <span class="token string">&quot;gopkg.in/yaml.v2&quot;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">yamlStringSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    c <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">AllSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    bs<span class="token punctuation">,</span> err <span class="token operator">:=</span> yaml<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;unable to marshal config to YAML: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>bs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="现代化的命令行框架-cobra-全解" tabindex="-1"><a class="header-anchor" href="#现代化的命令行框架-cobra-全解" aria-hidden="true">#</a> 现代化的命令行框架：Cobra 全解</h2><p>Cobra 既是一个可以创建强大的现代 CLI 应用程序的库，也是一个可以生成应用和命令文件的程序。有许多大型项目都是用 Cobra 来构建应用程序的，例如 Kubernetes、Docker、etcd、Rkt、Hugo 等。</p><p><strong>Cobra 建立在 commands、arguments 和 flags 结构之上</strong>。commands 代表命令，arguments 代表非选项参数，flags 代表选项参数（也叫标志）。一个好的应用程序应该是易懂的，用户可以清晰地知道如何去使用这个应用程序。应用程序通常遵循如下模式：<code>APPNAME VERB NOUN --ADJECTIVE</code>或者<code>APPNAME COMMAND ARG --FLAG</code>，例如：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">git</span> clone URL <span class="token parameter variable">--bare</span> 
<span class="token comment"># clone 是一个命令，URL是一个非选项参数，bare是一个选项参数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这里，VERB 代表动词，NOUN 代表名词，ADJECTIVE 代表形容词。</p><p>Cobra 提供了两种方式来创建命令：Cobra 命令和 Cobra 库。Cobra 命令可以生成一个 Cobra 命令模板，而命令模板也是通过引用 Cobra 库来构建命令的。所以，这里我直接介绍如何使用 Cobra 库来创建命令。</p><h3 id="使用-cobra-库创建命令" tabindex="-1"><a class="header-anchor" href="#使用-cobra-库创建命令" aria-hidden="true">#</a> 使用 Cobra 库创建命令</h3><p>如果要用 Cobra 库编码实现一个应用程序，需要首先创建一个空的 main.go 文件和一个 rootCmd 文件，之后可以根据需要添加其他命令。具体步骤如下：</p><h4 id="创建-rootcmd" tabindex="-1"><a class="header-anchor" href="#创建-rootcmd" aria-hidden="true">#</a> 创建 rootCmd</h4><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> newApp2 <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> newApp2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通常情况下，我们会将 rootCmd 放在文件 cmd/root.go 中。</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> rootCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
  Use<span class="token punctuation">:</span>   <span class="token string">&quot;hugo&quot;</span><span class="token punctuation">,</span>
  Short<span class="token punctuation">:</span> <span class="token string">&quot;Hugo is a very fast static site generator&quot;</span><span class="token punctuation">,</span>
  Long<span class="token punctuation">:</span> <span class="token string">`A Fast and Flexible Static Site Generator built with
                love by spf13 and friends in Go.
                Complete documentation is available at http://hugo.spf13.com`</span><span class="token punctuation">,</span>
  Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Do Stuff Here</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> err <span class="token operator">:=</span> rootCmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还可以在 <code>init()</code> 函数中 <strong>定义标志和处理配置</strong>，例如 <code>cmd/root.go</code>。</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>
<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;fmt&quot;</span>
  <span class="token string">&quot;os&quot;</span>

  homedir <span class="token string">&quot;github.com/mitchellh/go-homedir&quot;</span>
  <span class="token string">&quot;github.com/spf13/cobra&quot;</span>
  <span class="token string">&quot;github.com/spf13/viper&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    cfgFile     <span class="token builtin">string</span>
    projectBase <span class="token builtin">string</span>
    userLicense <span class="token builtin">string</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cobra<span class="token punctuation">.</span><span class="token function">OnInitialize</span><span class="token punctuation">(</span>initConfig<span class="token punctuation">)</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cfgFile<span class="token punctuation">,</span> <span class="token string">&quot;config&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;config file (default is $HOME/.cobra.yaml)&quot;</span><span class="token punctuation">)</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>projectBase<span class="token punctuation">,</span> <span class="token string">&quot;projectbase&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;base project directory eg. github.com/spf13/&quot;</span><span class="token punctuation">)</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringP</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YOUR NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Author name for copyright attribution&quot;</span><span class="token punctuation">)</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>userLicense<span class="token punctuation">,</span> <span class="token string">&quot;license&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;l&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Name of license for the project (can provide `licensetext` in config)&quot;</span><span class="token punctuation">)</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;viper&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Use Viper for configuration&quot;</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">&quot;projectbase&quot;</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;projectbase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">&quot;useViper&quot;</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;viper&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;NAME HERE &lt;EMAIL ADDRESS&gt;&quot;</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">&quot;license&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;apache&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Don&#39;t forget to read config either from cfgFile or from home directory!</span>
  <span class="token keyword">if</span> cfgFile <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use config file from the flag.</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span>cfgFile<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Find home directory.</span>
    home<span class="token punctuation">,</span> err <span class="token operator">:=</span> homedir<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Search config in home directory with name &quot;.cobra&quot; (without extension).</span>
    viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span>home<span class="token punctuation">)</span>
    viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">&quot;.cobra&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Can&#39;t read config:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建-main-go" tabindex="-1"><a class="header-anchor" href="#创建-main-go" aria-hidden="true">#</a> 创建 main.go</h4><p>我们还需要一个 main 函数来调用 rootCmd，通常我们会创建一个 main.go 文件，在 main.go 中调用 rootCmd.Execute() 来执行命令：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;{pathToYourApp}/cmd&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意，main.go 中不建议放很多代码，通常只需要调用 cmd.Execute() 即可。</p><h4 id="添加命令" tabindex="-1"><a class="header-anchor" href="#添加命令" aria-hidden="true">#</a> 添加命令</h4><p>除了 rootCmd，我们还可以调用 AddCommand 添加其他命令，通常情况下，我们会把其他命令的源码文件放在 cmd / 目录下，例如，我们添加一个 version 命令，可以创建 <code>cmd/version.go</code> 文件，内容为：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">package</span> cmd

<span class="token keyword">import</span> <span class="token punctuation">(</span>
  <span class="token string">&quot;fmt&quot;</span>

  <span class="token string">&quot;github.com/spf13/cobra&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>versionCmd<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> versionCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
  Use<span class="token punctuation">:</span>   <span class="token string">&quot;version&quot;</span><span class="token punctuation">,</span>
  Short<span class="token punctuation">:</span> <span class="token string">&quot;Print the version number of Hugo&quot;</span><span class="token punctuation">,</span>
  Long<span class="token punctuation">:</span>  <span class="token string">`All software has versions. This is Hugo&#39;s`</span><span class="token punctuation">,</span>
  Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hugo Static Site Generator v0.9 -- HEAD&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>本示例中，我们通过调用<code>rootCmd.AddCommand(versionCmd)</code>给 rootCmd 命令添加了一个 versionCmd 命令。</p><h4 id="编译并运行" tabindex="-1"><a class="header-anchor" href="#编译并运行" aria-hidden="true">#</a> 编译并运行</h4><p>将 main.go 中<code>{pathToYourApp}</code>替换为对应的路径，例如本示例中 <code>pathToYourApp</code> 为<code>github.com/marmotedu/gopractise-demo/cobra/newApp2</code>。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>$ go mod init github.com/marmotedu/gopractise-demo/cobra/newApp2
$ go build <span class="token parameter variable">-v</span> <span class="token builtin class-name">.</span>
$ ./newApp2 <span class="token parameter variable">-h</span>
A Fast and Flexible Static Site Generator built with
love by spf13 and friends <span class="token keyword">in</span> Go.
Complete documentation is available at http://hugo.spf13.com
 
Usage:
hugo <span class="token punctuation">[</span>flags<span class="token punctuation">]</span>
hugo <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
 
Available Commands:
<span class="token builtin class-name">help</span> Help about any <span class="token builtin class-name">command</span>
version Print the version number of Hugo
 
Flags:
-a, <span class="token parameter variable">--author</span> string Author name <span class="token keyword">for</span> copyright attribution <span class="token punctuation">(</span>default <span class="token string">&quot;YOUR NAME&quot;</span><span class="token punctuation">)</span>
<span class="token parameter variable">--config</span> string config <span class="token function">file</span> <span class="token punctuation">(</span>default is <span class="token environment constant">$HOME</span>/.cobra.yaml<span class="token punctuation">)</span>
-h, <span class="token parameter variable">--help</span> <span class="token builtin class-name">help</span> <span class="token keyword">for</span> hugo
-l, <span class="token parameter variable">--license</span> licensetext Name of license <span class="token keyword">for</span> the project <span class="token punctuation">(</span>can provide licensetext <span class="token keyword">in</span> config<span class="token punctuation">)</span>
-b, <span class="token parameter variable">--projectbase</span> string base project directory eg. github.com/spf13/
<span class="token parameter variable">--viper</span> Use Viper <span class="token keyword">for</span> configuration <span class="token punctuation">(</span>default <span class="token boolean">true</span><span class="token punctuation">)</span>
 
Use <span class="token string">&quot;hugo [command] --help&quot;</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a command.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过步骤一、步骤二、步骤三，我们就成功创建和添加了 Cobra 应用程序及其命令。</p><p>接下来，我再来详细介绍下 Cobra 的核心特性。</p><h3 id="使用标志-1" tabindex="-1"><a class="header-anchor" href="#使用标志-1" aria-hidden="true">#</a> 使用标志</h3><p>Cobra 可以跟 <code>Pflag</code> 结合使用，实现强大的标志功能。使用步骤如下：</p><h4 id="使用持久化的标志。" tabindex="-1"><a class="header-anchor" href="#使用持久化的标志。" aria-hidden="true">#</a> 使用持久化的标志。</h4><p>标志可以是 “持久的”，这意味着该标志可用于它所分配的命令以及该命令下的每个子命令。可以在 rootCmd 上定义持久标志：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Verbose<span class="token punctuation">,</span> <span class="token string">&quot;verbose&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;verbose output&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="使用本地标志" tabindex="-1"><a class="header-anchor" href="#使用本地标志" aria-hidden="true">#</a> 使用本地标志</h4><p>也可以分配一个本地标志，本地标志只能在它所绑定的命令上使用：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>rootCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Source<span class="token punctuation">,</span> <span class="token string">&quot;source&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Source directory to read from&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>--source</code>标志只能在 rootCmd 上引用，而不能在 rootCmd 的子命令上引用。</p><h4 id="将标志绑定到-viper" tabindex="-1"><a class="header-anchor" href="#将标志绑定到-viper" aria-hidden="true">#</a> 将标志绑定到 Viper</h4><p>我们可以将标志绑定到 Viper，这样就可以使用 <code>viper.Get()</code> 获取标志的值。</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> author <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>author<span class="token punctuation">,</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;YOUR NAME&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Author name for copyright attribution&quot;</span><span class="token punctuation">)</span>
  viper<span class="token punctuation">.</span><span class="token function">BindPFlag</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span> rootCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lookup</span><span class="token punctuation">(</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="设置标志为必选" tabindex="-1"><a class="header-anchor" href="#设置标志为必选" aria-hidden="true">#</a> 设置标志为必选</h4><p>默认情况下，标志是可选的，我们也可以设置标志为必选，当设置标志为必选，但是没有提供标志时，Cobra 会报错。</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code>rootCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Region<span class="token punctuation">,</span> <span class="token string">&quot;region&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;AWS region (required)&quot;</span><span class="token punctuation">)</span>
rootCmd<span class="token punctuation">.</span><span class="token function">MarkFlagRequired</span><span class="token punctuation">(</span><span class="token string">&quot;region&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="非选项参数验证" tabindex="-1"><a class="header-anchor" href="#非选项参数验证" aria-hidden="true">#</a> 非选项参数验证</h3><p>在命令的过程中，经常会传入非选项参数，并且需要对这些非选项参数进行验证，Cobra 提供了机制来对非选项参数进行验证。可以使用 Command 的 Args 字段来验证非选项参数。Cobra 也内置了一些验证函数：</p><ul><li>NoArgs：如果存在任何非选项参数，该命令将报错。</li><li>ArbitraryArgs：该命令将接受任何非选项参数。</li><li>OnlyValidArgs：如果有任何非选项参数不在 Command 的 ValidArgs 字段中，该命令将报错。</li><li>MinimumNArgs(int)：如果没有至少 N 个非选项参数，该命令将报错。</li><li>MaximumNArgs(int)：如果有多于 N 个非选项参数，该命令将报错。</li><li>ExactArgs(int)：如果非选项参数个数不为 N，该命令将报错。</li><li>ExactValidArgs(int)：如果非选项参数的个数不为 N，或者非选项参数不在 Command 的 ValidArgs 字段中，该命令将报错。</li><li>RangeArgs(min, max)：如果非选项参数的个数不在 min 和 max 之间，该命令将报错。</li></ul><p>使用预定义验证函数，示例如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> cmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
  Short<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>
  Args<span class="token punctuation">:</span> cobra<span class="token punctuation">.</span><span class="token function">MinimumNArgs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 使用内置的验证函数</span>
  Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, World!&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当然你也可以自定义验证函数，示例如下：</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> cmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>
  Short<span class="token punctuation">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// Args: cobra.MinimumNArgs(10), // 使用内置的验证函数</span>
  Args<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义验证函数</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;requires at least one arg&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> myapp<span class="token punctuation">.</span><span class="token function">IsValidColor</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;invalid color specified: %s&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, World!&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="prerun-and-postrun-hooks" tabindex="-1"><a class="header-anchor" href="#prerun-and-postrun-hooks" aria-hidden="true">#</a> PreRun and PostRun Hooks</h2><p>在运行 Run 函数时，我们可以运行一些钩子函数，比如 <code>PersistentPreRun</code> 和 <code>PreRun</code> 函数在 <code>Run</code> 函数之前执行，<code>PersistentPostRun</code> 和 <code>PostRun</code> 在 <code>Run</code> 函数之后执行。如果子命令没有指定<code>Persistent*Run</code>函数，则子命令将会继承父命令的<code>Persistent*Run</code>函数。这些函数的运行顺序如下：</p><ol><li>PersistentPreRun</li><li>PreRun</li><li>Run</li><li>PostRun</li><li>PersistentPostRun</li></ol><p>注意，父级的 PreRun 只会在父级命令运行时调用，子命令是不会调用的。</p><p>Cobra 还支持很多其他有用的特性，比如：自定义 Help 命令；可以自动添加<code>--version</code>标志，输出程序版本信息；当用户提供无效标志或无效命令时，Cobra 可以打印出 usage 信息；当我们输入的命令有误时，Cobra 会根据注册的命令，推算出可能的命令，等等。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>在开发 Go 项目时，我们可以通过 Pflag 来解析命令行参数，通过 Viper 来解析配置文件，用 Cobra 来实现命令行框架。你可以通过 pflag.String()、 pflag.StringP()、pflag.StringVar()、pflag.StringVarP() 方法来设置命令行参数，并使用 <code>Get&lt;Type&gt;</code>来获取参数的值。</p><p>同时，你也可以使用 Viper 从命令行参数、环境变量、配置文件等位置读取配置项。最常用的是从配置文件中读取，可以通过 viper.AddConfigPath 来设置配置文件搜索路径，通过 viper.SetConfigFile 和 viper.SetConfigType 来设置配置文件名，通过 viper.ReadInConfig 来读取配置文件。读取完配置文件，然后在程序中使用 <code>Get/Get&lt;Type&gt;</code>来读取配置项的值。</p><p>最后，你可以使用 Cobra 来构建一个命令行框架，<strong>Cobra 可以很好地集成 Pflag 和 Viper。</strong></p><h2 id="end-链接" tabindex="-1"><a class="header-anchor" href="#end-链接" aria-hidden="true">#</a> END 链接</h2><ul><li><div><a href="13.md" style="float:left;">⬆️上一节🔗 </a><a href="15.md" style="float:right;"> ️下一节🔗</a></div></li></ul><ul><li><p><a href="/iam/" class="">Ⓜ️回到目录🏠</a></p></li><li><p><a href="https://nsddd.top/archives/contributors" target="_blank" rel="noopener noreferrer"><strong>🫵参与贡献💞❤️‍🔥💖</strong><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>)</p></li><li><p>✴️版权声明 © ：本书所有内容遵循<a href="http://zh.wikipedia.org/wiki/Wikipedia:CC-by-sa-3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="noopener noreferrer">CC-BY-SA 3.0协议（署名-相同方式共享）©<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/c-ub/docs/edit/master/docs/iam/projects/14.md" rel="noopener noreferrer" target="_blank" aria-label="在GitHub上贡献此页面"><!--[--><!--]--> 在GitHub上贡献此页面 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 3293172751nss@gmail.com">Xinwei Xiong</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/iam/projects/13.html" class="" aria-label="第13节  从 0 编写一个日志包"><!--[--><!--]--> 第13节  从 0 编写一个日志包 <!--[--><!--]--></a></span><span class="next"><a href="/iam/projects/15.html" class="" aria-label="第15节 如何构建一个优秀的企业应用框架"><!--[--><!--]--> 第15节 如何构建一个优秀的企业应用框架 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.293f0ed8.js" defer></script>
  </body>
</html>
